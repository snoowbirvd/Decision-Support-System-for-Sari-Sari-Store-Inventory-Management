<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <!-- Tabler Icons webfont -->
  <link rel="stylesheet" href="https://unpkg.com/@tabler/icons-webfont@latest/tabler-icons.min.css">
  <!-- Roboto font (2015 Material Design standard) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <title>StockMatePH - Smart Inventory for Sari-Sari Stores</title>
  <style>
    /* ===== Anaktoria Font (same as logo) ===== */
    @font-face {
      font-family: 'Anaktoria';
      src: url('fonts/anaktoria.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    /* ===== Theme variables - Neumorphism Design ===== */
    /* Soft UI with embossed/debossed elements for depth and tactility */
    :root{
      /* Heading font - Anaktoria (same as logo) */
      --font-heading: 'Anaktoria', 'Georgia', serif;
      /* Primary Backgrounds - Neumorphic soft gray */
      --bg:#E6E7EE;
      --bg-pure:#E6E7EE;
      --bg-card:#E6E7EE;
      
      /* Text Colors - Balanced contrast for readability */
      --text:#31344B;
      --text-secondary:#525480;
      --muted:#93959F;
      
      /* Action Color - Deep blue (Neumorphism standard) */
      --primary:#174F84;
      --primary-light:rgba(23,79,132,0.12);
      --primary-dark:#0E3A5F;
      
      /* Secondary Accent - Soft neutral for states */
      --accent-green:#8B9DC3;
      --accent-green-dark:#6B7AA1;
      
      /* Legacy mappings for compatibility */
      --brand-1:#174F84;
      --brand-2:#1A5C9A;
      --brand-3:#0E3A5F;
      --card:#E6E7EE;
      --chip:#E6E7EE;
      --chip-border:rgba(209,217,230,0.5);
      --chip-active:rgba(23,79,132,0.08);
      --chip-active-border:#174F84;
      --accent:#174F84;
      
      /* Neumorphic Dual Shadows - Light top-left, dark bottom-right */
      --shadow-light:rgba(255,255,255,0.8);
      --shadow-dark:rgba(174,174,192,0.4);
      --shadow-soft:3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
      --shadow-soft-sm:2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
      --shadow-soft-lg:6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
      --shadow-inset:inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
      --shadow-inset-sm:inset 1px 1px 2px var(--shadow-dark), inset -1px -1px 2px var(--shadow-light);
      
      /* Legacy shadow mappings */
      --shadow-2dp:var(--shadow-soft-sm);
      --shadow-4dp:var(--shadow-soft);
      --shadow-8dp:var(--shadow-soft-lg);
      --shadow:var(--shadow-soft-sm);
      --shadow-lg:var(--shadow-soft-lg);
      --ring:0 0 0 2px rgba(23,79,132,0.2);
      
      /* Status Colors - Soft retro white glow tones */
      --success:#8B9DC3;
      --warning:#A0AEC0;
      --danger:#718096;
      
      /* Border Radius - Soft, rounded */
      --radius-sm:6px;
      --radius:10px;
      --radius-lg:15px;
      
      /* Border for neumorphic elements */
      --border-light:1px solid rgba(209,217,230,0.5);
      
      /* Typography Scale (mobile-friendly, tighter) */
      --heading-xl:24px;
      --heading-lg:18px;
      --heading-md:15px;
      --body:13px;
      --caption:11.5px;
      --small:10px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      /* Retro system font stack for clean, readable UI */
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 0;
      line-height: 1.45;
      font-size: var(--body);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    body.cart-active { padding-bottom: 180px; }

    .app-shell {
      max-width: 440px;
      margin: 0 auto;
      background: var(--bg);
      min-height: 100vh;
    }

    .container { padding-bottom: 20px; }

    /* --- Sticky Header Wrapper (header + KPIs + tabs) --- */
    .sticky-header-wrapper {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg);
    }

    /* --- Header (Photo Background with Neumorphism Overlay) --- */
    .header {
      background: linear-gradient(rgba(23,79,132,0.82), rgba(14,58,95,0.90)), url('Photos/Store - Main Header.jpg');
      background-size: cover;
      background-position: center;
      color: white;
      padding: 16px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .header-text { display: flex; align-items: center; gap: 12px; }
    .header-logo { 
      height: 52px; 
      width: auto;
      display: block; 
      object-fit: contain;
      filter: brightness(0) invert(1);
    }
    .header-title {
      display: none;
    }
    .header-icon { display: none; }
    .header-logo-icon { height: 28px; width: 28px; object-fit: contain; }

    .header-date{
      text-align: right;
      font-size: 0.85rem;
      line-height: 1.3;
      font-family: var(--font-heading);
      text-transform: uppercase;
    }
    .header-date .weekday{ 
      color: rgba(255,255,255,0.95); 
      font-weight: 600;
      font-family: var(--font-heading);
      font-size: 0.9rem;
      text-transform: uppercase;
    }
    .header-date .monthday{ 
      color: rgba(255,255,255,0.8); 
      font-weight: 500;
      font-size: 0.78rem;
      font-family: var(--font-heading);
      text-transform: uppercase;
    }

    /* --- Stats Cards (Neumorphic Design) --- */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      padding: 8px 10px;
      background: var(--bg);
      margin-top: 0;
      position: relative;
      z-index: 10;
    }
    .stat-card {
      background: var(--bg-card);
      padding: 8px 4px;
      border-radius: var(--radius-sm);
      text-align: center;
      box-shadow: var(--shadow-soft-sm);
      border: var(--border-light);
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    .stat-card:hover {
      box-shadow: var(--shadow-soft);
      transform: translateY(-1px);
    }
    .stat-card:active {
      box-shadow: var(--shadow-inset-sm);
      transform: translateY(0);
    }
    .stat-card.alert { border-left: 2px solid var(--chip-border); }
    .stat-card.warning { border-left: 2px solid var(--chip-border); }
    .stat-card.success { border-left: 2px solid var(--chip-border); }
    .stat-card.info { border-left: 2px solid var(--chip-border); }
    .stat-value { font-size: 0.88em; font-weight: 600; color: var(--text); font-variant-numeric: tabular-nums; }
    .stat-value.text-danger { color: #E57373; }
    .stat-value.text-warning { color: #D4A934; }
    .stat-value.text-success { color: #48BB78; }
    .stat-label { font-size: 0.52em; color: var(--muted); margin-top: 1px; text-transform: uppercase; font-weight: 500; letter-spacing: 0.2px; }

    /* --- DSS Context Banner (Neumorphic) --- */
    .dss-context-banner {
      background: var(--bg);
      border-left: 3px solid var(--primary);
      border-radius: var(--radius);
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-soft-sm);
    }
    .dss-greeting {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }
    .dss-greeting span:first-child {
      font-weight: 600;
      font-size: 0.92em;
      color: var(--primary-dark);
    }
    .dss-summary {
      font-size: 0.75em;
      color: #5A7F9F;
      margin-top: 1px;
    }
    .dss-quick-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .dss-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.75);
      padding: 6px 8px;
      border-radius: 6px;
    }
    .dss-stat i {
      font-size: 1.1em;
      color: var(--primary);
    }
    .dss-stat-content {
      display: flex;
      flex-direction: column;
    }
    .dss-stat-label {
      font-size: 0.62em;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }
    .dss-stat-value {
      font-size: 0.88em;
      font-weight: 600;
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }

    /* --- Tabs (Neumorphic Navigation) --- */
    .tabs {
      display: flex;
      gap: 1px;
      background: var(--bg-card);
      padding: 4px 8px 8px 8px;
      margin: 0;
      border-radius: 0;
      flex-wrap: wrap;
      justify-content: center;
      box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light);
      border-top: var(--border-light);
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      flex: 1 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      padding: 6px 4px;
      background: var(--bg);
      border: var(--border-light);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      font-size: 9px;
      color: var(--muted);
      transition: all 0.2s ease;
      min-width: 36px;
      box-shadow: var(--shadow-soft-sm);
    }
    .tab-icon { 
      height: 16px; 
      width: 16px; 
      object-fit: contain; 
      display: block;
      opacity: 0.6;
      transition: opacity 0.15s ease;
    }
    .header-logo-icon { height: 28px; width: 28px; object-fit: contain; }
    .tab i { font-size: 1.2em; display: block; }
    .tab:hover { 
      background: var(--bg);
      color: var(--primary);
      box-shadow: var(--shadow-soft);
    }
    .tab:hover .tab-icon { opacity: 0.85; }
    .tab.active {
      background: var(--bg);
      color: var(--primary);
      box-shadow: var(--shadow-inset);
    }
    .tab.active .tab-icon {
      opacity: 1;
      filter: none;
    }

    /* --- Expiry & Decision Analysis Styles --- */
    .expiry-alerts-container { margin-bottom: 10px; }

    /* Section Dividers - Neumorphic professional style */
    .section-divider {
      padding: 10px 0;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(209,217,230,0.6);
    }
    .section-divider-text {
      font-size: clamp(0.78em, 2.4vw, 0.9em);
      font-weight: 800;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-family: var(--font-heading);
      line-height: 1.2;
      white-space: normal;
    }
    .section-divider-hint {
      font-size: 0.7em;
      color: var(--muted);
      margin-left: 8px;
      font-weight: 400;
    }
    .dashboard-section {
      margin-bottom: 12px;
    }
    .expiry-alert-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px 14px;
      border-radius: var(--radius);
      margin-bottom: 8px;
      background: var(--bg-card);
      border-left: 3px solid var(--chip-border);
      box-shadow: var(--shadow-soft-sm);
      border-right: var(--border-light);
      border-top: var(--border-light);
      border-bottom: var(--border-light);
    }
    .expiry-alert-item.alert-urgent {
      border-left-color: var(--chip-border);
    }
    .expiry-alert-item.alert-warning {
      border-left-color: var(--chip-border);
    }
    .expiry-alert-item .alert-icon {
      font-size: 1.1em;
      color: var(--text-secondary);
    }
    .expiry-alert-item .alert-content { flex: 1; }
    .expiry-alert-item .alert-product { font-weight: 600; font-size: 0.85em; color: var(--text); }
    .expiry-alert-item .alert-details { font-size: 0.75em; color: var(--muted); margin-top: 2px; }
    .expiry-alert-item .alert-action { font-size: 0.72em; font-weight: 500; margin-top: 3px; color: var(--text-secondary); }

    .priority-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.62em;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
      font-weight: 600;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }
    .priority-a { background: rgba(255,255,255,0.9); color: #4A5568; border: none; box-shadow: inset 1px 1px 2px rgba(174,174,192,0.3), inset -1px -1px 2px rgba(255,255,255,0.8); }
    .priority-b { background: rgba(255,255,255,0.7); color: #718096; border: none; box-shadow: inset 1px 1px 2px rgba(174,174,192,0.2), inset -1px -1px 2px rgba(255,255,255,0.6); }
    .priority-c { background: rgba(255,255,255,0.5); color: #A0AEC0; border: none; box-shadow: inset 1px 1px 2px rgba(174,174,192,0.15), inset -1px -1px 2px rgba(255,255,255,0.5); }

    /* Trend Arrows for Demand Forecasting */
    .trend-arrow {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      margin-left: 6px;
      font-weight: 800;
      width: 24px;
      height: 24px;
      border-radius: 50%;
    }
    .trend-up { color: #4A5568; background: rgba(255,255,255,0.9); box-shadow: 1px 1px 3px rgba(174,174,192,0.3), -1px -1px 3px rgba(255,255,255,0.8); } /* Increasing demand */
    .trend-stable { color: #718096; background: rgba(230,231,238,0.8); } /* Stable demand */
    .trend-down { color: #A0AEC0; background: rgba(255,255,255,0.6); box-shadow: 1px 1px 3px rgba(174,174,192,0.2), -1px -1px 3px rgba(255,255,255,0.6); } /* Decreasing demand */

    /* ===== CREDIT TAB: Compact Retro Design ===== */
    #credit {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      padding: 10px 0;
    }

    /* Credit Aging Colors (left border - muted) */
    .credit-card.credit-recent { border-left: 3px solid #A0AEC0; }
    .credit-card.credit-aging { border-left: 3px solid #718096; }
    .credit-card.credit-overdue { border-left: 3px solid #4A5568; }

    /* Age Badge - compact pill (muted colors) */
    .credit-age-badge {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      font-size: 0.65em;
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.15px;
    }
    .credit-age-badge i { font-size: 0.85em; }
    .credit-age-recent { background: rgba(255,255,255,0.9); color: #4A5568; box-shadow: 1px 1px 2px rgba(174,174,192,0.2), -1px -1px 2px rgba(255,255,255,0.8); }
    .credit-age-aging { background: rgba(255,255,255,0.7); color: #718096; }
    .credit-age-overdue { background: rgba(255,255,255,0.5); color: #A0AEC0; }

    /* Credit Summary - Neumorphic Header Row */
    .credit-summary-hero {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 12px 14px;
      margin-bottom: 10px;
      box-shadow: var(--shadow-soft);
      border: var(--border-light);
    }
    .credit-hero-icon { display: none; }
    .credit-hero-left { display: flex; flex-direction: column; }
    .credit-hero-amount {
      font-size: 1.35em;
      font-weight: 600;
      color: #4A5568;
      line-height: 1.15;
      font-variant-numeric: tabular-nums;
    }
    .credit-hero-label {
      font-size: 0.7em;
      color: var(--muted);
      font-weight: 500;
      margin-top: 1px;
    }
    .credit-hero-accounts {
      font-size: 0.75em;
      color: var(--muted);
      font-weight: 500;
      text-align: right;
    }

    /* Aging Legend - Single compact row */
    .credit-aging-legend {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      margin-bottom: 6px;
      background: var(--bg);
      border-radius: var(--radius-sm);
    }
    .aging-legend-title {
      font-weight: 600;
      font-size: 0.68em;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }
    .aging-legend-title i { display: none; }
    .aging-legend-items {
      display: flex;
      gap: 5px;
      flex: 1;
    }
    .aging-legend-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .aging-legend-item .credit-age-badge { font-size: 0.6em; padding: 2px 5px; }
    .aging-desc { font-size: 0.62em; color: var(--muted); white-space: nowrap; }

    /* Sort Controls - Inline compact */
    .credit-sort-controls {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 8px;
    }
    .sort-label {
      font-size: 0.68em;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }
    .sort-btn {
      padding: 5px 8px !important;
      font-size: 0.72em !important;
      border-radius: var(--radius-sm) !important;
      background: var(--bg) !important;
      border: none !important;
      color: var(--text-secondary) !important;
      font-weight: 500 !important;
    }
    .sort-btn.active {
      background: rgba(255,255,255,0.95) !important;
      color: #4A5568 !important;
      box-shadow: inset 2px 2px 4px rgba(174,174,192,0.3), inset -2px -2px 4px rgba(255,255,255,0.8) !important;
    }

    /* --- Credit Tab: Mobile tweaks --- */
    @media (max-width: 420px) {
      .credit-summary-hero { padding: 8px 10px; }
      .credit-hero-amount { font-size: 1.2em; }
      .aging-legend-title { display: none; }
      .aging-desc { display: none; }
      .sort-btn { padding: 4px 7px !important; font-size: 0.68em !important; }
    }

    /* Personal Withdrawal Tracking (Neumorphic - Warm Orange) */
    .withdrawal-section {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 16px;
      border: var(--border-light);
      box-shadow: var(--shadow-soft);
    }
    .withdrawal-hero {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(209,217,230,0.5);
      margin-bottom: 12px;
    }
    .withdrawal-hero-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #EDB97A 0%, #D49A5C 100%);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      color: white;
      box-shadow: 3px 3px 6px rgba(0,0,0,0.15), -2px -2px 5px rgba(255,255,255,0.3);
    }
    .withdrawal-hero-content {
      flex: 1;
    }
    .withdrawal-hero-label {
      font-size: 0.75em;
      color: #B5885A;
      font-weight: 600;
    }
    .withdrawal-hero-amount {
      font-size: 1.5em;
      font-weight: 600;
      color: #B5885A;
      line-height: 1.15;
      font-variant-numeric: tabular-nums;
    }
    
    .withdrawal-breakdown {
      background: var(--bg-card);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-2dp);
    }
    .breakdown-title {
      font-weight: 600;
      font-size: 0.82em;
      color: #B5885A;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .breakdown-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: #FDF8F4;
      border-radius: var(--radius-sm);
      border-left: 2px solid #EDB97A;
    }
    .breakdown-item-label {
      font-weight: 600;
      font-size: 0.82em;
      color: #8B6D4A;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .breakdown-item-value {
      font-weight: 600;
      font-size: 0.88em;
      color: #B5885A;
      font-variant-numeric: tabular-nums;
    }
    .breakdown-empty {
      text-align: center;
      color: #B5885A;
      font-size: 0.8em;
      padding: 12px;
    }
    
    .entity-reminder {
      display: flex;
      gap: 10px;
      padding: 12px;
      background: linear-gradient(135deg, #EDF5EE 0%, #DCE9DD 100%);
      border-radius: var(--radius-sm);
      border: none;
      box-shadow: var(--shadow-2dp);
    }
    .entity-icon {
      color: #5A8B5E;
      font-size: 1.2em;
    }
    .entity-content strong {
      color: #5A8B5E;
      font-size: 0.82em;
    }
    .entity-content p {
      color: #4A7A4E;
      font-size: 0.75em;
      margin-top: 4px;
      line-height: 1.45;
    }
    
    .withdrawal-card {
      background: #FDF8F4;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px;
      margin-bottom: 8px;
      box-shadow: var(--shadow-2dp);
    }
    .withdrawal-summary {
      background: linear-gradient(135deg, #F9F0E8 0%, #E8DDD4 100%);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-bottom: 12px;
      text-align: center;
    }
    .withdrawal-summary-value {
      font-size: 1.5em;
      font-weight: 600;
      color: #B5885A;
    }
    .withdrawal-summary-label {
      font-size: 0.78em;
      color: #C4A070;
    }

    /* Opportunity Loss Tracking (Compact Retro - Muted Red) */
    .opportunity-loss-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(230,231,238,0.8) 100%);
      border: none;
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-2dp);
    }
    .opportunity-loss-value {
      font-size: 1.4em;
      font-weight: 600;
      color: #4A5568;
    }
    .opportunity-loss-chart {
      margin-top: 12px;
      padding: 10px;
      background: var(--bg-card);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-2dp);
    }
    .opportunity-bar {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 6px 0;
    }
    .opportunity-bar:last-child {
      margin-bottom: 0;
    }
    .opportunity-bar-label {
      width: 100px;
      font-size: 0.75em;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #A04040;
    }
    .opportunity-bar-fill {
      flex: 1;
      height: 20px;
      background: linear-gradient(90deg, #E89090 0%, #C56060 100%);
      border-radius: var(--radius-sm);
      margin: 0 10px;
      min-width: 8px;
      box-shadow: 0 2px 4px rgba(165,64,64,0.2);
    }
    .opportunity-bar-value {
      font-size: 0.82em;
      font-weight: 600;
      color: #4A5568;
      min-width: 65px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    /* Capital Allocation Progress Bar (Compact Retro) */
    .capital-allocation {
      margin-top: 10px;
      padding: 10px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      border: none;
    }
    .capital-allocation-title {
      font-weight: 600;
      font-size: 0.72em;
      margin-bottom: 8px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .capital-allocation-title::before {
      content: '';
    }
    .capital-allocation-bar {
      display: flex;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background: var(--chip-border);
    }
    .capital-bar-a { background: #4A5568; }
    .capital-bar-b { background: #718096; }
    .capital-bar-c { background: #A0AEC0; }
    .capital-allocation-legend {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      gap: 6px;
    }
    .capital-legend-item {
      flex: 1;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 4px;
      padding: 4px 6px;
      background: transparent;
      border-radius: var(--radius-sm);
      border: none;
    }
    .capital-legend-item span {
      font-size: 0.62em;
      font-weight: 500;
      text-align: left;
      color: var(--muted);
    }
    .capital-legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    /* Modal Styles (Neumorphic Design) */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s ease;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 20px;
      width: 90%;
      max-width: 380px;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px) scale(0.98);
      transition: transform 0.25s ease;
      box-shadow: var(--shadow-soft-lg);
      border: var(--border-light);
    }
    .modal-overlay.active .modal-content {
      transform: translateY(0) scale(1);
    }
    .modal-title {
      font-size: 1em;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: var(--muted);
    }

    .expiry-badge {
      display: inline-block;
      font-size: 0.7em;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
      font-weight: 600;
    }
    .expiry-urgent { background: rgba(255,255,255,0.9); color: #4A5568; box-shadow: 1px 1px 2px rgba(174,174,192,0.3), -1px -1px 2px rgba(255,255,255,0.8); }
    .expiry-warning { background: rgba(255,255,255,0.7); color: #718096; }
    .expiry-fresh { background: rgba(255,255,255,0.5); color: #A0AEC0; }

    /* --- Shopping List (Clear DSS) --- */
    .shopping-legend{
      background:#f8f9fa;
      border-radius:6px;
      padding:8px 10px;
      margin: 8px 0 10px;
      border: none;
      color: var(--text-secondary);
      font-size: .72em;
      line-height: 1.3;
    }
    .shopping-legend strong{ color: var(--text); }

    .shopping-list-item{
      margin-bottom: 6px;
      padding: 10px 12px;
      background: var(--bg-card);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-2dp);
      border-left: 3px solid var(--chip-border);
    }
    .shopping-list-item.urgency-high{ border-left-color: var(--chip-border); }
    .shopping-list-item.urgency-med{ border-left-color: var(--chip-border); }
    .shopping-list-item.urgency-low{ border-left-color: var(--chip-border); }

    .shopping-item-top{ display:flex; justify-content:space-between; align-items:flex-start; gap:6px; margin-bottom:4px; }
    .shopping-item-left{ display:flex; gap:6px; align-items:flex-start; min-width:0; }
    
    /* Category Item Thumbnails - Retro Soft Design */
    .item-thumb{
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--bg-pure);
      border: 1px solid var(--chip-border);
      flex: 0 0 auto;
      object-fit: contain;
      padding: 3px;
      box-shadow: var(--shadow-2dp);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .item-thumb:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-4dp);
    }
    
    /* Product Card Thumbnails (in inventory list) */
    .product-thumb {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--bg-pure);
      border: 1px solid var(--chip-border);
      object-fit: contain;
      padding: 4px;
      box-shadow: var(--shadow-2dp);
    }
    
    .shopping-item-title{
      min-width:0;
      font-size: 0.82em;
      font-weight: 600;
      color: var(--text);
      line-height: 1.2;
      word-break: break-word;
    }
    .shopping-item-sub{ font-size:.7em; color: var(--muted); margin-top:1px; }
    .shopping-item-tags{ display:flex; gap:5px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .impact-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size: .6em;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      border: none;
      letter-spacing: .1px;
      white-space: nowrap;
    }
    .impact-high{ background: rgba(255,255,255,0.9); color: #4A5568; box-shadow: 1px 1px 2px rgba(174,174,192,0.3), -1px -1px 2px rgba(255,255,255,0.8); }
    .impact-med{ background: rgba(255,255,255,0.7); color: #718096; }
    .impact-low{ background: rgba(255,255,255,0.5); color: #A0AEC0; }

    .trend-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size: .6em;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      border: none;
      white-space: nowrap;
    }
    .trend-badge.up{ background: rgba(255,255,255,0.9); color: #4A5568; box-shadow: 1px 1px 2px rgba(174,174,192,0.2), -1px -1px 2px rgba(255,255,255,0.8); }
    .trend-badge.stable{ background: var(--chip); color: var(--text-secondary); }
    .trend-badge.down{ background: rgba(255,255,255,0.6); color: #718096; }

    .restock-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      padding: 4px 6px;
      background: var(--bg);
      border-radius: 4px;
      border: none;
      margin-bottom: 4px;
    }
    .restock-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-weight:600;
      font-size: .7em;
      color: var(--text);
      white-space: nowrap;
    }
    .restock-detail{ color: var(--muted); font-size:.68em; text-align:right; }

    .shopping-qtybox{
      background: var(--bg);
      padding: 4px 8px;
      border-radius: 4px;
      border: none;
      display:flex;
      align-items: baseline;
      gap: 4px;
    }
    .shopping-qtybox .label{ font-size:.65em; color: var(--muted); font-weight:500; }
    .shopping-qtybox .qty{ font-size:0.95em; font-weight:700; color: var(--text); }
    .shopping-price{ text-align:right; }
    .shopping-price .total{ font-size: 0.85em; font-weight: 600; color: var(--text); }
    .shopping-price .unit{ font-size: .65em; color: var(--muted); }

    .shopping-reason{ font-size:.86em; color:#495057; display:flex; align-items:flex-start; gap:8px; }
    .shopping-reason i{ color:#6c757d; margin-top: 1px; }

    .allocation-note{
      margin-top: 8px;
      font-size: .72em;
      color: var(--text-secondary);
      background: var(--bg);
      border: none;
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      line-height: 1.4;
    }
    .allocation-note strong{ color: var(--text); }

    /* Decision Analysis Card */
    .decision-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .decision-card-title {
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .decision-form { display: flex; flex-direction: column; gap: 10px; }
    .decision-form .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .decision-form .form-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }
    .decision-result {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      border: 1px solid #e2e8f0;
    }
    .decision-result-header {
      font-weight: 700;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f1f5f9;
    }
    .decision-metric {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 0.9em;
    }
    .decision-metric-label { color: #64748b; }
    .decision-metric-value { font-weight: 600; }
    .decision-recommendation {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
    }
    .decision-recommendation.positive { background: rgba(255,255,255,0.9); color: #4A5568; box-shadow: 2px 2px 4px rgba(174,174,192,0.3), -2px -2px 4px rgba(255,255,255,0.8); }
    .decision-recommendation.caution { background: rgba(255,255,255,0.7); color: #718096; }
    .decision-recommendation.negative { background: rgba(255,255,255,0.5); color: #A0AEC0; }

    .payoff-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85em;
      margin-top: 10px;
    }
    .payoff-table th, .payoff-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    .payoff-table th {
      background: #f8fafc;
      font-weight: 600;
    }

    .markdown-analyzer {
      background: rgba(255,255,255,0.8);
      border: 1px solid rgba(209,217,230,0.5);
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
      box-shadow: 2px 2px 4px rgba(174,174,192,0.2), -2px -2px 4px rgba(255,255,255,0.8);
    }
    .markdown-analyzer-title {
      font-weight: 700;
      color: #4A5568;
      margin-bottom: 8px;
    }
    
    /* Historical Data Notices */
    .historical-data-notice {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(209,217,230,0.6);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.85em;
      color: #4A5568;
      margin-bottom: 12px;
      box-shadow: 2px 2px 4px rgba(174,174,192,0.2), -2px -2px 4px rgba(255,255,255,0.8);
    }
    .no-historical-data-notice {
      background: rgba(255,255,255,0.7);
      border: 1px solid rgba(209,217,230,0.5);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.85em;
      color: #718096;
      margin-bottom: 12px;
    }

    /* --- Content --- */
    .content { padding: 14px 12px; min-height: 400px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.25s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* --- Section headings and divider --- */
    .section-divider{
      height:1px; background:#e9ecef; border:0; width:100%; margin:12px 0 18px;
    }

    /* --- Quick Access (Compact Retro) --- */
    .quick-access-header {
      background: var(--bg-card);
      color: var(--text);
      padding: 10px 12px;
      border-radius: var(--radius) var(--radius) 0 0;
      font-weight: 500;
      font-size: 0.92em;
      border: none;
      box-shadow: var(--shadow-2dp);
      font-family: var(--font-heading);
      text-transform: uppercase;
    }
    .quick-access-header i { margin-right: 8px; color: var(--primary); }
    .quick-access-grid {
      background: var(--bg-card);
      padding: 10px;
      border-radius: 0 0 var(--radius) var(--radius);
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 6px;
      margin-bottom: 10px;
      border: none;
      box-shadow: var(--shadow-2dp);
      margin-top: -1px;
    }
    .quick-access-item {
      background: var(--bg);
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 8px;
      text-align: center;
      transition: background 0.12s ease;
      color: var(--text);
      box-shadow: none;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .quick-access-item:hover { background: var(--chip-active); }
    .quick-access-name { font-weight: 500; font-size: 0.82em; margin-bottom: 4px; color: var(--text); line-height: 1.3; }
    .quick-access-details { font-size: 0.7em; color: var(--muted); margin: 4px 0; }
    .quick-sell-btn {
      padding: 7px 10px;
      font-size: 9px;
      width: 100%;
      margin-top: 8px;
      background: var(--primary);
      border: none;
      color: white;
      border-radius: var(--radius-sm);
      font-weight: 500;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      box-shadow: var(--shadow-2dp);
      transition: box-shadow 0.15s ease;
    }
    .quick-sell-btn:hover {
        box-shadow: var(--shadow-4dp);
    }

    /* --- Inventory Controls (Compact Retro) --- */
    .inventory-controls {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 10px;
      margin-bottom: 10px;
      border: none;
      box-shadow: var(--shadow-2dp);
    }
    .search-row { display: flex; gap: 8px; align-items: center; }
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 34px;
      border: none;
      border-bottom: 1.5px solid #D2D8E0;
      border-radius: 0;
      font-size: 0.82em;
      color: var(--text);
      background: transparent url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="%23A0AEC0" viewBox="0 0 24 24"><path d="M10 2a8 8 0 1 1-5.292 13.894l-3.407 3.407a1 1 0 1 1-1.414-1.414l3.407-3.407A8 8 0 0 1 10 2zm0 2a6 6 0 1 0 0 12A6 6 0 0 0 10 4z"/></svg>') no-repeat 8px center;
      transition: border-color 0.2s ease;
    }
    .search-input:focus { 
      outline: none; 
      border-bottom-color: var(--primary); 
    }

    .category-filters {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    /* Filter Chips - Neumorphic Style with Image Icons */
    .filter-chip {
      padding: 6px 10px;
      border: var(--border-light);
      background: var(--bg);
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      font-size: 9px;
      color: var(--text-secondary);
      display: inline-flex; 
      align-items: center; 
      gap: 4px;
      box-shadow: var(--shadow-soft-sm);
    }
    .filter-chip i { font-size: 0.95em; }
    .filter-chip .filter-icon {
      width: 16px;
      height: 16px;
      object-fit: contain;
      opacity: 0.8;
      transition: opacity 0.15s ease, transform 0.15s ease;
    }
    .filter-chip:hover { 
      box-shadow: var(--shadow-soft); 
      color: var(--primary);
      transform: translateY(-2px);
    }
    .filter-chip:hover .filter-icon {
      opacity: 1;
      transform: scale(1.1);
    }
    .filter-chip.active { 
      background: var(--primary); 
      color: white; 
      border-color: var(--primary);
      box-shadow: var(--shadow-inset-sm);
    }
    .filter-chip.active .filter-icon {
      opacity: 1;
      filter: brightness(0) invert(1);
    }

    /* --- Category Divider (Neumorphic with Image Icons) --- */
    .category-divider {
      background: var(--bg-card);
      padding: 10px 14px;
      margin: 12px 0 10px;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.88em;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
      border: var(--border-light);
      box-shadow: var(--shadow-soft-sm);
    }
    .category-divider i { font-size: 1em; color: var(--primary); }
    .category-divider .category-icon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      object-fit: contain;
      background: var(--bg-pure);
      padding: 2px;
      border: 1px solid var(--chip-border);
      box-shadow: var(--shadow-2dp);
    }
    .category-count {
      margin-left: auto;
      background: var(--chip-active);
      padding: 3px 10px;
      border-radius: 10px;
      font-size: 0.72em;
      color: var(--primary);
      border: none;
      font-weight: 500;
    }

    /* --- Inventory Category (Collapsible like Quick Add) --- */
    .inventory-category {
      background: var(--bg-card);
      border-radius: var(--radius);
      margin: 10px 0;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      border: var(--border-light);
    }
    .inventory-category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      cursor: pointer;
      transition: background 0.12s ease;
      color: var(--text);
      font-weight: 500;
    }
    .inventory-category-header:hover { background: var(--chip-active); }
    .inventory-category-left {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.88em;
    }
    .inventory-category-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .inventory-category-chevron {
      transition: transform 0.15s ease;
      color: var(--muted);
      font-size: 0.9em;
    }
    .inventory-category-chevron.collapsed {
      transform: rotate(-90deg);
    }
    .inventory-category-items {
      padding: 0 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .inventory-category-items.collapsed {
      display: none;
    }

    /* --- Product List (Neumorphic Cards) --- */
    .product-list { display: flex; flex-direction: column; gap: 10px; }
    .product-item {
      background: var(--bg-card);
      border: var(--border-light);
      border-radius: var(--radius);
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
      color: var(--text);
      box-shadow: var(--shadow-soft);
    }
    .product-item:hover { 
      box-shadow: var(--shadow-soft-lg);
      transform: translateY(-2px);
    }
    .product-item:active {
      box-shadow: var(--shadow-inset-sm);
      transform: translateY(0);
    }
    .product-info { flex: 1; }
    .product-name { 
      font-weight: 500; 
      color: var(--text); 
      margin-bottom: 4px; 
      display:flex; 
      align-items:center; 
      gap:6px; 
      font-size: 0.88em; 
      line-height: 1.3;
    }
    .product-details { font-size: 0.72em; color: var(--muted); line-height: 1.4; }
    .product-prediction { font-size: 0.68em; color: var(--muted); margin-top: 4px; font-style: italic; }
    .product-actions { display: flex; gap: 6px; align-items: center; }
    .stock-count { 
      font-weight: 600; 
      color: var(--text); 
      min-width: 40px; 
      text-align: center; 
      background: var(--bg); 
      padding: 8px 12px; 
      border-radius: var(--radius-sm); 
      font-size: 0.82em;
      font-variant-numeric: tabular-nums;
      box-shadow: var(--shadow-inset-sm);
    }
    .btn-action {
      color: white;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      display: inline-flex; 
      align-items: center; 
      gap: 6px;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .btn-action:hover { box-shadow: var(--shadow-soft); transform: translateY(-1px); }
    .btn-action:active { box-shadow: var(--shadow-inset-sm); transform: translateY(0); }
    .btn-sell { background: var(--accent-green); border: none; box-shadow: 2px 2px 5px rgba(0,0,0,0.15), -1px -1px 3px rgba(255,255,255,0.2); color: white; }
    .btn-edit { background: var(--primary); border: none; box-shadow: 2px 2px 5px rgba(0,0,0,0.15), -1px -1px 3px rgba(255,255,255,0.1); }

    /* --- Floating Action Button (FAB) - Neumorphic Design --- */
    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      box-shadow: 4px 4px 10px rgba(0,0,0,0.2), -3px -3px 8px rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 1000;
    }
    .fab i {
      font-size: 22px;
      line-height: 1;
    }
    .fab:hover {
      transform: scale(1.05);
      box-shadow: 6px 6px 14px rgba(0,0,0,0.25), -4px -4px 10px rgba(255,255,255,0.15);
    }
    .fab:active {
      transform: scale(0.95);
      box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2), inset -2px -2px 5px rgba(255,255,255,0.05);
    }
    .fab.hidden { display: none; }
    /* FAB tooltip on hover */
    .fab::before {
      content: attr(data-tooltip);
      position: absolute;
      right: 54px;
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      font-size: 9px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
    }
    .fab:hover::before {
      opacity: 1;
    }

    /* --- Alert Box (Compact Retro) --- */
    .alert-box {
      background: #FDF6E9;
      border: 1px solid #E8D5B5;
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      margin-bottom: 10px;
      animation: slideIn 0.4s ease;
      color: #8B7355;
    }
    .alert-title { font-weight: 600; color: #8B7355; margin-bottom: 3px; display: flex; align-items: center; gap: 6px; font-size: 0.85em; }
    .alert-message { color: #6B5A48; font-size: 0.75em; line-height: 1.4; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-12px); } to { opacity: 1; transform: translateX(0); } }

    /* --- Add Product Form (Compact Retro) --- */
    .add-product-form { 
      background: var(--bg-card); 
      border-radius: var(--radius-sm); 
      padding: 14px; 
      margin-bottom: 12px; 
      box-shadow: var(--shadow-2dp);
      border: none;
    }
    .form-group { margin-bottom: 14px; position: relative; }
    .form-label { 
      display: block; 
      margin-bottom: 6px; 
      font-weight: 600; 
      color: var(--text-secondary); 
      font-size: 0.72em;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: var(--border-light);
      border-radius: var(--radius-sm);
      font-size: 0.85em;
      transition: all 0.2s ease;
      color: var(--text);
      background: var(--bg);
      box-shadow: var(--shadow-inset-sm);
    }
    .form-input:focus { 
      outline: none; 
      box-shadow: var(--shadow-inset), 0 0 0 2px rgba(23,79,132,0.15);
      border-color: var(--primary);
    }
    /* Remove animated underline - using neumorphic inset instead */
    .form-group::after {
      display: none;
    }
    .form-group:focus-within::after {
      display: none;
    }
    select.form-input {
      padding: 10px 12px;
      border: var(--border-light);
      cursor: pointer;
      background: var(--bg);
      box-shadow: var(--shadow-inset-sm);
    }
    /* --- Buttons (Neumorphic Design) --- */
    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      font-weight: 500;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex; 
      align-items: center; 
      gap: 6px;
      box-shadow: 3px 3px 6px rgba(0,0,0,0.2), -2px -2px 5px rgba(255,255,255,0.1);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .btn-primary:hover { 
      background: var(--primary-dark); 
      box-shadow: 4px 4px 8px rgba(0,0,0,0.25), -2px -2px 6px rgba(255,255,255,0.1);
      transform: translateY(-1px);
    }
    .btn-primary:active {
      box-shadow: inset 2px 2px 4px rgba(0,0,0,0.2), inset -1px -1px 3px rgba(255,255,255,0.1);
      transform: translateY(0);
    }
    
    /* Secondary: Neumorphic Ghost Button */
    .btn-secondary { 
      background: var(--bg); 
      color: var(--primary); 
      border: var(--border-light); 
      padding: 7px 12px; 
      border-radius: var(--radius-sm); 
      font-weight: 500; 
      font-size: 10px;
      cursor: pointer; 
      transition: all 0.2s ease; 
      display: inline-flex; 
      align-items: center; 
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      box-shadow: var(--shadow-soft-sm);
    }
    .btn-secondary:hover { 
      box-shadow: var(--shadow-soft);
      transform: translateY(-1px);
    }
    .btn-secondary:active {
      box-shadow: var(--shadow-inset-sm);
      transform: translateY(0);
    }
    
    /* Warning & Danger - Neumorphic */
    .btn-warning { 
      background: var(--warning); 
      color: var(--text); 
      border: none; 
      padding: 8px 14px; 
      border-radius: var(--radius-sm); 
      font-weight: 500; 
      cursor: pointer; 
      transition: all 0.2s ease; 
      display: inline-flex; 
      align-items: center; 
      gap: 6px; 
      box-shadow: 3px 3px 6px rgba(0,0,0,0.15), -2px -2px 5px rgba(255,255,255,0.3);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      font-size: 10px;
    }
    .btn-warning:hover { box-shadow: 4px 4px 8px rgba(0,0,0,0.2), -2px -2px 6px rgba(255,255,255,0.3); transform: translateY(-1px); }
    .btn-warning:active { box-shadow: var(--shadow-inset-sm); transform: translateY(0); }
    .btn-danger { 
      background: var(--danger); 
      color: white; 
      border: none; 
      padding: 8px 12px; 
      border-radius: var(--radius-sm); 
      font-weight: 500; 
      cursor: pointer; 
      box-shadow: 3px 3px 6px rgba(0,0,0,0.2), -2px -2px 5px rgba(255,255,255,0.1);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      font-size: 10px;
      transition: all 0.2s ease;
    }
    .btn-danger:hover { box-shadow: 4px 4px 8px rgba(0,0,0,0.25), -2px -2px 6px rgba(255,255,255,0.1); transform: translateY(-1px); }
    .btn-danger:active { box-shadow: inset 2px 2px 4px rgba(0,0,0,0.2); transform: translateY(0); }

    /* --- Category Quick Add (Neumorphic Design) --- */
    .category-section { 
      background: var(--bg-card); 
      border-radius: var(--radius); 
      margin-bottom: 10px; 
      overflow: hidden; 
      box-shadow: var(--shadow-soft);
      border: var(--border-light);
    }
    .category-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 12px 14px; 
      cursor: pointer; 
      transition: background 0.12s ease; 
      color: var(--text); 
      font-weight: 500; 
    }
    .category-header:hover { background: var(--chip-active); }
    .category-header span:first-child { font-weight: 500; font-size: 0.88em; display: flex; align-items: center; gap: 8px; }
    .category-preview { font-size: 0.7em; color: var(--muted); font-style: normal; }
    .category-items { padding: 0 14px 14px; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px; }
    .quick-item-btn { 
      background: var(--bg); 
      border: 1px solid #D2D8E0; 
      padding: 8px 10px; 
      border-radius: var(--radius-sm); 
      cursor: pointer; 
      transition: border-color 0.15s ease, background 0.12s ease; 
      font-size: 0.75em; 
      text-align: center; 
      color: var(--text); 
    }
    .quick-item-btn:hover { 
      background: var(--chip-active); 
      border-color: var(--primary); 
      color: var(--primary); 
    }

    /* --- Empty State (Compact Retro) --- */
    .empty-state { 
      text-align: center; 
      padding: 36px 20px; 
      color: var(--muted); 
    }
    .empty-state-icon { 
      font-size: 48px; 
      margin-bottom: 12px; 
      color: #C4CCD8;
    }

    /* --- Dashboard (Compact Retro Cards) --- */
    .dashboard-kpis { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 6px; 
      margin-bottom: 10px; 
    }
    .kpi-card { 
      background: var(--bg-card); 
      border-radius: var(--radius-sm); 
      padding: 8px 10px;
      border: none; 
      color: var(--text); 
      box-shadow: var(--shadow-2dp);
    }
    .kpi-card:hover {
      box-shadow: var(--shadow-4dp);
    }
    .kpi-title { 
      font-size: 0.62em; 
      color: var(--muted); 
      margin-bottom: 4px; 
      display: flex; 
      align-items: center; 
      gap: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }
    .kpi-title i { color: var(--primary); font-size: 1em; }
    .kpi-value { font-size: 0.95em; font-weight: 600; color: var(--text); font-variant-numeric: tabular-nums; }
    .kpi-change { font-size: 0.62em; margin-top: 3px; color: var(--muted); }
    
    /* Insight Cards - Compact retro */
    .insights-card { 
      background: var(--bg-card); 
      border: none; 
      border-radius: var(--radius-sm); 
      padding: 10px 12px; 
      margin-bottom: 6px; 
      color: var(--text); 
      box-shadow: var(--shadow-2dp);
    }
    .insight-title { 
      font-weight: 800; 
      color: var(--text); 
      margin-bottom: 6px; 
      display: flex; 
      align-items: center; 
      gap: 5px; 
      font-size: clamp(0.78em, 2.2vw, 0.9em);
      font-family: var(--font-heading);
      text-transform: uppercase;
      line-height: 1.2;
    }
    .insight-title i { color: var(--muted); font-size: 1.1em; }
    .insight-content { color: var(--text-secondary); font-size: 0.75em; line-height: 1.45; }
    #shoppingListSummary { font-size: 0.68em; margin-top: 8px; padding-top: 8px; border-top: 1px solid #D8E2EC; color: var(--muted); }


    /* --- Chart Styles (Compact Retro) --- */
    .chart-container { 
      background: var(--bg-card); 
      border-radius: var(--radius-sm); 
      padding: 10px 12px; 
      margin-bottom: 6px; 
      box-shadow: var(--shadow-2dp); 
      border: none; 
    }
    .chart-title { 
      font-weight: 600; 
      color: var(--text); 
      margin-bottom: 10px; 
      display: flex; 
      align-items: center; 
      gap: 5px; 
      font-size: 0.85em;
      font-family: var(--font-heading);
      text-transform: uppercase;
    }
    .chart-title i { color: var(--muted); }
    .bar-chart { 
      display: flex; 
      align-items: flex-end; 
      justify-content: space-between; 
      height: 80px; 
      margin-bottom: 6px; 
      padding: 6px 0; 
      border-left: 1px solid #D2D8E0; 
      border-bottom: 1px solid #D2D8E0; 
    }
    .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; margin: 0 3px; }
    .bar { 
      width: 100%; 
      background: var(--primary); 
      border-radius: 2px 2px 0 0; 
      transition: opacity 0.15s ease; 
      position: relative; 
    }
    .bar:hover { opacity: 0.85; }
    .bar-value { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 0.68em; font-weight: 500; color: var(--text); }
    .bar-label { font-size: 0.68em; color: var(--muted); margin-top: 6px; font-weight: 500; }

    /* --- Profit indicator & prediction badge --- */
    .profit-indicator { display: inline-block; padding: 4px 10px; border-radius: var(--radius-sm); font-size: var(--small); font-weight: 500; margin-left: 8px; }
    .profit-high { background: rgba(255,255,255,0.9); color: #4A5568; box-shadow: 1px 1px 2px rgba(174,174,192,0.2), -1px -1px 2px rgba(255,255,255,0.8); }
    .profit-medium { background: rgba(255,255,255,0.7); color: #718096; }
    .profit-low { background: rgba(255,255,255,0.5); color: #A0AEC0; }
    .prediction-badge { background: var(--primary-light); color: var(--primary); padding: 4px 10px; border-radius: var(--radius-sm); font-size: var(--small); font-weight: 500; margin-left: 8px; border: none; display: inline-flex; align-items: center; gap: 6px; }

    /* --- PWA Install (2015 Material Card) --- */
    .install-prompt { 
      display: none; 
      position: fixed; 
      bottom: 24px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: var(--bg-pure); 
      padding: 20px 24px; 
      border-radius: var(--radius); 
      box-shadow: var(--shadow-8dp); 
      z-index: 1000; 
      max-width: 90%; 
      text-align: center; 
      border: none; 
    }
    .install-prompt.show { display: block; animation: slideUp 0.35s ease; }
    @keyframes slideUp { from { opacity: 0; transform: translateX(-50%) translateY(80px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

    /* --- Sticky Cart Bar (Compact Retro) --- */
    .cart-bar {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 14px;
      width: calc(100% - 24px);
      max-width: 440px;
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-8dp);
      z-index: 1100;
      overflow: hidden;
    }
    .cart-hidden { display: none; }
    .cart-summary {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 16px;
      background: var(--primary);
      font-weight: 500;
      color: white;
      font-size: 0.88em;
    }
    .cart-summary .summary-left { display: flex; gap: 10px; align-items: center; }
    .cart-toggle { background: transparent; border: none; font-size: 18px; cursor: pointer; color: white; padding: 6px; }
    .cart-items { max-height: 280px; overflow: auto; padding: 14px; display: none; background: var(--bg-card); }
    .cart-items.show { display: block; }
    .cart-line { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; padding: 12px 0; border-bottom: 1px solid #E4E8ED; }
    .cart-line:last-child { border-bottom: none; }
    .cart-name { font-weight: 500; color: var(--text); font-size: 0.88em; }
    .cart-meta { color: var(--muted); font-size: 0.75em; margin-top: 3px; }
    .qty-controls { display: inline-flex; align-items: center; gap: 10px; }
    .qty-btn { width: 36px; height: 36px; border-radius: 50%; border: 1.5px solid var(--primary); background: transparent; font-weight: 500; cursor: pointer; font-size: 1em; color: var(--primary); transition: background 0.12s ease; }
    .qty-btn:hover { background: var(--primary-light); }
    .qty-btn:active { transform: scale(0.95); }
    .qty { min-width: 28px; text-align: center; font-weight: 600; font-size: 0.88em; color: var(--text); }
    .line-total { font-weight: 600; color: var(--primary); font-size: 0.88em; font-variant-numeric: tabular-nums; }
    .cart-actions { display: flex; gap: 10px; justify-content: flex-end; padding: 12px 16px; background: var(--bg); border-top: 1px solid #E4E8ED; }

    /* --- Credit Tab Typography (Compact Retro) --- */
    #credit {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-size: 13px;
      line-height: 1.5;
      letter-spacing: 0;
      text-rendering: optimizeLegibility;
    }
    #credit .credit-hero-amount,
    #credit .credit-total {
      font-variant-numeric: tabular-nums lining-nums;
      font-feature-settings: "tnum" 1, "lnum" 1;
    }

    /* --- Credit Card (Neumorphic) --- */
    .credit-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 12px 14px;
      margin-bottom: 8px;
      box-shadow: var(--shadow-soft);
      border: var(--border-light);
    }
    .credit-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 5px;
    }
    .credit-name {
      font-size: 0.88em;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 5px;
      flex-wrap: wrap;
    }
    .credit-total {
      font-size: 0.88em;
      font-weight: 600;
      color: #4A5568;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .credit-date {
      font-size: 0.68em;
      color: var(--muted);
      margin-bottom: 5px;
    }
    .credit-items-list {
      font-size: 0.78em;
      color: var(--text-secondary);
      line-height: 1.45;
      margin-bottom: 8px;
    }
    .credit-items-list span {
      color: var(--text);
      font-weight: 600;
    }
    .credit-actions { display: flex; justify-content: flex-end; }
    .credit-actions .btn-primary {
      padding: 5px 10px !important;
      font-size: 0.72em !important;
      border-radius: var(--radius-sm) !important;
    }

    /* --- Settings (Compact Retro) --- */
    .settings-section {
        background: var(--bg-card); 
        border-radius: var(--radius-sm); 
        padding: 16px;
        margin-bottom: 10px; 
        border: none; 
        box-shadow: var(--shadow-2dp);
    }
    .settings-title { font-weight: 500; color: var(--text); margin-bottom: 14px; font-size: 1em; font-family: var(--font-heading); text-transform: uppercase; }
    .setting-item {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        padding: 10px 0; 
        border-bottom: 1px solid #E4E8ED;
    }
    .setting-item:last-child { border-bottom: none; }
    .setting-label { font-weight: 500; color: var(--text); font-size: 0.85em; }
    .setting-value { color: var(--muted); font-weight: 400; font-size: 0.82em; }
    .setting-input { width: 70px; text-align: right; font-size: 0.85em; }

    /* --- Modal (Compact Retro Dialog) --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); z-index: 2000;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: opacity 0.2s ease;
    }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: var(--bg-card); 
      border-radius: var(--radius); 
      padding: 18px;
      width: calc(100% - 40px); 
      max-width: 380px;
      transform: translateY(16px); 
      transition: transform 0.2s ease;
      box-shadow: var(--shadow-8dp);
    }
    .modal-overlay.show .modal-content { transform: translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
    .modal-title { font-weight: 500; font-size: 1em; color: var(--text); }
    .modal-close { background: none; border: none; font-size: 1.3em; cursor: pointer; color: var(--muted); }
    .modal-close:hover { color: var(--text); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 18px; }
    
    /* --- History Log (Compact Retro) --- */
    .activity-log-list { display: flex; flex-direction: column; gap: 6px; }
    .log-item {
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--bg-card);
        padding: 12px;
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-2dp);
        border: none;
    }
    .log-icon {
        flex-shrink: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.85em;
    }
    .log-icon-sale { background: var(--accent-green); }
    .log-icon-add { background: var(--primary); }
    .log-icon-update { background: var(--warning); }
    .log-icon-credit_add { background: var(--danger); }
    .log-icon-credit_paid { background: #9F7AEA; }
    .log-message { flex-grow: 1; font-size: 0.82em; color: var(--text); line-height: 1.45; }
    .log-timestamp { font-size: 0.68em; color: var(--muted); margin-top: 3px; }


    /* Subtle tap feedback */
    .filter-chip, .quick-item-btn, .tab, .btn-action, .quick-sell-btn, .btn-primary, .btn-secondary, .btn-warning, .btn-danger, .fab {
      transition: transform 80ms ease;
      will-change: transform;
    }
    .tap-press { transform: scale(0.97); }

    /* Utility */
    #currentDateDisplay { display:none; }

    /* Tabler icon baseline tweak */
    .ti { line-height: 1; vertical-align: -0.1em; }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="container">
      <!-- Sticky Header Wrapper: header + KPIs + tabs -->
      <div class="sticky-header-wrapper">
        <div class="header">
          <div class="header-text">
            <img src="icons/store logo.png" alt="StockMatePH" class="header-logo">
          </div>

          <!-- Date/Time badge -->
          <div class="header-date" aria-label="Today">
            <div class="weekday" id="headerWeekday">Wednesday</div>
            <div class="monthday" id="headerMonthDay">August 20, 2026</div>
          </div>
        </div>

        <div class="stats-grid">
        <div class="stat-card warning" id="lowStockCard" onclick="switchTab(event,'insights')">
          <div class="stat-value text-warning" id="lowStockCount">0</div>
          <div class="stat-label">Low Stock</div>
        </div>
        <div class="stat-card info" onclick="switchTab(event,'settings')">
          <div class="stat-value">₱<span id="cashAvailable">0</span></div>
          <div class="stat-label">Cash Available</div>
        </div>
        <div class="stat-card success">
          <div class="stat-value text-success">₱<span id="todayProfit">0</span></div>
          <div class="stat-label">Today's Profit</div>
        </div>
        <div class="stat-card alert" onclick="switchTab(event,'insights')">
          <div class="stat-value">₱<span id="restockBudget">0</span></div>
          <div class="stat-label">Restock Need</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Main sections">
        <button class="tab active" onclick="switchTab(event,'inventory')" role="tab" aria-selected="true">
          <img src="icons/icons8-inventory-60.png" alt="Inventory" class="tab-icon">
          <span>Inventory</span>
        </button>
        <button class="tab" onclick="switchTab(event,'insights')" role="tab" aria-selected="false">
          <img src="icons/icons8-dashboard-96.png" alt="Planner" class="tab-icon">
          <span>Planner</span>
        </button>
        <button class="tab" onclick="switchTab(event,'history')" role="tab" aria-selected="false">
          <img src="icons/icons8-history-96.png" alt="History" class="tab-icon">
          <span>History</span>
        </button>
        <button class="tab" onclick="switchTab(event,'credit')" role="tab" aria-selected="false">
          <img src="icons/icons8-credit-96.png" alt="Credit" class="tab-icon">
          <span>Credit</span>
        </button>
        <button class="tab" onclick="switchTab(event,'add')" role="tab" aria-selected="false">
          <img src="icons/icons8-add-96.png" alt="Add" class="tab-icon">
          <span>Add</span>
        </button>
        <button class="tab" onclick="switchTab(event,'tools')" role="tab" aria-selected="false">
          <img src="icons/icons8-tools-100.png" alt="Tools" class="tab-icon">
          <span>Tools</span>
        </button>
        <button class="tab" onclick="switchTab(event,'settings')" role="tab" aria-selected="false">
          <img src="icons/icons8-settings-100.png" alt="Settings" class="tab-icon">
          <span>Settings</span>
        </button>
      </div>
      </div><!-- end sticky-header-wrapper -->

      <div class="content">
        <div id="inventory" class="tab-content active">
          <div id="alertsContainer" style="margin-bottom: 15px;"></div>

          <div class="inventory-controls">
            <div class="search-row" style="margin-bottom:10px;">
              <button id="startSaleBtn" class="btn-primary" onclick="startTransaction()" aria-label="Start new sale">
                <i class="ti ti-shopping-cart"></i> New Sale
              </button>
              <button id="manageInventoryBtn" class="btn-secondary" onclick="toggleManageMode()" aria-label="Manage inventory">
                <i class="ti ti-edit"></i> Manage
              </button>
              <button id="cancelSaleBtn" class="btn-secondary" onclick="cancelTransaction()" style="display:none;" aria-label="Cancel current sale">
                <i class="ti ti-x"></i> Cancel
              </button>
            </div>

            <div class="search-row">
              <input type="text" id="productSearch" class="search-input" placeholder="Search items…" onkeyup="searchProducts()" aria-label="Search products">
            </div>
            <div id="categoryFilters" class="category-filters" role="group" aria-label="Filter by category">
              <button class="filter-chip active" onclick="filterByCategory(event,'all')" aria-label="All categories" title="All"><i class="ti ti-filter"></i> All</button>
              <button class="filter-chip" onclick="filterByCategory(event,'beverages')" aria-label="Beverages" title="Beverages"><img src="icons_list of items/snacks.png" class="filter-icon" alt=""></button>
              <button class="filter-chip" onclick="filterByCategory(event,'noodles')" aria-label="Noodles" title="Noodles"><img src="icons_list of items/Noodles.png" class="filter-icon" alt=""></button>
              <button class="filter-chip" onclick="filterByCategory(event,'snacks')" aria-label="Snacks" title="Snacks"><img src="icons_list of items/snacks.png" class="filter-icon" alt=""></button>
              <button class="filter-chip" onclick="filterByCategory(event,'canned')" aria-label="Canned Goods" title="Canned Goods"><img src="icons_list of items/canned goods.png" class="filter-icon" alt=""></button>
              <button class="filter-chip" onclick="filterByCategory(event,'coffee')" aria-label="Coffee & Tea" title="Coffee & Tea"><img src="icons_list of items/coffee & tea.png" class="filter-icon" alt=""></button>
              <button class="filter-chip" onclick="filterByCategory(event,'dairy')" aria-label="Dairy & Eggs" title="Dairy & Eggs"><img src="icons_list of items/Dairy & Eggs.png" class="filter-icon" alt=""></button>
              <button class="filter-chip" onclick="filterByCategory(event,'condiments')" aria-label="Condiments" title="Condiments"><img src="icons_list of items/condiments.png" class="filter-icon" alt=""></button>
              <button class="filter-chip" onclick="filterByCategory(event,'personal')" aria-label="Personal Care" title="Personal Care"><img src="icons_list of items/personal care.png" class="filter-icon" alt=""></button>
              <button class="filter-chip" onclick="filterByCategory(event,'firstaid')" aria-label="First Aid" title="First Aid"><img src="icons_list of items/first aid.png" class="filter-icon" alt=""></button>
              <button class="filter-chip" onclick="filterByCategory(event,'household')" aria-label="Household" title="Household"><img src="icons_list of items/household.png" class="filter-icon" alt=""></button>
              <button class="filter-chip" onclick="filterByCategory(event,'candy')" aria-label="Candy & Sweets" title="Candy & Sweets"><img src="icons_list of items/candy & sweets.png" class="filter-icon" alt=""></button>
              <button class="filter-chip" onclick="filterByCategory(event,'cigarettes')" aria-label="Cigarettes" title="Cigarettes"><img src="icons_list of items/cigarettes.png" class="filter-icon" alt=""></button>
            </div>
          </div>

          <div id="productList" class="product-list">
            <div class="empty-state">
              <div class="empty-state-icon"><i class="ti ti-package"></i></div>
              <p>No products yet. Add your first item!</p>
            </div>
          </div>
        </div>

        <div id="insights" class="tab-content" aria-live="polite">
          
          <!-- ===== SECTION 1: RESTOCK SOON (Top Priority) ===== -->
          <div class="dashboard-section">
            <div id="lowStockAlertsSection" class="insights-card">
              <div class="insight-title"><i class="ti ti-alert-triangle"></i> Restock Soon</div>
              <div class="insight-content" id="lowStockAlertsList">All items are sufficiently stocked.</div>
            </div>
          </div>

          <!-- ===== SECTION 2: RESTOCKING PLAN (Prescriptive - What to buy) ===== -->
          <div class="dashboard-section">
            <div class="section-divider">
              <span class="section-divider-text">Recommended Buy List</span>
              <span class="section-divider-hint">Smart list for your next market run</span>
            </div>

            <div id="shoppingListContainer" class="insights-card">
              <div class="insight-content" id="shoppingList">Your smart shopping list will appear here.</div>
              <div id="shoppingListSummary"></div>
              <div id="shoppingListActions" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #D8E2EC;">
                <button class="btn-primary" onclick="addShoppingListToInventory()" style="width: 100%; padding: 12px; font-size: 0.85em;">
                  <i class="ti ti-package-import"></i> Add All to Inventory
                </button>
              </div>
            </div>
          </div>

          <!-- ===== SECTION 3: ACTION ITEMS ===== -->
          <div class="dashboard-section">

            <!-- Expiry Alerts -->
            <div id="expiryAlertsSection" class="expiry-alerts-container" style="display: none;">
              <div class="insight-title"><i class="ti ti-calendar-due"></i> Expiring Soon</div>
              <div id="expiryAlertsList"></div>
            </div>

            <!-- Credit Collections (at bottom) -->
            <div id="creditCollectionsSection" class="insights-card">
              <div class="insight-title"><i class="ti ti-notebook"></i> Collect Payments</div>
              <div class="insight-content" id="creditCollectionsList">No overdue credit accounts.</div>
            </div>
          </div>

          <!-- ===== SECTION 3: BUSINESS OVERVIEW (Descriptive - How is my store doing) ===== -->
          <div class="dashboard-section">
            <div class="section-divider">
              <span class="section-divider-text">Store Performance</span>
            </div>

            <!-- KPI Cards -->
            <div class="dashboard-kpis">
              <div class="kpi-card">
                <div class="kpi-title"><i class="ti ti-currency-peso"></i> Capital in Stock</div>
                <div class="kpi-value">₱<span id="inventoryValue">0</span></div>
                <div class="kpi-change" id="inventoryChange">total inventory value</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-title"><i class="ti ti-trophy"></i> Best Seller</div>
                <div class="kpi-value" id="mostProfitable">--</div>
                <div class="kpi-change" id="profitableAmount">₱0 profit</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-title"><i class="ti ti-calendar-stats"></i> Peak Day</div>
                <div class="kpi-value" id="busiestDay">--</div>
                <div class="kpi-change" id="busiestSales">0 sales</div>
              </div>
            </div>

            <!-- Sales Chart -->
            <div class="chart-container">
              <div class="chart-title"><i class="ti ti-chart-bar"></i> Weekly Performance</div>
              <div class="bar-chart" id="salesChart"></div>
              <div style="display: flex; justify-content: center; gap: 12px; margin-top: 6px;">
                <span style="font-size: 0.65em; color: var(--muted);"><span style="color: var(--primary);">■</span> Sales</span>
                <span style="font-size: 0.65em; color: var(--muted);"><span style="color: #718096;">■</span> Profit</span>
              </div>
            </div>

            <!-- Top Performers -->
            <div class="insights-card">
              <div class="insight-title"><i class="ti ti-trending-up"></i> Keep Stocking These</div>
              <div class="insight-content" id="topSelling">No sales data yet. Start selling to see insights!</div>
            </div>

            <!-- Slow Movers -->
            <div class="insights-card">
              <div class="insight-title"><i class="ti ti-hourglass-low"></i> Consider Reducing Stock</div>
              <div class="insight-content" id="slowMoving">Items not sold in 7+ days will appear here.</div>
            </div>
          </div>

          <!-- ===== SECTION 4: CAPITAL TRACKING (Descriptive - Money flows) ===== -->
          <div class="dashboard-section">
            <div class="section-divider">
              <span class="section-divider-text">Credit & Withdrawals</span>
            </div>

            <!-- Outstanding Credit Summary -->
            <div class="insights-card">
              <div class="insight-title"><i class="ti ti-notebook"></i> Outstanding Credit</div>
              <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                <div>
                  <div style="font-size: 1.05em; font-weight: 600; color: var(--text);">₱<span id="outstandingCredit">0</span></div>
                  <div style="font-size: 0.68em; color: var(--muted);"><span id="outstandingCreditCount">0</span> accounts</div>
                </div>
                <button class="btn-secondary" onclick="switchTab(event,'credit')" style="font-size: 0.7em; padding: 5px 10px;">
                  View <i class="ti ti-chevron-right"></i>
                </button>
              </div>
            </div>

            <!-- Personal Withdrawals -->
            <div class="insights-card">
              <div class="insight-title"><i class="ti ti-home-dollar"></i> Personal Withdrawals</div>
              <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                <div>
                  <div style="font-size: 1.05em; font-weight: 600; color: var(--text);">₱<span id="totalWithdrawalValue">0</span></div>
                  <div style="font-size: 0.68em; color: var(--muted);">This month</div>
                </div>
                <button class="btn-secondary" onclick="openWithdrawalModal()" style="font-size: 0.7em; padding: 5px 10px;">
                  <i class="ti ti-plus"></i> Log
                </button>
              </div>
              <div id="withdrawalsList" class="withdrawal-list" style="margin-top: 8px;"></div>
            </div>
          </div>

        </div>
        
        <div id="history" class="tab-content">
            <div id="activityLogList" class="activity-log-list">
                <!-- Activity log items will be rendered here -->
            </div>
        </div>

        <div id="credit" class="tab-content">
            <!-- Credit Summary - Compact Row -->
            <div class="credit-summary-hero">
              <div class="credit-hero-left">
                <div class="credit-hero-amount">₱<span id="totalCreditOutstanding">0</span></div>
                <div class="credit-hero-label">Total Outstanding</div>
              </div>
              <div class="credit-hero-accounts"><span id="creditAccountCount">0</span> accounts</div>
            </div>
            
            <!-- Aging Legend - Compact Inline -->
            <div class="credit-aging-legend">
              <div class="aging-legend-title">Status:</div>
              <div class="aging-legend-items">
                <div class="aging-legend-item">
                  <span class="credit-age-badge credit-age-recent">Recent</span>
                  <span class="aging-desc">&lt;7d</span>
                </div>
                <div class="aging-legend-item">
                  <span class="credit-age-badge credit-age-aging">Aging</span>
                  <span class="aging-desc">7-30d</span>
                </div>
                <div class="aging-legend-item">
                  <span class="credit-age-badge credit-age-overdue">Overdue</span>
                  <span class="aging-desc">&gt;30d</span>
                </div>
              </div>
            </div>
            
            <!-- Sort Toggle - Enhanced -->
            <div class="credit-sort-controls">
              <span class="sort-label">Sort by:</span>
              <button class="btn-secondary sort-btn active" onclick="sortCreditBy('date')" data-sort="date"><i class="ti ti-calendar"></i> Date</button>
              <button class="btn-secondary sort-btn" onclick="sortCreditBy('amount')" data-sort="amount"><i class="ti ti-currency-peso"></i> Amount</button>
              <button class="btn-secondary sort-btn" onclick="sortCreditBy('age')" data-sort="age"><i class="ti ti-clock"></i> Age</button>
            </div>
            
            <div id="creditList">
                <!-- Credit accounts will be rendered here -->
            </div>
        </div>

        <div id="add" class="tab-content">
          <div class="add-product-form">
            <div class="form-group">
              <label class="form-label">Category</label>
              <select id="productCategory" class="form-input">
                <option value="beverages">Beverages</option>
                <option value="noodles">Noodles</option>
                <option value="snacks">Snacks</option>
                <option value="canned">Canned Goods</option>
                <option value="coffee">Coffee & Tea</option>
                <option value="dairy">Dairy & Eggs</option>
                <option value="condiments">Condiments</option>
                <option value="personal">Personal Care</option>
                <option value="firstaid">First Aid</option>
                <option value="household">Household</option>
                <option value="candy">Candy & Sweets</option>
                <option value="cigarettes">Cigarettes</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Product Name</label>
              <input type="text" id="productName" class="form-input" placeholder="e.g., Coke 1.5L">
            </div>
            <div class="form-group">
              <label class="form-label">Cost Price (₱)</label>
              <input type="number" id="costPrice" class="form-input" placeholder="15" step="0.50" inputmode="decimal">
            </div>
            <div class="form-group">
              <label class="form-label">Selling Price (₱)</label>
              <input type="number" id="sellingPrice" class="form-input" placeholder="20" step="0.50" inputmode="decimal">
            </div>
            <div class="form-group">
              <label class="form-label">Initial Stock</label>
              <input type="number" id="initialStock" class="form-input" placeholder="10" min="0" inputmode="numeric">
            </div>
            <div class="form-group">
              <label class="form-label">Expiry Date (Optional)</label>
              <input type="date" id="expiryDate" class="form-input">
            </div>
            <button class="btn-primary" onclick="addProduct()"><i class="ti ti-plus"></i> Add Product</button>
          </div>

          <h3 style="margin: 20px 0 15px; color: #1e293b;">Quick Add by Category</h3>

          <!-- Category sections -->
          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('beverages')">
              <span><i class="ti ti-bottle"></i> Beverages</span>
              <span class="category-preview">Coke, Sprite, Royal, Mineral Water...</span>
            </div>
            <div id="cat-beverages" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Coke 1.5L', 48, 60, 'beverages')">Coke 1.5L</button>
              <button class="quick-item-btn" onclick="quickAddCat('Coke Mismo', 6, 10, 'beverages')">Coke Mismo</button>
              <button class="quick-item-btn" onclick="quickAddCat('Sprite 1.5L', 48, 60, 'beverages')">Sprite 1.5L</button>
              <button class="quick-item-btn" onclick="quickAddCat('Royal 1.5L', 48, 60, 'beverages')">Royal 1.5L</button>
              <button class="quick-item-btn" onclick="quickAddCat('Mountain Dew 1.5L', 48, 60, 'beverages')">Mountain Dew 1.5L</button>
              <button class="quick-item-btn" onclick="quickAddCat('C2 Solo', 10, 15, 'beverages')">C2 Solo</button>
              <button class="quick-item-btn" onclick="quickAddCat('Gatorade 500ml', 35, 45, 'beverages')">Gatorade 500ml</button>
              <button class="quick-item-btn" onclick="quickAddCat('Mineral Water 500ml', 10, 15, 'beverages')">Mineral Water 500ml</button>
              <button class="quick-item-btn" onclick="quickAddCat('Red Bull', 45, 60, 'beverages')">Red Bull</button>
              <button class="quick-item-btn" onclick="quickAddCat('Cobra Energy', 25, 35, 'beverages')">Cobra Energy</button>
            </div>
          </div>

          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('noodles')">
              <span><i class="ti ti-noodles"></i> Noodles</span>
              <span class="category-preview">Lucky Me, Payless, Quickchow...</span>
            </div>
            <div id="cat-noodles" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Lucky Me Pancit Canton Original', 10, 15, 'noodles')">Pancit Canton Original</button>
              <button class="quick-item-btn" onclick="quickAddCat('Lucky Me Pancit Canton Chilimansi', 10, 15, 'noodles')">Pancit Canton Chilimansi</button>
              <button class="quick-item-btn" onclick="quickAddCat('Lucky Me Pancit Canton Sweet & Spicy', 10, 15, 'noodles')">Pancit Canton Sweet & Spicy</button>
              <button class="quick-item-btn" onclick="quickAddCat('Lucky Me Beef Noodles', 8, 12, 'noodles')">Lucky Me Beef</button>
              <button class="quick-item-btn" onclick="quickAddCat('Lucky Me Chicken Noodles', 8, 12, 'noodles')">Lucky Me Chicken</button>
              <button class="quick-item-btn" onclick="quickAddCat('Payless Pancit Canton', 8, 12, 'noodles')">Payless Pancit Canton</button>
              <button class="quick-item-btn" onclick="quickAddCat('Quickchow', 7, 10, 'noodles')">Quickchow</button>
              <button class="quick-item-btn" onclick="quickAddCat('Nissin Cup Noodles Seafood', 25, 35, 'noodles')">Cup Noodles Seafood</button>
              <button class="quick-item-btn" onclick="quickAddCat('Nissin Cup Noodles Beef', 25, 35, 'noodles')">Cup Noodles Beef</button>
            </div>
          </div>

          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('snacks')">
              <span><i class="ti ti-cookie"></i> Snacks</span>
              <span class="category-preview">Piattos, Nova, Chippy, V-Cut...</span>
            </div>
            <div id="cat-snacks" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Piattos Cheese', 15, 20, 'snacks')">Piattos Cheese</button>
              <button class="quick-item-btn" onclick="quickAddCat('Piattos Sour Cream', 15, 20, 'snacks')">Piattos Sour Cream</button>
              <button class="quick-item-btn" onclick="quickAddCat('Nova Country Cheddar', 15, 20, 'snacks')">Nova Cheddar</button>
              <button class="quick-item-btn" onclick="quickAddCat('Nova BBQ', 15, 20, 'snacks')">Nova BBQ</button>
              <button class="quick-item-btn" onclick="quickAddCat('Chippy BBQ', 8, 12, 'snacks')">Chippy BBQ</button>
              <button class="quick-item-btn" onclick="quickAddCat('Chippy Chili', 8, 12, 'snacks')">Chippy Chili</button>
              <button class="quick-item-btn" onclick="quickAddCat('V-Cut Spicy BBQ', 15, 20, 'snacks')">V-Cut Spicy BBQ</button>
              <button class="quick-item-btn" onclick="quickAddCat('Boy Bawang', 8, 12, 'snacks')">Boy Bawang</button>
              <button class="quick-item-btn" onclick="quickAddCat('Cracklings', 10, 15, 'snacks')">Cracklings</button>
              <button class="quick-item-btn" onclick="quickAddCat('Hansel Crackers', 7, 10, 'snacks')">Hansel Crackers</button>
            </div>
          </div>

          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('canned')">
              <span><i class="ti ti-box"></i> Canned Goods</span>
              <span class="category-preview">Corned Beef, Sardines, Tuna...</span>
            </div>
            <div id="cat-canned" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Argentina Corned Beef 175g', 35, 45, 'canned')">Argentina Corned Beef</button>
              <button class="quick-item-btn" onclick="quickAddCat('CDO Corned Beef 150g', 30, 40, 'canned')">CDO Corned Beef</button>
              <button class="quick-item-btn" onclick="quickAddCat('Ligo Sardines Red', 18, 25, 'canned')">Ligo Sardines Red</button>
              <button class="quick-item-btn" onclick="quickAddCat('Ligo Sardines Green', 18, 25, 'canned')">Ligo Sardines Green</button>
              <button class="quick-item-btn" onclick="quickAddCat('555 Sardines', 15, 22, 'canned')">555 Sardines</button>
              <button class="quick-item-btn" onclick="quickAddCat('Century Tuna Flakes', 30, 40, 'canned')">Century Tuna Flakes</button>
              <button class="quick-item-btn" onclick="quickAddCat('Century Tuna Caldereta', 32, 42, 'canned')">Century Tuna Caldereta</button>
              <button class="quick-item-btn" onclick="quickAddCat('Spam Regular', 140, 175, 'canned')">Spam Regular</button>
              <button class="quick-item-btn" onclick="quickAddCat('Maling Luncheon Meat', 45, 60, 'canned')">Maling</button>
            </div>
          </div>

          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('coffee')">
              <span><i class="ti ti-coffee"></i> Coffee & Tea</span>
              <span class="category-preview">Kopiko, Nescafe, Great Taste, Milo...</span>
            </div>
            <div id="cat-coffee" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Kopiko Black 3in1', 7, 10, 'coffee')">Kopiko Black 3in1</button>
              <button class="quick-item-btn" onclick="quickAddCat('Kopiko Brown 3in1', 7, 10, 'coffee')">Kopiko Brown 3in1</button>
              <button class="quick-item-btn" onclick="quickAddCat('Nescafe Original 3in1', 8, 12, 'coffee')">Nescafe 3in1</button>
              <button class="quick-item-btn" onclick="quickAddCat('Great Taste White', 8, 12, 'coffee')">Great Taste White</button>
              <button class="quick-item-btn" onclick="quickAddCat('Great Taste Original', 8, 12, 'coffee')">Great Taste Original</button>
              <button class="quick-item-btn" onclick="quickAddCat('Milo Sachet', 8, 12, 'coffee')">Milo Sachet</button>
              <button class="quick-item-btn" onclick="quickAddCat('Bear Brand Powdered', 10, 15, 'coffee')">Bear Brand</button>
              <button class="quick-item-btn" onclick="quickAddCat('Lipton Tea', 5, 8, 'coffee')">Lipton Tea</button>
            </div>
          </div>

          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('dairy')">
              <span><i class="ti ti-milk"></i> Dairy & Eggs</span>
              <span class="category-preview">Fresh Milk, Eggs, Cheese, Butter...</span>
            </div>
            <div id="cat-dairy" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Fresh Eggs (per piece)', 6, 8, 'dairy')">Fresh Eggs</button>
              <button class="quick-item-btn" onclick="quickAddCat('Alaska Evap Milk', 30, 38, 'dairy')">Alaska Evap</button>
              <button class="quick-item-btn" onclick="quickAddCat('Alaska Condensed Milk', 32, 40, 'dairy')">Alaska Condensed</button>
              <button class="quick-item-btn" onclick="quickAddCat('Quickmelt Cheese', 80, 100, 'dairy')">Quickmelt Cheese</button>
              <button class="quick-item-btn" onclick="quickAddCat('Star Margarine', 15, 20, 'dairy')">Star Margarine</button>
              <button class="quick-item-btn" onclick="quickAddCat('Anchor Butter', 40, 50, 'dairy')">Anchor Butter</button>
            </div>
          </div>

          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('condiments')">
              <span><i class="ti ti-salt"></i> Condiments</span>
              <span class="category-preview">Soy Sauce, Vinegar, Salt, Sugar...</span>
            </div>
            <div id="cat-condiments" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Datu Puti Soy Sauce 385ml', 18, 25, 'condiments')">Datu Puti Soy Sauce</button>
              <button class="quick-item-btn" onclick="quickAddCat('Datu Puti Vinegar 385ml', 15, 22, 'condiments')">Datu Puti Vinegar</button>
              <button class="quick-item-btn" onclick="quickAddCat('Silver Swan Soy Sauce', 18, 25, 'condiments')">Silver Swan Soy Sauce</button>
              <button class="quick-item-btn" onclick="quickAddCat('UFC Ketchup 320g', 35, 45, 'condiments')">UFC Ketchup</button>
              <button class="quick-item-btn" onclick="quickAddCat('Mang Tomas Sarsa', 25, 35, 'condiments')">Mang Tomas</button>
              <button class="quick-item-btn" onclick="quickAddCat('Magic Sarap 16g', 5, 8, 'condiments')">Magic Sarap</button>
              <button class="quick-item-btn" onclick="quickAddCat('Knorr Cubes', 5, 8, 'condiments')">Knorr Cubes</button>
              <button class="quick-item-btn" onclick="quickAddCat('Iodized Salt 500g', 15, 20, 'condiments')">Iodized Salt</button>
              <button class="quick-item-btn" onclick="quickAddCat('White Sugar (per kilo)', 55, 70, 'condiments')">White Sugar</button>
            </div>
          </div>

          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('personal')">
              <span><i class="ti ti-hand-soap"></i> Personal Care</span>
              <span class="category-preview">Shampoo, Soap, Toothpaste...</span>
            </div>
            <div id="cat-personal" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Safeguard Soap', 20, 28, 'personal')">Safeguard Soap</button>
              <button class="quick-item-btn" onclick="quickAddCat('Palmolive Shampoo Sachet', 6, 10, 'personal')">Palmolive Shampoo</button>
              <button class="quick-item-btn" onclick="quickAddCat('Head & Shoulders Sachet', 7, 12, 'personal')">Head & Shoulders</button>
              <button class="quick-item-btn" onclick="quickAddCat('Colgate Toothpaste 25ml', 15, 22, 'personal')">Colgate Small</button>
              <button class="quick-item-btn" onclick="quickAddCat('Close Up Toothpaste', 15, 22, 'personal')">Close Up</button>
              <button class="quick-item-btn" onclick="quickAddCat('Modess Regular', 7, 12, 'personal')">Modess Regular</button>
              <button class="quick-item-btn" onclick="quickAddCat('Whisper with Wings', 8, 13, 'personal')">Whisper</button>
              <button class="quick-item-btn" onclick="quickAddCat('Bioderm Soap', 15, 22, 'personal')">Bioderm Soap</button>
            </div>
          </div>

          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('firstaid')">
              <span><i class="ti ti-first-aid-kit"></i> First Aid</span>
              <span class="category-preview">Biogesic, Neozep, Band-Aid...</span>
            </div>
            <div id="cat-firstaid" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Biogesic 500mg', 5, 8, 'firstaid')">Biogesic</button>
              <button class="quick-item-btn" onclick="quickAddCat('Neozep Forte', 7, 10, 'firstaid')">Neozep Forte</button>
              <button class="quick-item-btn" onclick="quickAddCat('Bioflu', 8, 12, 'firstaid')">Bioflu</button>
              <button class="quick-item-btn" onclick="quickAddCat('Medicol Advance', 7, 10, 'firstaid')">Medicol Advance</button>
              <button class="quick-item-btn" onclick="quickAddCat('Band-Aid', 5, 8, 'firstaid')">Band-Aid</button>
              <button class="quick-item-btn" onclick="quickAddCat('Betadine 10ml', 30, 40, 'firstaid')">Betadine</button>
              <button class="quick-item-btn" onclick="quickAddCat('Efficascent Oil', 35, 45, 'firstaid')">Efficascent Oil</button>
              <button class="quick-item-btn" onclick="quickAddCat('Vicks Vaporub', 25, 35, 'firstaid')">Vicks Vaporub</button>
            </div>
          </div>

          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('household')">
              <span><i class="ti ti-broom"></i> Household</span>
              <span class="category-preview">Detergent, Fabric Softener, Bleach...</span>
            </div>
            <div id="cat-household" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Ariel Powder 66g', 7, 10, 'household')">Ariel Powder</button>
              <button class="quick-item-btn" onclick="quickAddCat('Tide Powder 66g', 7, 10, 'household')">Tide Powder</button>
              <button class="quick-item-btn" onclick="quickAddCat('Surf Powder 66g', 6, 9, 'household')">Surf Powder</button>
              <button class="quick-item-btn" onclick="quickAddCat('Downy Sachet', 6, 10, 'household')">Downy Sachet</button>
              <button class="quick-item-btn" onclick="quickAddCat('Zonrox Bleach 250ml', 15, 22, 'household')">Zonrox Bleach</button>
              <button class="quick-item-btn" onclick="quickAddCat('Joy Dishwashing 25ml', 7, 10, 'household')">Joy Dishwashing</button>
            </div>
          </div>

          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('candy')">
              <span><i class="ti ti-candy"></i> Candy & Sweets</span>
              <span class="category-preview">Mentos, Maxx, Halls, Chocolates...</span>
            </div>
            <div id="cat-candy" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Mentos', 6, 10, 'candy')">Mentos</button>
              <button class="quick-item-btn" onclick="quickAddCat('Maxx Candy', 1, 2, 'candy')">Maxx Candy</button>
              <button class="quick-item-btn" onclick="quickAddCat('Halls', 6, 10, 'candy')">Halls</button>
              <button class="quick-item-btn" onclick="quickAddCat('Kopiko Candy', 1, 2, 'candy')">Kopiko Candy</button>
              <button class="quick-item-btn" onclick="quickAddCat('Choc-Nut', 2, 3, 'candy')">Choc-Nut</button>
              <button class="quick-item-btn" onclick="quickAddCat('Stick-O', 8, 12, 'candy')">Stick-O</button>
              <button class="quick-item-btn" onclick="quickAddCat('Cloud 9', 7, 10, 'candy')">Cloud 9</button>
            </div>
          </div>

          <div class="category-section">
            <div class="category-header" onclick="toggleCategory('cigarettes')">
              <span><i class="ti ti-smoking"></i> Cigarettes</span>
              <span class="category-preview">Marlboro, Fortune, Hope...</span>
            </div>
            <div id="cat-cigarettes" class="category-items" style="display: none;">
              <button class="quick-item-btn" onclick="quickAddCat('Marlboro Red (per stick)', 6, 8, 'cigarettes')">Marlboro Red/stick</button>
              <button class="quick-item-btn" onclick="quickAddCat('Marlboro Red (pack)', 115, 140, 'cigarettes')">Marlboro Red/pack</button>
              <button class="quick-item-btn" onclick="quickAddCat('Fortune (per stick)', 5, 7, 'cigarettes')">Fortune/stick</button>
              <button class="quick-item-btn" onclick="quickAddCat('Fortune (pack)', 95, 115, 'cigarettes')">Fortune/pack</button>
              <button class="quick-item-btn" onclick="quickAddCat('Hope (per stick)', 4, 6, 'cigarettes')">Hope/stick</button>
              <button class="quick-item-btn" onclick="quickAddCat('Mighty Red (per stick)', 4, 6, 'cigarettes')">Mighty/stick</button>
            </div>
          </div>
        </div>

        <!-- Tools Tab -->
        <div id="tools" class="tab-content">
          <div class="section-header" style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); color: #6b21a8; padding: 12px 15px; border-radius: 12px; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
              <i class="ti ti-bulb"></i> Smart Decision Tools
            </h3>
            <p style="margin: 4px 0 0 0; font-size: 0.85em; opacity: 0.9;">Answer questions to get data-driven recommendations</p>
          </div>

          <!-- New Product Evaluator -->
          <div class="decision-card">
            <div class="decision-card-title"><i class="ti ti-chart-dots"></i> Should I Stock This Product?</div>
            <p style="font-size: 0.85em; color: #64748b; margin-bottom: 12px;">Answer a few questions and we'll help you decide if it's worth selling.</p>
            
            <!-- Historical Data Notice -->
            <div id="historicalDataNotice" class="historical-data-notice" style="display: none;">
              <i class="ti ti-database"></i> <strong>Historical data available!</strong> Demand scenarios have been pre-filled based on similar products in your inventory.
            </div>
            <div id="noHistoricalDataNotice" class="no-historical-data-notice">
              <i class="ti ti-alert-circle"></i> <strong>No historical data available.</strong> Enter your own demand and probability estimates to analyze.
            </div>
            
            <div class="decision-form" id="newProductEvaluatorForm">
              <div class="form-row">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Product Name</label>
                  <input type="text" id="evalProductName" class="form-input" placeholder="e.g., Korean Ramen" oninput="checkHistoricalData()">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Category</label>
                  <select id="evalCategory" class="form-input" onchange="checkHistoricalData()">
                    <option value="">-- Select Category --</option>
                    <option value="beverages">Beverages</option>
                    <option value="noodles">Noodles</option>
                    <option value="snacks">Snacks</option>
                    <option value="canned">Canned Goods</option>
                    <option value="coffee">Coffee & Tea</option>
                    <option value="dairy">Dairy & Eggs</option>
                    <option value="condiments">Condiments</option>
                    <option value="personal">Personal Care</option>
                    <option value="firstaid">First Aid</option>
                    <option value="household">Household</option>
                    <option value="candy">Candy & Sweets</option>
                    <option value="cigarettes">Cigarettes</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Initial Stock Qty</label>
                  <input type="number" id="evalInitialQty" class="form-input" placeholder="20">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Cost Price (₱)</label>
                  <input type="number" id="evalCostPrice" class="form-input" placeholder="25">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Selling Price (₱)</label>
                  <input type="number" id="evalSellingPrice" class="form-input" placeholder="35">
                </div>
              </div>
              <div style="font-size: 0.85em; color: #374151; font-weight: 600; margin-top: 12px;">Weekly Demand Scenarios:</div>
              <div class="form-row-3">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 0.75em;">High Demand</label>
                  <input type="number" id="evalHighDemand" class="form-input" placeholder="50" style="font-size: 0.85em;">
                  <label class="form-label" style="font-size: 0.7em; margin-top: 4px;">Probability %</label>
                  <input type="number" id="evalHighProb" class="form-input" placeholder="20" style="font-size: 0.85em;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 0.75em;">Medium Demand</label>
                  <input type="number" id="evalMedDemand" class="form-input" placeholder="20" style="font-size: 0.85em;">
                  <label class="form-label" style="font-size: 0.7em; margin-top: 4px;">Probability %</label>
                  <input type="number" id="evalMedProb" class="form-input" placeholder="60" style="font-size: 0.85em;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label" style="font-size: 0.75em;">Low Demand</label>
                  <input type="number" id="evalLowDemand" class="form-input" placeholder="5" style="font-size: 0.85em;">
                  <label class="form-label" style="font-size: 0.7em; margin-top: 4px;">Probability %</label>
                  <input type="number" id="evalLowProb" class="form-input" placeholder="20" style="font-size: 0.85em;">
                </div>
              </div>
              <button class="btn-primary" onclick="runNewProductEvaluation()" style="margin-top: 12px;"><i class="ti ti-calculator"></i> Evaluate Product</button>
            </div>
            <div id="newProductResult" style="display: none;"></div>
          </div>

          <!-- Markdown Decision Analyzer - Hidden for sari-sari store context -->
          <!-- Markdowns/discounts are uncommon in sari-sari stores. Products near expiry are
               typically sold at regular price or consumed by the store owner. This feature
               is hidden to simplify the UI for the target users. -->

          <!-- Quick Analysis Summary -->
          <div class="decision-card" style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(230,231,238,0.9) 100%); border-color: rgba(209,217,230,0.6); box-shadow: 3px 3px 6px rgba(174,174,192,0.3), -3px -3px 6px rgba(255,255,255,0.8);">
            <div class="decision-card-title" style="color: #4A5568;"><i class="ti ti-info-circle"></i> How to Use This Tool</div>
            <div style="font-size: 0.85em; color: #718096;">
              <p><strong>New Product Evaluator:</strong> Enter product details and demand scenarios. The tool calculates Expected Value (EV) and risk to help you decide if stocking a new product is worthwhile.</p>
              <p style="margin-top: 8px;"><strong>Tip:</strong> The more sales data you have, the better the predictions become!</p>
            </div>
          </div>
        </div>
        <!-- END Tools Tab -->

        <!-- NEW CODE - Settings Tab (Properly Wrapped) -->
        <div id="settings" class="tab-content">
          <!-- Store Information Section -->
          <div class="settings-section">
            <div class="settings-title">Store Information</div>
            <div class="setting-item">
              <span class="setting-label">Store Name</span>
              <span class="setting-value">My Sari-Sari Store</span>
            </div>
            <div class="setting-item">
              <span class="setting-label">Total Products</span>
              <span class="setting-value" id="settingsTotalProducts">0</span>
            </div>
            <div class="setting-item">
              <span class="setting-label">Data Stored Since</span>
              <span class="setting-value" id="dataStartDate">Today</span>
            </div>
          </div>

          <!-- Prediction & Shopping List Settings -->
          <div class="settings-section">
            <div class="settings-title">Prediction & Shopping List Settings</div>
            <div class="setting-item">
              <label for="forecastingMethod" class="setting-label">Forecasting Method</label>
              <select id="forecastingMethod" class="form-input setting-input">
                <option value="auto">Auto (based on history)</option>
                <option value="exponential">Exponential Smoothing</option>
                <option value="movingAverage">Simple Moving Average</option>
              </select>
            </div>
            <!-- Cash on Hand (Workflow Image 2: Cash-on Hand Report) -->
            <div class="setting-item" style="background: linear-gradient(135deg, #E6F4EA 0%, #D4EDDA 100%); margin: -10px -16px 10px; padding: 12px 16px; border-radius: var(--radius-sm);">
              <div style="flex: 1;">
                <label for="cashOnHand" class="setting-label" style="color: #155724;"><i class="ti ti-wallet"></i> Cash on Hand (₱)</label>
                <div style="font-size: 0.68em; color: #28a745; margin-top: 2px;">Weekly cash count - update before restocking</div>
              </div>
              <input type="number" id="cashOnHand" class="form-input setting-input" style="width: 100px; font-weight: 600; font-size: 1em;" placeholder="0">
            </div>
            <div id="cashUpdateInfo" style="font-size: 0.68em; color: var(--muted); margin-bottom: 10px; text-align: right;"></div>
            
            <div class="setting-item">
              <label for="shoppingBudget" class="setting-label">Max Shopping Budget (₱)</label>
              <input type="number" id="shoppingBudget" class="form-input setting-input">
              <div style="font-size: 0.68em; color: var(--muted); margin-top: 4px;">
                <i class="ti ti-info-circle"></i> Maximum budget cap. Actual budget uses Cash on Hand if lower.
              </div>
            </div>
            
            <!-- Planned Withdrawal Setting (Workflow Image 2) -->
            <div class="setting-item">
              <label for="plannedWithdrawal" class="setting-label">Planned Withdrawals (₱)</label>
              <input type="number" id="plannedWithdrawal" class="form-input setting-input" placeholder="0">
              <div style="font-size: 0.68em; color: var(--muted); margin-top: 4px;">
                <i class="ti ti-info-circle"></i> Amount reserved for household/personal use. Deducted from shopping budget.
              </div>
            </div>
            <div class="setting-item" style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="deductWithdrawalsFromBudget" style="width: 18px; height: 18px;">
              <label for="deductWithdrawalsFromBudget" class="setting-label" style="flex: 1; margin: 0;">
                Auto-deduct recent withdrawals from budget
                <div style="font-size: 0.68em; color: var(--muted); font-weight: normal;">
                  Uses actual withdrawals from this week if higher than planned amount
                </div>
              </label>
            </div>
            
            <div class="setting-item" style="display: none;">
              <label for="storageCapacity" class="setting-label">Storage Capacity (units)</label>
              <input type="number" id="storageCapacity" class="form-input setting-input">
            </div>
            <div class="setting-item">
              <label for="reviewPeriodDays" class="setting-label">How often do you restock? (days)</label>
              <input type="number" id="reviewPeriodDays" class="form-input setting-input">
            </div>
            <div class="setting-item">
              <label for="safetyStockDays" class="setting-label">Safety stock buffer (days)</label>
              <input type="number" id="safetyStockDays" class="form-input setting-input">
            </div>
            <div class="setting-item">
              <label for="leadTimeDays" class="setting-label">Supplier lead time (days)</label>
              <input type="number" id="leadTimeDays" class="form-input setting-input">
            </div>
            <div style="text-align:right; margin-top:15px;">
              <button class="btn-primary" onclick="savePredictionSettings()"><i class="ti ti-device-floppy"></i> Save Settings</button>
            </div>
          </div>

          <!-- Data Management -->
          <div class="settings-section">
            <div class="settings-title">Data Management</div>
            <div class="setting-item">
              <span class="setting-label">Export All Data</span>
              <button class="btn-secondary" onclick="exportData()"><i class="ti ti-download"></i> Export JSON</button>
            </div>
            <div class="setting-item">
              <span class="setting-label">Load Demo Data</span>
              <button class="btn-secondary" onclick="reloadDemoData()" style="background: #dbeafe; border-color: #93c5fd; color: #1e40af;"><i class="ti ti-database"></i> Load Demo</button>
            </div>
            <div class="setting-item">
              <span class="setting-label">Clear All Data</span>
              <button class="btn-danger" onclick="confirmClearData()"><i class="ti ti-trash"></i> Clear Data</button>
            </div>
          </div>
        </div>
        <!-- END Settings Tab -->

      </div> <!-- End .content -->
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div id="editProductModal" class="modal-overlay" onclick="closeEditModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Edit Product</h3>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <div id="editProductForm">
        <input type="hidden" id="editProductId">
        <div class="form-group">
          <label class="form-label">Product Name</label>
          <input type="text" id="editProductName" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Cost Price (₱)</label>
          <input type="number" id="editCostPrice" class="form-input" step="0.50" inputmode="decimal">
        </div>
        <div class="form-group">
          <label class="form-label">Selling Price (₱)</label>
          <input type="number" id="editSellingPrice" class="form-input" step="0.50" inputmode="decimal">
        </div>
        <div class="form-group">
          <label class="form-label">Current Stock</label>
          <input type="number" id="editStock" class="form-input" min="0" inputmode="numeric">
        </div>
         <div class="form-group">
          <label class="form-label">Max Stock (Optional)</label>
          <input type="number" id="editMaxStock" class="form-input" min="0" inputmode="numeric" placeholder="e.g., 50">
        </div>
        <div class="form-group">
          <label class="form-label">Expiry Date (Optional)</label>
          <input type="date" id="editExpiryDate" class="form-input">
        </div>
        <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
          <input type="checkbox" id="editIsEssential" style="width: 18px; height: 18px;">
          <label for="editIsEssential" class="form-label" style="margin: 0;">
            ⭐ Essential Item
            <div style="font-size: 0.72em; color: var(--muted); font-weight: normal;">
              Prioritized in budget allocation (e.g., eggs, rice, milk)
            </div>
          </label>
        </div>
        <div class="modal-actions">
          <button class="btn-danger" onclick="deleteProduct()"><i class="ti ti-trash"></i> Delete</button>
          <button class="btn-primary" onclick="saveProductChanges()"><i class="ti ti-device-floppy"></i> Save</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Sticky Cart Bar -->
  <div id="cartBar" class="cart-bar cart-hidden" role="region" aria-label="Current sale">
    <div class="cart-summary">
      <div class="summary-left">
        <i class="ti ti-shopping-cart"></i>
        <span id="cartItemsCount">0</span> items • <span id="cartTotal">₱0.00</span>
      </div>
      <button class="cart-toggle" onclick="toggleCartExpand()" aria-label="Expand or collapse cart" title="Expand/Collapse">▾</button>
    </div>
    <div id="cartItemsList" class="cart-items"></div>
    <div class="cart-actions">
      <button class="btn-warning" onclick="finalizeTransaction(true)" aria-label="Pay later">
          <i class="ti ti-notebook"></i> Utang
      </button>
      <button class="btn-primary" onclick="finalizeTransaction(false)" aria-label="Checkout and pay">
          <i class="ti ti-credit-card"></i> Pay Now
      </button>
    </div>
  </div>

  <!-- Install prompt -->
  <div id="installPrompt" class="install-prompt">
    <p><strong>Install TindaTech</strong></p>
    <p style="margin: 10px 0; font-size: 0.9em;">Add to your home screen for offline access!</p>
    <button class="btn-primary" onclick="installPWA()"><i class="ti ti-device-mobile-plus"></i> Install App</button>
  </div>

  <script>
    // Data stores
    let inventory = JSON.parse(localStorage.getItem('tindatech_inventory')) || [];
    let salesHistory = JSON.parse(localStorage.getItem('tindatech_sales')) || [];
    let transactions = JSON.parse(localStorage.getItem('tindatech_transactions')) || [];
    let creditAccounts = JSON.parse(localStorage.getItem('tindatech_credit')) || [];
    let activityLog = JSON.parse(localStorage.getItem('tindatech_activityLog')) || [];
    let personalWithdrawals = JSON.parse(localStorage.getItem('tindatech_withdrawals')) || [];
    let opportunityLosses = JSON.parse(localStorage.getItem('tindatech_opportunity_losses')) || [];
    // Track items recently restocked from the shopping list (session only)
    const recentlyRestockedIds = new Set();
    let settings = JSON.parse(localStorage.getItem('tindatech_settings')) || {
        reviewPeriodDays: 7,
        safetyStockDays: 3,
        leadTimeDays: 1,
        shoppingBudget: 5000,
        storageCapacity: 500,
        forecastingMethod: 'exponential',
        plannedWithdrawal: 0,  // Planned personal/household withdrawals to deduct from budget
        deductWithdrawalsFromBudget: true,  // Auto-deduct recent withdrawals from effective budget
        cashOnHand: 0,  // Weekly cash count input (Workflow Image 2)
        lastCashUpdate: null  // Track when cash was last updated
    };
    // Ensure forecastingMethod exists for older data
    if (!settings.forecastingMethod) settings.forecastingMethod = 'exponential';
    // Ensure new settings exist for older data
    if (settings.plannedWithdrawal === undefined) settings.plannedWithdrawal = 0;
    if (settings.deductWithdrawalsFromBudget === undefined) settings.deductWithdrawalsFromBudget = true;
    if (settings.cashOnHand === undefined) settings.cashOnHand = 0;
    if (settings.lastCashUpdate === undefined) settings.lastCashUpdate = null;
    let alerts = [];
    let deferredPrompt;
    let creditSortMode = 'date'; // 'date', 'amount', 'age'

    // App state
    let currentTransaction = null;
    let cartExpanded = false;
    let manageModeActive = false;

    const CATEGORY_SIZES = {
        beverages: 5, noodles: 2, snacks: 2, canned: 3, coffee: 1, dairy: 3,
        condiments: 2, personal: 2, firstaid: 1, household: 4, candy: 1, cigarettes: 1, other: 3
    };

    // Currency formatter
    const formatPHP = new Intl.NumberFormat(navigator.language || 'en-PH', { style: 'currency', currency: 'PHP', maximumFractionDigits: 2 });

    function setHeaderDate(){
      const now = new Date();
      const weekday = now.toLocaleDateString(navigator.language || 'en-US', { weekday: 'long' });
      const month = now.toLocaleDateString(navigator.language || 'en-US', { month: 'short' });
      const day = now.getDate();
      const year = now.getFullYear();
      const wdEl = document.getElementById('headerWeekday');
      const mdEl = document.getElementById('headerMonthDay');
      if (wdEl) wdEl.textContent = weekday;
      if (mdEl) mdEl.textContent = `${month} ${day}, ${year}`;
    }

    function initializeApp() {
      // Load demo data for screenshots if no data exists
      if (inventory.length === 0) {
        loadDemoData();
      }
      
      setHeaderDate();
      loadPredictionSettings();
      currentCategoryFilter = 'all';
      currentSearchTerm = '';
      loadInventory();
      updateStats();
      generateIntelligentAlerts();
      generateExpiryAlerts();
      generateInsights();
      updateDashboard();
      checkDataStartDate();
      loadCreditTab();
      updateMarkdownAnalyzer();

      // Enable tap feedback baseline
      enableTapFeedback('.filter-chip, .quick-item-btn, .tab, .btn-action, .quick-sell-btn, .btn-primary, .btn-secondary, .btn-warning, .btn-danger');
    }
    
    // Demo data loader for screenshots
    function loadDemoData() {
      const now = new Date();
      const today = now.toISOString();
      
      // Helper to create past dates
      function daysAgo(n) {
        const d = new Date(now);
        d.setDate(d.getDate() - n);
        return d.toISOString();
      }
      function daysFromNow(n) {
        const d = new Date(now);
        d.setDate(d.getDate() + n);
        return d.toISOString().split('T')[0];
      }
      
      // Sample inventory with realistic sari-sari store products
      // Realistic sales data: Small store sells 2-10 units/day for fast movers
      inventory = [
        // === BEVERAGES ===
        { id: 1, name: 'Coke Mismo 295ml', category: 'beverages', costPrice: 8, sellingPrice: 12, stock: 24, totalSold: 42, lastSold: daysAgo(0), expiryDate: daysFromNow(90) },
        { id: 2, name: 'Royal Mismo 295ml', category: 'beverages', costPrice: 8, sellingPrice: 12, stock: 18, totalSold: 35, lastSold: daysAgo(0), expiryDate: daysFromNow(90) },
        { id: 3, name: 'Sprite Mismo 295ml', category: 'beverages', costPrice: 8, sellingPrice: 12, stock: 8, totalSold: 28, lastSold: daysAgo(1), expiryDate: daysFromNow(90) },
        { id: 4, name: 'C2 Apple 500ml', category: 'beverages', costPrice: 18, sellingPrice: 25, stock: 15, totalSold: 15, lastSold: daysAgo(1), expiryDate: daysFromNow(60) },
        { id: 28, name: 'Zest-O Orange 200ml', category: 'beverages', costPrice: 6, sellingPrice: 8, stock: 20, totalSold: 8, lastSold: daysAgo(3), expiryDate: daysFromNow(45) },
        
        // === NOODLES (High demand, some low stock) ===
        { id: 5, name: 'Pancit Canton Original', category: 'noodles', costPrice: 11, sellingPrice: 15, stock: 6, totalSold: 56, lastSold: daysAgo(0), expiryDate: daysFromNow(180) },
        { id: 29, name: 'Pancit Canton Chilimansi', category: 'noodles', costPrice: 11, sellingPrice: 15, stock: 10, totalSold: 42, lastSold: daysAgo(0), expiryDate: daysFromNow(180) },
        { id: 30, name: 'Pancit Canton Kalamansi', category: 'noodles', costPrice: 11, sellingPrice: 15, stock: 14, totalSold: 35, lastSold: daysAgo(0), expiryDate: daysFromNow(180) },
        { id: 6, name: 'Lucky Me! Beef Mami', category: 'noodles', costPrice: 9, sellingPrice: 13, stock: 20, totalSold: 21, lastSold: daysAgo(1), expiryDate: daysFromNow(180) },
        { id: 31, name: 'Payless Pancit Canton', category: 'noodles', costPrice: 7, sellingPrice: 10, stock: 25, totalSold: 18, lastSold: daysAgo(1), expiryDate: daysFromNow(180) },
        
        // === EGGS (Essential, steady demand) ===
        { id: 15, name: 'Eggs 30pcs 1tray', category: 'dairy', costPrice: 185, sellingPrice: 240, stock: 3, totalSold: 12, lastSold: daysAgo(0), expiryDate: daysFromNow(21) },
        
        // === SNACKS ===
        { id: 7, name: 'Skyflakes Crackers', category: 'snacks', costPrice: 8, sellingPrice: 12, stock: 20, totalSold: 18, lastSold: daysAgo(2), expiryDate: daysFromNow(120) },
        { id: 8, name: 'Piattos Cheese', category: 'snacks', costPrice: 12, sellingPrice: 17, stock: 8, totalSold: 14, lastSold: daysAgo(1), expiryDate: daysFromNow(90) },
        { id: 9, name: 'Oishi Prawn Crackers', category: 'snacks', costPrice: 7, sellingPrice: 10, stock: 25, totalSold: 21, lastSold: daysAgo(0), expiryDate: daysFromNow(120) },
        { id: 32, name: 'Boy Bawang Garlic', category: 'snacks', costPrice: 9, sellingPrice: 12, stock: 15, totalSold: 24, lastSold: daysAgo(0), expiryDate: daysFromNow(90) },
        
        // === CANNED GOODS ===
        { id: 10, name: 'Argentina Corned Beef 150g', category: 'canned', costPrice: 32, sellingPrice: 42, stock: 6, totalSold: 10, lastSold: daysAgo(2), expiryDate: daysFromNow(365) },
        { id: 11, name: 'Century Tuna Flakes 180g', category: 'canned', costPrice: 28, sellingPrice: 38, stock: 10, totalSold: 12, lastSold: daysAgo(1), expiryDate: daysFromNow(365) },
        { id: 33, name: 'Ligo Sardines 155g', category: 'canned', costPrice: 18, sellingPrice: 25, stock: 12, totalSold: 21, lastSold: daysAgo(1), expiryDate: daysFromNow(365) },
        
        // === COFFEE (High volume sachets) ===
        { id: 12, name: 'Nescafe 3-in-1 Original', category: 'coffee', costPrice: 7, sellingPrice: 10, stock: 48, totalSold: 70, lastSold: daysAgo(0), expiryDate: daysFromNow(270) },
        { id: 13, name: 'Kopiko Brown 25g', category: 'coffee', costPrice: 6, sellingPrice: 9, stock: 30, totalSold: 49, lastSold: daysAgo(0), expiryDate: daysFromNow(270) },
        { id: 34, name: 'Great Taste White 30g', category: 'coffee', costPrice: 7, sellingPrice: 10, stock: 35, totalSold: 42, lastSold: daysAgo(0), expiryDate: daysFromNow(270) },
        
        // === DAIRY ===
        { id: 14, name: 'Bear Brand Adult Plus', category: 'dairy', costPrice: 12, sellingPrice: 16, stock: 18, totalSold: 24, lastSold: daysAgo(1), expiryDate: daysFromNow(180) },
        { id: 35, name: 'Alaska Evap 140ml', category: 'dairy', costPrice: 18, sellingPrice: 24, stock: 10, totalSold: 18, lastSold: daysAgo(0), expiryDate: daysFromNow(180) },
        
        // === CONDIMENTS & COOKING ===
        { id: 16, name: 'Datu Puti Soy Sauce 100ml', category: 'condiments', costPrice: 8, sellingPrice: 12, stock: 15, totalSold: 14, lastSold: daysAgo(3), expiryDate: daysFromNow(365) },
        { id: 17, name: 'UFC Banana Ketchup 100ml', category: 'condiments', costPrice: 10, sellingPrice: 15, stock: 12, totalSold: 10, lastSold: daysAgo(2), expiryDate: daysFromNow(270) },
        { id: 26, name: 'Oil 250ml', category: 'condiments', costPrice: 35, sellingPrice: 48, stock: 8, totalSold: 28, lastSold: daysAgo(0), expiryDate: daysFromNow(180) },
        { id: 36, name: 'Magic Sarap 8g sachet', category: 'condiments', costPrice: 2, sellingPrice: 3, stock: 50, totalSold: 56, lastSold: daysAgo(0), expiryDate: daysFromNow(365) },
        
        // === PERSONAL CARE ===
        { id: 18, name: 'Safeguard Soap 60g', category: 'personal', costPrice: 22, sellingPrice: 30, stock: 10, totalSold: 8, lastSold: daysAgo(4), expiryDate: null },
        { id: 19, name: 'Colgate Toothpaste 50g', category: 'personal', costPrice: 35, sellingPrice: 48, stock: 6, totalSold: 5, lastSold: daysAgo(3), expiryDate: daysFromNow(365) },
        { id: 37, name: 'Head & Shoulders sachet', category: 'personal', costPrice: 5, sellingPrice: 8, stock: 25, totalSold: 21, lastSold: daysAgo(1), expiryDate: daysFromNow(365) },
        
        // === MEDICINE / FIRST AID ===
        { id: 20, name: 'Biogesic 500mg (per tab)', category: 'firstaid', costPrice: 2, sellingPrice: 5, stock: 50, totalSold: 18, lastSold: daysAgo(1), expiryDate: daysFromNow(365) },
        { id: 21, name: 'Efficascent Oil 15ml', category: 'firstaid', costPrice: 25, sellingPrice: 35, stock: 4, totalSold: 4, lastSold: daysAgo(5), expiryDate: daysFromNow(365) },
        
        // === HOUSEHOLD ===
        { id: 22, name: 'Joy Dishwashing 45ml', category: 'household', costPrice: 8, sellingPrice: 12, stock: 15, totalSold: 10, lastSold: daysAgo(2), expiryDate: null },
        { id: 23, name: 'Ariel Powder 65g', category: 'household', costPrice: 10, sellingPrice: 14, stock: 18, totalSold: 12, lastSold: daysAgo(1), expiryDate: null },
        
        // === CANDY / SWEETS ===
        { id: 24, name: 'Flat Tops Chocolate', category: 'candy', costPrice: 1, sellingPrice: 2, stock: 40, totalSold: 35, lastSold: daysAgo(0), expiryDate: daysFromNow(180) },
        { id: 38, name: 'Mentos Mint (per pc)', category: 'candy', costPrice: 1, sellingPrice: 2, stock: 60, totalSold: 42, lastSold: daysAgo(0), expiryDate: daysFromNow(180) },
        
        // === CIGARETTES ===
        { id: 25, name: 'Marlboro Red (per stick)', category: 'cigarettes', costPrice: 7, sellingPrice: 9, stock: 60, totalSold: 84, lastSold: daysAgo(0), expiryDate: null },
        { id: 39, name: 'Fortune Red (per stick)', category: 'cigarettes', costPrice: 5, sellingPrice: 7, stock: 80, totalSold: 70, lastSold: daysAgo(0), expiryDate: null },
        
        // === RICE / STAPLES ===
        { id: 27, name: 'Bigas (Rice) per kilo', category: 'other', costPrice: 48, sellingPrice: 56, stock: 15, totalSold: 35, lastSold: daysAgo(0), expiryDate: null },
        { id: 40, name: 'Asin (Salt) 250g', category: 'other', costPrice: 8, sellingPrice: 12, stock: 10, totalSold: 12, lastSold: daysAgo(2), expiryDate: null },
        { id: 41, name: 'Asukal (Sugar) per kilo', category: 'other', costPrice: 58, sellingPrice: 70, stock: 8, totalSold: 10, lastSold: daysAgo(3), expiryDate: null },
      ];
      
      // Generate realistic sales history (last 14 days)
      salesHistory = [];
      const salesProducts = [1, 2, 3, 5, 29, 30, 15, 9, 12, 13, 24, 25, 27, 32, 36, 38, 39];
      for (let day = 0; day < 14; day++) {
        const salesCount = Math.floor(Math.random() * 15) + 12; // 12-27 sales per day
        for (let s = 0; s < salesCount; s++) {
          const pId = salesProducts[Math.floor(Math.random() * salesProducts.length)];
          const product = inventory.find(p => p.id === pId);
          if (product) {
            const hour = 6 + Math.floor(Math.random() * 14); // 6am to 8pm
            const timestamp = new Date(now);
            timestamp.setDate(timestamp.getDate() - day);
            timestamp.setHours(hour, Math.floor(Math.random() * 60));
            salesHistory.push({
              productId: pId,
              productName: product.name,
              sellingPrice: product.sellingPrice,
              costPrice: product.costPrice,
              profit: product.sellingPrice - product.costPrice,
              timestamp: timestamp.toISOString()
            });
          }
        }
      }
      
      // Sample credit accounts with different aging
      creditAccounts = [
        {
          id: 1001,
          customerName: 'Aling Rosa',
          items: [
            { productId: 5, name: 'Lucky Me! Pancit Canton Original', qty: 5, price: 15 },
            { productId: 15, name: 'Itlog (Eggs) - per piece', qty: 6, price: 10 },
            { productId: 12, name: 'Nescafe 3-in-1 Original', qty: 3, price: 10 }
          ],
          totalAmount: 165,
          totalProfit: 35,
          timestamp: daysAgo(3),
          status: 'unpaid'
        },
        {
          id: 1002,
          customerName: 'Mang Juan',
          items: [
            { productId: 10, name: 'Argentina Corned Beef 150g', qty: 2, price: 42 },
            { productId: 27, name: 'Bigas (Rice) per kilo', qty: 5, price: 56 },
            { productId: 26, name: 'Baguio Oil 250ml', qty: 1, price: 48 }
          ],
          totalAmount: 412,
          totalProfit: 72,
          timestamp: daysAgo(12),
          status: 'unpaid'
        },
        {
          id: 1003,
          customerName: 'Ate Nena',
          items: [
            { productId: 26, name: 'Baguio Oil 250ml', qty: 2, price: 48 },
            { productId: 15, name: 'Itlog (Eggs) - per piece', qty: 12, price: 10 },
            { productId: 5, name: 'Lucky Me! Pancit Canton Original', qty: 6, price: 15 }
          ],
          totalAmount: 306,
          totalProfit: 62,
          timestamp: daysAgo(35),
          status: 'unpaid'
        },
        {
          id: 1004,
          customerName: 'Kuya Ben',
          items: [
            { productId: 25, name: 'Marlboro Red (per stick)', qty: 20, price: 9 },
            { productId: 1, name: 'Coke Mismo 295ml', qty: 3, price: 12 }
          ],
          totalAmount: 216,
          totalProfit: 52,
          timestamp: daysAgo(45),
          status: 'unpaid'
        }
      ];
      
      // Sample personal withdrawals
      personalWithdrawals = [
        { id: 2001, timestamp: daysAgo(1), productId: 15, productName: 'Itlog (Eggs) - per piece', quantity: 6, costPrice: 8, totalCost: 48, purpose: 'household', notes: 'Almusal ng pamilya' },
        { id: 2002, timestamp: daysAgo(2), productId: 27, productName: 'Bigas (Rice) per kilo', quantity: 2, costPrice: 48, totalCost: 96, purpose: 'household', notes: 'Ulam ng pamilya' },
        { id: 2003, timestamp: daysAgo(3), productId: 5, productName: 'Lucky Me! Pancit Canton Original', quantity: 4, costPrice: 11, totalCost: 44, purpose: 'household', notes: 'Meryenda ng mga bata' },
        { id: 2004, timestamp: daysAgo(5), productId: 12, productName: 'Nescafe 3-in-1 Original', quantity: 7, costPrice: 7, totalCost: 49, purpose: 'personal', notes: 'Morning coffee' },
        { id: 2005, timestamp: daysAgo(4), productId: 24, productName: 'Flat Tops Chocolate', quantity: 10, costPrice: 1, totalCost: 10, purpose: 'gift', notes: 'Para sa pamangkin' }
      ];
      
      // Sample opportunity losses (stockouts) - these items ran out
      opportunityLosses = [
        { id: 3001, timestamp: daysAgo(1), productName: 'Itlog (Eggs) - per piece', quantity: 12, sellingPrice: 10, lostRevenue: 120 },
        { id: 3002, timestamp: daysAgo(2), productName: 'Lucky Me! Pancit Canton Original', quantity: 8, sellingPrice: 15, lostRevenue: 120 },
        { id: 3003, timestamp: daysAgo(3), productName: 'Baguio Oil 250ml', quantity: 3, sellingPrice: 48, lostRevenue: 144 },
        { id: 3004, timestamp: daysAgo(4), productName: 'Lucky Me! Pancit Canton Chilimansi', quantity: 5, sellingPrice: 15, lostRevenue: 75 },
        { id: 3005, timestamp: daysAgo(5), productName: 'Itlog (Eggs) - per piece', quantity: 6, sellingPrice: 10, lostRevenue: 60 }
      ];
      
      // Sample activity log
      activityLog = [
        { timestamp: daysAgo(0), type: 'sale', message: 'Sold 6 Itlog (Eggs) for ₱60.00.', details: {} },
        { timestamp: daysAgo(0), type: 'sale', message: 'Sold 3 Lucky Me! Pancit Canton for ₱45.00.', details: {} },
        { timestamp: daysAgo(0), type: 'sale', message: 'Sold 2 Coke Mismo 295ml for ₱24.00.', details: {} },
        { timestamp: daysAgo(1), type: 'lost_sale', message: 'Lost sale: 12x Itlog (Eggs) (₱120.00 lost)', details: {} },
        { timestamp: daysAgo(1), type: 'credit_add', message: "Created credit for 'Aling Rosa' worth ₱165.00.", details: {} },
        { timestamp: daysAgo(2), type: 'lost_sale', message: 'Lost sale: 8x Lucky Me! Pancit Canton (₱120.00 lost)', details: {} },
        { timestamp: daysAgo(2), type: 'withdrawal', message: 'Withdrew 2x Bigas (Rice) for household (₱96.00)', details: {} },
        { timestamp: daysAgo(3), type: 'add', message: 'Added 24 Coke Mismo 295ml to inventory.', details: {} }
      ];
      
      // Settings - preserve existing settings, only set defaults for missing values
      const existingSettings = JSON.parse(localStorage.getItem('tindatech_settings')) || {};
      settings = {
        reviewPeriodDays: existingSettings.reviewPeriodDays || 7,
        safetyStockDays: existingSettings.safetyStockDays || 3,
        leadTimeDays: existingSettings.leadTimeDays || 1,
        shoppingBudget: existingSettings.shoppingBudget || 3000,
        storageCapacity: existingSettings.storageCapacity || 500,
        forecastingMethod: existingSettings.forecastingMethod || 'exponential',
        plannedWithdrawal: existingSettings.plannedWithdrawal || 0,
        deductWithdrawalsFromBudget: existingSettings.deductWithdrawalsFromBudget !== false,
        cashOnHand: existingSettings.cashOnHand || 0,
        lastCashUpdate: existingSettings.lastCashUpdate || null
      };
      
      // Save all demo data
      saveData();
      localStorage.setItem('tindatech_start_date', daysAgo(14));
      
      console.log('Demo data loaded successfully!');
    }
    
    // Function to clear demo data
    function clearAllData() {
      if (confirm('This will delete ALL data. Are you sure?')) {
        localStorage.clear();
        location.reload();
      }
    }
    
    // Function to reload demo data (for screenshots)
    function reloadDemoData() {
      if (confirm('This will replace current data with demo data. Continue?')) {
        // Clear localStorage to force fresh data
        localStorage.removeItem('inventory');
        localStorage.removeItem('salesHistory');
        localStorage.removeItem('creditAccounts');
        localStorage.removeItem('personalWithdrawals');
        localStorage.removeItem('opportunityLosses');
        localStorage.removeItem('activityLog');
        
        // Clear existing data
        inventory = [];
        salesHistory = [];
        creditAccounts = [];
        personalWithdrawals = [];
        opportunityLosses = [];
        activityLog = [];
        
        // Load fresh demo data
        loadDemoData();
        
        // Save to localStorage
        saveData();
        
        // Refresh the UI
        loadInventory();
        updateStats();
        generateIntelligentAlerts();
        generateExpiryAlerts();
        generateInsights();
        updateDashboard();
        loadCreditTab();
        generateShoppingList(); // Force regenerate shopping list
        
        showFeedback('Demo data loaded successfully! Refresh the page to see changes.');
      }
    }
    
    document.addEventListener('DOMContentLoaded', initializeApp);

    // Tap feedback helper (idempotent)
    function enableTapFeedback(selector) {
      const els = document.querySelectorAll(selector);
      els.forEach(el => {
        if (el.dataset.tapbound === '1') return;
        el.dataset.tapbound = '1';
        el.addEventListener('touchstart', () => el.classList.add('tap-press'), { passive: true });
        el.addEventListener('touchend', () => el.classList.remove('tap-press'));
        el.addEventListener('touchcancel', () => el.classList.remove('tap-press'));
        el.addEventListener('mousedown', () => el.classList.add('tap-press'));
        ['mouseup','mouseleave','blur'].forEach(evt =>
          el.addEventListener(evt, () => el.classList.remove('tap-press'))
        );
      });
    }

    // Tabs
    function switchTab(e, tabName) {
        document.querySelectorAll('.tab').forEach(tab => { tab.classList.remove('active'); tab.setAttribute('aria-selected','false'); });
        const targetTab = e.target.closest('.tab');
        targetTab.classList.add('active');
        targetTab.setAttribute('aria-selected','true');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        
        if (tabName === 'insights') { updateDashboard(); generateInsights(); drawSalesChart(); }
        else if (tabName === 'settings') { updateSettings(); }
        else if (tabName === 'credit') { loadCreditTab(); }
        else if (tabName === 'history') { loadHistoryTab(); }
        else if (tabName === 'tools') { updateMarkdownAnalyzer(); }
    }
    
    // =====================================================================
    // DEMAND RATE CALCULATION — SIMPLE MANUAL METHOD
    // =====================================================================
    // This calculates how many units of a product sell PER DAY on average.
    // We use a simple, transparent approach that anyone can verify by hand.
    //
    // STEP-BY-STEP (like doing it manually):
    //   1. Count total units sold in the last N days (from sales history)
    //   2. Divide by N to get average daily demand
    //   3. If no sales history, use totalSold ÷ daysActive as fallback
    //
    // Example: If you sold 14 units in the last 7 days → 14 ÷ 7 = 2 units/day
    // =====================================================================

    function countUnitsSoldInLastNDays(productId, days) {
        // Step 1: Determine the cutoff date (N days ago at midnight)
        const now = new Date();
        const cutoffDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - days);
        
        // Step 2: Loop through sales history and count units for this product
        let totalUnits = 0;
        for (let i = 0; i < salesHistory.length; i++) {
            const sale = salesHistory[i];
            if (sale.productId !== productId) continue;  // Skip other products
            
            const saleDate = new Date(sale.timestamp);
            if (saleDate >= cutoffDate) {
                // Count quantity if available, otherwise assume 1 unit per sale
                const qty = Number(sale.qty) || 1;
                totalUnits = totalUnits + qty;
            }
        }
        
        return totalUnits;
    }

    function calculateDailyDemandRate(product) {
        // =====================================================================
        // MANUAL CALCULATION OF DAILY DEMAND RATE (d)
        // =====================================================================
        // Formula: d = (units sold in last R days) ÷ R
        // where R = review period (how often you restock, e.g., 7 days)
        // =====================================================================
        
        const reviewDays = Math.max(1, Number(settings.reviewPeriodDays) || 7);
        
        // Step 1: Count how many units sold in the last review period
        const unitsSoldInPeriod = countUnitsSoldInLastNDays(product.id, reviewDays);
        
        // Step 2: Calculate average daily demand
        let dailyRate = unitsSoldInPeriod / reviewDays;
        
        // Step 3: If no recent sales, check if there's any sales history at all
        if (dailyRate === 0 && product.totalSold > 0) {
            // Fallback: use lifetime average
            const daysActive = getDaysActive(product);
            dailyRate = product.totalSold / daysActive;
        }
        
        // Step 4: Round to 2 decimal places for readability
        dailyRate = Math.round(dailyRate * 100) / 100;
        
        return dailyRate;
    }

    // =====================================================================
    // ORDER QUANTITY CALCULATION — SIMPLE MANUAL METHOD
    // =====================================================================
    // This calculates HOW MANY UNITS to order for each product.
    //
    // STEP-BY-STEP (like doing it manually):
    //   1. Calculate daily demand rate (d) — how many units sell per day
    //   2. Calculate how many days until next restock arrives (R + L)
    //   3. Calculate target stock = enough to last until next delivery
    //   4. Order quantity = target stock − current stock
    //
    // FORMULAS (standard OM/IE):
    //   d = daily demand (units/day)
    //   R = review period (days between restocking trips)
    //   L = lead time (days from order to delivery, often 0 for sari-sari)
    //   SS = safety stock = d × safety days (buffer for unexpected demand)
    //
    //   Target Stock (S) = d × (R + L) + SS
    //   Order Quantity (Q) = S − current stock
    //   Days Until Stockout = current stock ÷ d
    //
    // Example:
    //   d = 2 units/day, R = 7 days, L = 0, SS = 0
    //   Target Stock = 2 × (7 + 0) + 0 = 14 units
    //   If current stock = 5, then Order Qty = 14 − 5 = 9 units
    // =====================================================================

    function getProductPrediction(product) {
        // Step 1: Get settings (with defaults)
        const reviewDays = Math.max(1, Number(settings.reviewPeriodDays) || 7);   // R
        const leadDays = Math.max(0, Number(settings.leadTimeDays) || 0);         // L
        const safetyDays = Math.max(0, Number(settings.safetyStockDays) || 0);    // buffer
        
        // Step 2: Calculate daily demand rate
        const dailyRate = calculateDailyDemandRate(product);  // d
        
        // Step 3: Calculate safety stock
        // SS = d × safetyDays
        const safetyStock = dailyRate * safetyDays;
        
        // Step 4: Calculate reorder point (when to trigger restock)
        // ROP = d × L + SS
        const reorderPoint = (dailyRate * leadDays) + safetyStock;
        
        // Step 5: Calculate days until stockout
        // Days = current stock ÷ d
        // Use Math.ceil to be conservative (if 0.5 days, show as 1 day)
        let daysUntilStockout = Infinity;
        if (dailyRate > 0) {
            daysUntilStockout = product.stock === 0 ? 0 : Math.max(1, Math.ceil(product.stock / dailyRate));
        }
        
        // Step 6: Determine if we need to restock
        // Restock if: current stock ≤ ROP, OR will run out before next delivery
        const planningHorizon = reviewDays + leadDays + safetyDays;
        let needsRestock = false;
        if (dailyRate > 0) {
            if (product.stock <= reorderPoint) {
                needsRestock = true;
            } else if (daysUntilStockout <= planningHorizon) {
                needsRestock = true;
            }
        }
        
        // Step 7: Calculate order quantity
        let orderQty = 0;
        if (needsRestock) {
            // Target Stock (S) = d × (R + L) + SS
            const targetStock = (dailyRate * (reviewDays + leadDays)) + safetyStock;
            
            // Order Quantity = Target − Current
            orderQty = targetStock - product.stock;
            
            // Round up (can't order partial units)
            orderQty = Math.ceil(orderQty);
            
            // Can't order negative
            if (orderQty < 0) orderQty = 0;
        }
        
        // Step 8: Apply max stock limit if set
        if (product.maxStock && product.maxStock > 0) {
            const wouldHave = product.stock + orderQty;
            if (wouldHave > product.maxStock) {
                orderQty = product.maxStock - product.stock;
                if (orderQty < 0) orderQty = 0;
            }
        }
        
        // Step 8b: PRACTICAL CAP for sari-sari stores
        // Max order = 2 weeks worth of sales (prevents over-ordering)
        // This addresses real-world constraints: limited capital, storage, spoilage risk
        const maxPracticalOrder = Math.max(5, Math.ceil(dailyRate * 14)); // At least 5, or 2 weeks supply
        if (orderQty > maxPracticalOrder) {
            orderQty = maxPracticalOrder;
        }
        
        // Step 9: Calculate priority score for ranking
        const priorityScore = calculatePriorityScore(product, dailyRate);
        
        // Return all calculated values
        return {
            dailyRate: dailyRate,
            safetyStock: safetyStock,
            reorderPoint: reorderPoint,
            daysUntilStockout: daysUntilStockout,
            recommendedOrderQty: orderQty,
            priorityScore: priorityScore
        };
    }

    // =====================================================================
    // HELPER: GET SALES PER DAY (for trend analysis)
    // =====================================================================
    // Returns an array of daily sale counts for the last N days.
    // Example: [2, 0, 1, 3, 0, 2, 1] means 2 sales today, 0 yesterday, etc.
    // =====================================================================
    function getSalesByDay(productId, days) {
        // Create array of N days, all starting at 0
        const dailyCounts = [];
        for (let i = 0; i < days; i++) {
            dailyCounts.push(0);
        }
        
        // Calculate date boundaries
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        // Go through sales history
        for (let i = 0; i < salesHistory.length; i++) {
            const sale = salesHistory[i];
            if (sale.productId !== productId) continue;
            
            const saleDate = new Date(sale.timestamp);
            const saleMidnight = new Date(saleDate.getFullYear(), saleDate.getMonth(), saleDate.getDate());
            
            // Calculate how many days ago this sale was
            const daysDiff = Math.floor((today - saleMidnight) / (1000 * 60 * 60 * 24));
            
            // If within our range, count it
            if (daysDiff >= 0 && daysDiff < days) {
                dailyCounts[daysDiff] = dailyCounts[daysDiff] + 1;
            }
        }
        
        return dailyCounts;
    }

    // =============================================
    // HELPER FUNCTIONS
    // =============================================

    // Helper: Get days until product expiry
    function getDaysUntilExpiry(expiryDateString) {
        if (!expiryDateString) return Infinity;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const expiry = new Date(expiryDateString);
        return Math.floor((expiry - today) / (1000 * 60 * 60 * 24));
    }

    // =====================================================================
    // FORMALIZED FORECASTING MODULE (Workflow Image 1)
    // =====================================================================
    // Decision Tree:
    //   History < 3 Weeks (21 days)? 
    //     YES → Use Moving Average (simple, reliable with limited data)
    //     NO  → Use Exponential Smoothing (better trend detection)
    //
    // This implements the forecasting decision from the Main Recommendation
    // Algorithm Workflow Design (Image 1)
    // =====================================================================
    function forecastDemand(product, reviewDays = 7) {
        const THREE_WEEKS = 21;  // Threshold from workflow diagram
        const alpha = 0.3; // Smoothing factor for exponential smoothing
        
        // Determine data history length
        const daysActive = getDaysActive(product);
        const salesData = getSalesByDay(product.id, Math.min(daysActive, 30));
        
        // Auto-select method based on history length (Workflow Image 1)
        let useMovingAverage = false;
        if (settings.forecastingMethod === 'auto' || !settings.forecastingMethod) {
            // Automatic selection based on 3-week threshold
            useMovingAverage = daysActive < THREE_WEEKS;
        } else if (settings.forecastingMethod === 'movingAverage') {
            useMovingAverage = true;
        }
        
        if (useMovingAverage) {
            // HISTORY < 3 WEEKS → Use Moving Average
            const total = salesData.reduce((sum, s) => sum + s, 0);
            return Math.round((total / Math.max(1, salesData.length)) * 7); // Weekly forecast
        } else {
            // HISTORY >= 3 WEEKS → Use Exponential Smoothing
            if (salesData.length < 2) {
                return (product.totalSold / Math.max(1, daysActive)) * 7 || 0;
            }
            
            let forecast = salesData[salesData.length - 1]; // Start with oldest
            for (let i = salesData.length - 2; i >= 0; i--) {
                forecast = alpha * salesData[i] + (1 - alpha) * forecast;
            }
            return Math.round(forecast * 7); // Weekly forecast
        }
    }

    function getDaysActive(product) {
        if (product.dateAdded) {
          return Math.max(1, Math.floor((new Date() - new Date(product.dateAdded)) / (1000*60*60*24)));
        }

        // Fallback: infer tracking window from sales history to avoid treating legacy/demo items
        // as "1 day old" (which inflates velocity and priority).
        const now = new Date();
        const oldestSale = salesHistory
          .filter(s => s.productId === product.id)
          .map(s => new Date(s.timestamp))
          .sort((a, b) => a - b)[0];

        if (oldestSale) {
          return Math.max(1, Math.floor((now - oldestSale) / (1000*60*60*24)) + 1);
        }

        return 7; // Assume at least a week of observation if unknown
    }

    // =====================================================================
    // PRIORITY SCORE CALCULATION — SIMPLE MANUAL METHOD
    // =====================================================================
    // Priority score ranks products for restocking. Higher = more important.
    //
    // STEP-BY-STEP:
    //   1. Calculate velocity = how fast it sells (units per day)
    //   2. Calculate margin = profit per sale (as percentage)
    //   3. Calculate turnover = how often stock rotates
    //   4. Combine into score (weighted sum)
    //   5. Apply expiry penalty (deduct points for items near expiry)
    //
    // This uses Period Usage Value (PUV) logic from ABC Analysis.
    // =====================================================================
    function calculatePriorityScore(product, rate = null) {
        // Step 1: Get daily sales rate
        let dailyRate;
        if (rate !== null) {
            dailyRate = rate;
        } else {
            dailyRate = calculateDailyDemandRate(product);
        }
        
        // Step 2: Calculate velocity (units sold per day over tracking period)
        const daysTracked = getDaysActive(product);
        const velocity = product.totalSold / daysTracked;
        
        // Step 3: Calculate profit margin percentage
        // Margin = (Selling Price - Cost Price) / Selling Price × 100
        let marginPercent = 0;
        if (product.sellingPrice > 0) {
            const profit = product.sellingPrice - product.costPrice;
            marginPercent = (profit / product.sellingPrice) * 100;
        }
        
        // Step 4: Calculate turnover ratio
        // Turnover = Total Sold ÷ Current Stock (how often stock rotates)
        const currentStock = Math.max(product.stock, 1);  // Avoid divide by zero
        const turnover = product.totalSold / currentStock;
        
        // Step 5: Calculate expiry penalty
        let expiryPenalty = 0;
        if (product.expiryDate) {
            const daysLeft = getDaysUntilExpiry(product.expiryDate);
            if (daysLeft <= 0) {
                expiryPenalty = -100;  // Already expired
            } else if (daysLeft <= 7) {
                expiryPenalty = -50;   // Expires within 1 week
            } else if (daysLeft <= 30) {
                expiryPenalty = -10;   // Expires within 1 month
            }
        }
        
        // Step 6: Apply category weight
        // Cigarettes get lower priority (store owner policy)
        const category = (product.category || '').toLowerCase();
        let categoryWeight = 1.0;
        if (category === 'cigarettes') {
            categoryWeight = 0.35;
        }
        
        // Step 7: Calculate base score (weighted sum)
        // Velocity × 10 + Margin × 2 + Turnover × 5
        const velocityScore = velocity * 10;
        const marginScore = marginPercent * 2;
        const turnoverScore = turnover * 5;
        const baseScore = velocityScore + marginScore + turnoverScore;
        
        // Step 8: Apply weights and penalties
        const finalScore = (baseScore * categoryWeight) + expiryPenalty;
        
        // Round to 2 decimal places
        return Math.round(finalScore * 100) / 100;
    }

    // 1.3: Get Purchase Reason for Shopping List
    function getPurchaseReason(product) {
      const daysToExpire = product.expiryDate ? getDaysUntilExpiry(product.expiryDate) : Infinity;
      const velocity = product.totalSold / getDaysActive(product);

      if (isFinite(daysToExpire) && daysToExpire <= 7) return "Expires soon";
      if (velocity > 5) return "Fast-moving";
      if (velocity > 2) return "Regular seller";
      if (velocity > 0.5) return "Occasional seller";
      return "Slow-moving";
    }

    // Priority Badge Helper - ABC Classification
    function getPriorityBadge(priorityScore) {
      if (priorityScore > 50) return '<span class="impact-badge impact-high">High impact</span>';
      if (priorityScore > 20) return '<span class="impact-badge impact-med">Medium impact</span>';
      return '<span class="impact-badge impact-low">Low impact</span>';
    }

    // Get ABC Category
    function getABCCategory(priorityScore) {
        if (priorityScore > 50) return 'A';
        if (priorityScore > 20) return 'B';
        return 'C';
    }

    // Trend Arrow Helper - Adaptive Demand Forecasting
    function getTrendArrow(product) {
        const salesData7 = getSalesByDay(product.id, 7);
        const salesData30 = getSalesByDay(product.id, 30);
        
      if (salesData7.length < 3 || salesData30.length < 7) return '<span class="trend-badge stable">Demand steady</span>';
        
        const avg7 = salesData7.reduce((a, b) => a + b, 0) / salesData7.length;
        const avg30 = salesData30.reduce((a, b) => a + b, 0) / salesData30.length;
        
        const changePercent = avg30 > 0 ? ((avg7 - avg30) / avg30) * 100 : 0;
        
        if (changePercent > 15) return '<span class="trend-badge up">Demand rising</span>';
        if (changePercent < -15) return '<span class="trend-badge down">Demand dropping</span>';
        return '<span class="trend-badge stable">Demand steady</span>';
    }

    function svgToDataUri(svg) {
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    }

    // =====================================================================
    // CATEGORY ICON MAPPING
    // =====================================================================
    // Maps product categories to icons in "icons_list of items" folder
    // Icons are styled to match the Retro Soft Design theme
    // =====================================================================
    const CATEGORY_ICONS = {
      'beverages': 'icons_list of items/snacks.png',  // Using snacks for beverages (closest match)
      'noodles': 'icons_list of items/Noodles.png',
      'snacks': 'icons_list of items/snacks.png',
      'canned': 'icons_list of items/canned goods.png',
      'coffee': 'icons_list of items/coffee & tea.png',
      'dairy': 'icons_list of items/Dairy & Eggs.png',
      'condiments': 'icons_list of items/condiments.png',
      'personal': 'icons_list of items/personal care.png',
      'firstaid': 'icons_list of items/first aid.png',
      'household': 'icons_list of items/household.png',
      'candy': 'icons_list of items/candy & sweets.png',
      'cigarettes': 'icons_list of items/cigarettes.png',
      'other': null  // Will use fallback SVG
    };

    function getProductThumbSrc(product) {
      const name = (product?.name || '').toLowerCase();
      const category = (product?.category || '').toLowerCase();

      // Check if we have a category icon available
      const categoryIcon = CATEGORY_ICONS[category];
      if (categoryIcon) {
        return categoryIcon;
      }

      // Fallback: Simple inline SVG thumbnails for unknown categories
      // Styled to match the Retro Soft Design theme
      return svgToDataUri(`
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
          <rect width="64" height="64" rx="12" fill="#F0F2F5"/>
          <rect x="16" y="16" width="32" height="32" rx="8" fill="#FCFCFD" stroke="#D2D8E0" stroke-width="2"/>
          <circle cx="32" cy="32" r="8" fill="#5A7FBF" opacity="0.2"/>
          <circle cx="32" cy="32" r="4" fill="#5A7FBF"/>
        </svg>
      `);
    }

    // Expiry Badge Helper
    function getExpiryBadge(daysLeft) {
        if (!isFinite(daysLeft)) return '';
        if (daysLeft <= 0) return '<span class="expiry-badge expiry-urgent">❌ Expired</span>';
      if (daysLeft <= 7) return '<span class="expiry-badge expiry-urgent">Expires in ' + daysLeft + ' day' + (daysLeft === 1 ? '' : 's') + '</span>';
      if (daysLeft <= 30) return '<span class="expiry-badge expiry-warning">Expires in ' + daysLeft + ' days</span>';
      return '<span class="expiry-badge expiry-fresh">OK expiry</span>';
    }

    // 3.2: Generate Expiry Alerts
    function generateExpiryAlerts() {
        const expiryAlerts = [];
        
        inventory.forEach(product => {
            if (!product.expiryDate) return;
            
            const daysLeft = getDaysUntilExpiry(product.expiryDate);
            
            if (daysLeft <= 0) {
                expiryAlerts.push({
                    severity: 'urgent',
                    productName: product.name,
                    stock: product.stock,
                    daysLeft: daysLeft,
                    action: 'Expired',
                    colorClass: 'alert-urgent',
                    productId: product.id
                });
            } else if (daysLeft <= 7) {
                expiryAlerts.push({
                    severity: 'urgent',
                    productName: product.name,
                    stock: product.stock,
                    daysLeft: daysLeft,
                    action: `${daysLeft} day${daysLeft === 1 ? '' : 's'} until expiry`,
                    colorClass: 'alert-urgent',
                    productId: product.id
                });
            } else if (daysLeft <= 30) {
                expiryAlerts.push({
                    severity: 'warning',
                    productName: product.name,
                    stock: product.stock,
                    daysLeft: daysLeft,
                    action: `${daysLeft} days until expiry`,
                    colorClass: 'alert-warning',
                    productId: product.id
                });
            }
        });
        
        // Sort by urgency (most urgent first)
        expiryAlerts.sort((a, b) => a.daysLeft - b.daysLeft);
        
        // Render expiry alerts
        const section = document.getElementById('expiryAlertsSection');
        const list = document.getElementById('expiryAlertsList');
        
        if (expiryAlerts.length > 0) {
            section.style.display = 'block';
            list.innerHTML = expiryAlerts.slice(0, 5).map(alert => `
                <div class="expiry-alert-item ${alert.colorClass}">
                    <div class="alert-icon">${alert.daysLeft <= 0 ? '❌' : alert.daysLeft <= 7 ? '🚨' : '⚠️'}</div>
                    <div class="alert-content">
                        <div class="alert-product">${alert.productName}</div>
                        <div class="alert-details">${alert.stock} in stock • ${alert.action}</div>
                    </div>
                </div>
            `).join('');
        } else {
            section.style.display = 'none';
        }
        
        return expiryAlerts;
    }

    // 2.1: New Product Evaluator (Decision Analysis)
    function evaluateNewProduct(productData, scenarios) {
        const margin = productData.sellingPrice - productData.costPrice;
        const initialInvestment = productData.initialQty * productData.costPrice;
        
        const results = scenarios.map(scenario => {
            const unitsSold = Math.min(scenario.demand, productData.initialQty);
            const revenue = unitsSold * productData.sellingPrice;
            const unsold = productData.initialQty - unitsSold;
            const unsoldLoss = unsold * productData.costPrice * 0.5; // Assume 50% loss on unsold
            const profit = revenue - initialInvestment - unsoldLoss;
            const weightedProfit = profit * scenario.probability;
            
            return {
                scenario: scenario.label,
                demand: scenario.demand,
                probability: scenario.probability,
                unitsSold: unitsSold,
                profit: profit,
                weightedProfit: weightedProfit
            };
        });
        
        // Calculate Expected Value
        const expectedValue = results.reduce((sum, r) => sum + r.weightedProfit, 0);
        
        // Calculate Risk (Standard Deviation)
        const variance = results.reduce((sum, r) => {
            return sum + Math.pow(r.profit - expectedValue, 2) * r.probability;
        }, 0);
        const stdDev = Math.sqrt(variance);
        
        // Make Recommendation
        let recommendation, riskLevel, recClass;
        if (expectedValue > 100 && stdDev < 300) {
            recommendation = "✅ STOCK IT - Good profit potential with manageable risk";
            riskLevel = "Low Risk";
            recClass = "positive";
        } else if (expectedValue > 0) {
            recommendation = "⚠️ STOCK SMALL QUANTITY - Positive EV but uncertain";
            riskLevel = "Medium Risk";
            recClass = "caution";
        } else {
            recommendation = "❌ SKIP - Negative expected value";
            riskLevel = "High Risk";
            recClass = "negative";
        }
        
        return {
            productName: productData.name,
            expectedValue: expectedValue,
            standardDeviation: stdDev,
            riskLevel: riskLevel,
            recommendation: recommendation,
            recClass: recClass,
            scenarioDetails: results,
            initialInvestment: initialInvestment
        };
    }

    // Check for Historical Data based on category or similar products
    function checkHistoricalData() {
        const category = document.getElementById('evalCategory').value;
        const productName = document.getElementById('evalProductName').value.trim().toLowerCase();
        const historicalNotice = document.getElementById('historicalDataNotice');
        const noHistoricalNotice = document.getElementById('noHistoricalDataNotice');
        
        if (!category && !productName) {
            historicalNotice.style.display = 'none';
            noHistoricalNotice.style.display = 'block';
            return;
        }
        
        // Find similar products in inventory
        let similarProducts = inventory.filter(item => {
            const nameMatch = productName && item.name.toLowerCase().includes(productName);
            const categoryMatch = category && item.category === category;
            return nameMatch || categoryMatch;
        });
        
        if (similarProducts.length === 0) {
            historicalNotice.style.display = 'none';
            noHistoricalNotice.style.display = 'block';
            return;
        }
        
        // Calculate average demand from similar products' sales history
        let totalDemandData = [];
        similarProducts.forEach(product => {
            if (product.salesHistory && product.salesHistory.length > 0) {
                totalDemandData = totalDemandData.concat(product.salesHistory);
            }
        });
        
        if (totalDemandData.length < 3) {
            // Not enough historical data
            historicalNotice.style.display = 'none';
            noHistoricalNotice.style.display = 'block';
            noHistoricalNotice.innerHTML = `<i class="ti ti-alert-circle"></i> <strong>Limited historical data.</strong> Found ${similarProducts.length} similar product(s) but need more sales history. Enter your own estimates below.`;
            return;
        }
        
        // Calculate demand scenarios from historical data
        const avgDemand = totalDemandData.reduce((a, b) => a + b, 0) / totalDemandData.length;
        const maxDemand = Math.max(...totalDemandData);
        const minDemand = Math.min(...totalDemandData);
        
        // Calculate rough probability distribution
        const highDemandThreshold = avgDemand * 1.5;
        const lowDemandThreshold = avgDemand * 0.5;
        
        let highCount = 0, medCount = 0, lowCount = 0;
        totalDemandData.forEach(d => {
            if (d >= highDemandThreshold) highCount++;
            else if (d <= lowDemandThreshold) lowCount++;
            else medCount++;
        });
        
        const total = totalDemandData.length;
        const highProb = Math.round((highCount / total) * 100) || 15;
        const medProb = Math.round((medCount / total) * 100) || 60;
        const lowProb = Math.round((lowCount / total) * 100) || 25;
        
        // Pre-fill the form
        document.getElementById('evalHighDemand').value = Math.round(maxDemand);
        document.getElementById('evalHighProb').value = highProb;
        document.getElementById('evalMedDemand').value = Math.round(avgDemand);
        document.getElementById('evalMedProb').value = medProb;
        document.getElementById('evalLowDemand').value = Math.round(minDemand);
        document.getElementById('evalLowProb').value = lowProb;
        
        // Calculate average prices from similar products for suggestion
        const avgCost = similarProducts.reduce((a, b) => a + b.costPrice, 0) / similarProducts.length;
        const avgSelling = similarProducts.reduce((a, b) => a + b.sellingPrice, 0) / similarProducts.length;
        
        if (!document.getElementById('evalCostPrice').value) {
            document.getElementById('evalCostPrice').value = Math.round(avgCost);
        }
        if (!document.getElementById('evalSellingPrice').value) {
            document.getElementById('evalSellingPrice').value = Math.round(avgSelling);
        }
        
        // Update notices
        historicalNotice.style.display = 'block';
        noHistoricalNotice.style.display = 'none';
        historicalNotice.innerHTML = `<i class="ti ti-database"></i> <strong>Historical data available!</strong> Analyzed ${totalDemandData.length} sales records from ${similarProducts.length} similar product(s). Demand scenarios pre-filled.`;
    }

    // Run New Product Evaluation from UI
    function runNewProductEvaluation() {
        const name = document.getElementById('evalProductName').value.trim();
        const initialQty = parseInt(document.getElementById('evalInitialQty').value) || 20;
        const costPrice = parseFloat(document.getElementById('evalCostPrice').value);
        const sellingPrice = parseFloat(document.getElementById('evalSellingPrice').value);
        
        const highDemand = parseInt(document.getElementById('evalHighDemand').value) || 50;
        const highProb = (parseInt(document.getElementById('evalHighProb').value) || 20) / 100;
        const medDemand = parseInt(document.getElementById('evalMedDemand').value) || 20;
        const medProb = (parseInt(document.getElementById('evalMedProb').value) || 60) / 100;
        const lowDemand = parseInt(document.getElementById('evalLowDemand').value) || 5;
        const lowProb = (parseInt(document.getElementById('evalLowProb').value) || 20) / 100;
        
        if (!name || isNaN(costPrice) || isNaN(sellingPrice)) {
            alert('Please fill in product name, cost price, and selling price.');
            return;
        }
        
        // Normalize probabilities
        const totalProb = highProb + medProb + lowProb;
        const scenarios = [
            { label: "High Demand", demand: highDemand, probability: highProb / totalProb },
            { label: "Medium Demand", demand: medDemand, probability: medProb / totalProb },
            { label: "Low Demand", demand: lowDemand, probability: lowProb / totalProb }
        ];
        
        const result = evaluateNewProduct({ name, initialQty, costPrice, sellingPrice }, scenarios);
        
        // Display result
        const resultDiv = document.getElementById('newProductResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="decision-result">
                <div class="decision-result-header">${result.productName} - Analysis</div>
                <div class="decision-metric">
                    <span class="decision-metric-label">Initial Investment:</span>
                    <span class="decision-metric-value">${formatPHP.format(result.initialInvestment)}</span>
                </div>
                <div class="decision-metric">
                    <span class="decision-metric-label">Expected Value:</span>
                    <span class="decision-metric-value">${formatPHP.format(result.expectedValue)}</span>
                </div>
                <div class="decision-metric">
                    <span class="decision-metric-label">Risk (Std Dev):</span>
                    <span class="decision-metric-value">${formatPHP.format(result.standardDeviation)}</span>
                </div>
                <div class="decision-metric">
                    <span class="decision-metric-label">Risk Level:</span>
                    <span class="decision-metric-value">${result.riskLevel}</span>
                </div>
                
                <table class="payoff-table">
                    <tr><th>Scenario</th><th>Demand</th><th>Prob</th><th>Profit</th></tr>
                    ${result.scenarioDetails.map(s => `
                        <tr>
                            <td>${s.scenario}</td>
                            <td>${s.demand}</td>
                            <td>${(s.probability * 100).toFixed(0)}%</td>
                            <td>${formatPHP.format(s.profit)}</td>
                        </tr>
                    `).join('')}
                </table>
                
                <div class="decision-recommendation ${result.recClass}">
                    ${result.recommendation}
                </div>
            </div>
        `;
    }

    // 2.2: Markdown Decision Analyzer
    function evaluateMarkdownDecision(product) {
        const daysLeft = getDaysUntilExpiry(product.expiryDate);
        const currentStock = product.stock;
        const costPrice = product.costPrice;
        const sellingPrice = product.sellingPrice;
        
        // Define scenarios based on days left
        let scenarios;
        if (daysLeft <= 7) {
            scenarios = [
                { action: "Markdown 50% Now", discountPercent: 0.5, expectedSalesRate: 0.8, probability: 0.5 },
                { action: "Markdown 30% Now", discountPercent: 0.3, expectedSalesRate: 0.5, probability: 0.3 },
                { action: "No Markdown (Risk Loss)", discountPercent: 0, expectedSalesRate: 0.1, probability: 0.2 }
            ];
        } else {
            scenarios = [
                { action: "Markdown 30% Now", discountPercent: 0.3, expectedSalesRate: 0.7, probability: 0.5 },
                { action: "Markdown 20% Now", discountPercent: 0.2, expectedSalesRate: 0.5, probability: 0.3 },
                { action: "Wait & Monitor", discountPercent: 0, expectedSalesRate: 0.3, probability: 0.2 }
            ];
        }
        
        const results = scenarios.map(scenario => {
            const discountedPrice = sellingPrice * (1 - scenario.discountPercent);
            const expectedSales = Math.round(currentStock * scenario.expectedSalesRate);
            const revenue = expectedSales * discountedPrice;
            const unsold = currentStock - expectedSales;
            const totalCost = currentStock * costPrice;
            const netResult = revenue - totalCost;
            const weightedResult = netResult * scenario.probability;
            
            return {
                action: scenario.action,
                discountPercent: (scenario.discountPercent * 100).toFixed(0) + '%',
                expectedSales: expectedSales,
                unsold: unsold,
                revenue: revenue,
                netResult: netResult,
                weightedResult: weightedResult
            };
        });
        
        const expectedValue = results.reduce((sum, r) => sum + r.weightedResult, 0);
        const bestAction = results.reduce((best, r) => r.weightedResult > best.weightedResult ? r : best);
        
        return {
            productName: product.name,
            productId: product.id,
            daysUntilExpiry: daysLeft,
            currentStock: currentStock,
            recommendation: bestAction.action,
            expectedValue: expectedValue,
            scenarios: results
        };
    }

    // Update Markdown Analyzer Section
    // DISABLED: Markdown/discount strategies are not applicable to sari-sari stores
    function updateMarkdownAnalyzer() {
        // Sari-sari stores typically don't do markdowns - they sell at regular price
        // or consume near-expiry items themselves. This feature is disabled.
        const section = document.getElementById('markdownAnalyzerSection');
        if (section) section.style.display = 'none';
        return;
    }

    // =============================================
    // END ENHANCED ALGORITHMS
    // =============================================

    // --- REVISED ALERTS LOGIC ---
    function generateIntelligentAlerts() {
      alerts = [];
      inventory.forEach(product => {
        const prediction = getProductPrediction(product);

        if (product.stock === 0) {
          alerts.push({ type: 'danger', title: 'Out of Stock', message: `${product.name} is out of stock. Prioritized on your Smart Shopping List.` });
        } else if (product.stock <= prediction.reorderPoint && prediction.dailyRate > 0) {
          const daysSupplyText = isFinite(prediction.daysUntilStockout) ? `~${prediction.daysUntilStockout} days left` : 'running low';
          alerts.push({ type: 'warning', title: 'Low Stock', message: `${product.name}: ${product.stock} units left (${daysSupplyText}). Check Smart Shopping List.` });
        } else if (prediction.dailyRate > 5 && isFinite(prediction.daysUntilStockout) && prediction.daysUntilStockout < 7) {
          alerts.push({ type: 'info', title: 'Fast Seller', message: `${product.name} is selling fast (~${prediction.dailyRate.toFixed(1)}/day). Monitor stock levels.` });
        }
      });
      const alertsContainer = document.getElementById('alertsContainer');
      alertsContainer.innerHTML = alerts.slice(0,3).map(a => `
        <div class="alert-box">
          <div class="alert-title">${a.title}</div>
          <div class="alert-message">${a.message}</div>
        </div>
      `).join('');
    }


    // =====================================================================
    // CATEGORY ICONS - Using custom icons from "icons_list of items" folder
    // =====================================================================
    // Icons display as small images in category headers, matching Retro Soft theme
    // Falls back to Tabler webfont icons if image not available
    // =====================================================================
    function getCategoryIcon(category) {
      const imageIcons = {
        beverages: 'icons_list of items/snacks.png',
        noodles: 'icons_list of items/Noodles.png',
        snacks: 'icons_list of items/snacks.png',
        canned: 'icons_list of items/canned goods.png',
        coffee: 'icons_list of items/coffee & tea.png',
        dairy: 'icons_list of items/Dairy & Eggs.png',
        condiments: 'icons_list of items/condiments.png',
        personal: 'icons_list of items/personal care.png',
        firstaid: 'icons_list of items/first aid.png',
        household: 'icons_list of items/household.png',
        candy: 'icons_list of items/candy & sweets.png',
        cigarettes: 'icons_list of items/cigarettes.png',
        other: null
      };
      
      const iconSrc = imageIcons[category];
      if (iconSrc) {
        return `<img src="${iconSrc}" alt="${category}" class="category-icon" style="width:18px;height:18px;vertical-align:middle;margin-right:4px;border-radius:4px;object-fit:contain;">`;
      }
      
      // Fallback to Tabler icons
      const tablerIcons = {
        beverages: '<i class="ti ti-bottle"></i>',
        noodles: '<i class="ti ti-noodles"></i>',
        snacks: '<i class="ti ti-cookie"></i>',
        canned: '<i class="ti ti-box"></i>',
        coffee: '<i class="ti ti-coffee"></i>',
        dairy: '<i class="ti ti-milk"></i>',
        condiments: '<i class="ti ti-salt"></i>',
        personal: '<i class="ti ti-hand-soap"></i>',
        firstaid: '<i class="ti ti-first-aid-kit"></i>',
        household: '<i class="ti ti-broom"></i>',
        candy: '<i class="ti ti-candy"></i>',
        cigarettes: '<i class="ti ti-smoking"></i>',
        other: '<i class="ti ti-package"></i>'
      };
      return tablerIcons[category] || tablerIcons.other;
    }

    // Filters and search
    let currentCategoryFilter = 'all';
    let currentSearchTerm = '';
    let inventoryCategoryState = {};

    function filterByCategory(e, category) {
      currentCategoryFilter = category;
      document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
      e.target.closest('.filter-chip').classList.add('active');
      loadInventory();
    }
    
    function searchProducts() {
      currentSearchTerm = document.getElementById('productSearch').value;
      if (!currentSearchTerm) {
        currentCategoryFilter = 'all';
        document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
        document.querySelector('.filter-chip').classList.add('active');
      }
      loadInventory();
    }

    function toggleInventoryCategory(category) {
      inventoryCategoryState[category] = !inventoryCategoryState[category];
      const itemsEl = document.getElementById(`inventoryCategory-${category}`);
      const chevronEl = document.getElementById(`inventoryCategoryChevron-${category}`);
      if (itemsEl) itemsEl.classList.toggle('collapsed', inventoryCategoryState[category]);
      if (chevronEl) chevronEl.classList.toggle('collapsed', inventoryCategoryState[category]);
    }

    // Inventory list
    function loadInventory() {
      const productList = document.getElementById('productList');

      if (inventory.length === 0) {
        productList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"><i class="ti ti-package"></i></div>
            <p>No products yet. Add your first item!</p>
          </div>
        `;
        return;
      }

      let filtered = [...inventory];
      if (currentCategoryFilter !== 'all') filtered = filtered.filter(p => p.category === currentCategoryFilter);
      if (currentSearchTerm) filtered = filtered.filter(p => p.name.toLowerCase().includes(currentSearchTerm.toLowerCase()));
      if (filtered.length === 0) {
        productList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"><i class="ti ti-search"></i></div>
            <p>No products found. Try a different search or category.</p>
          </div>
        `;
        return;
      }

      const grouped = {};
      filtered.forEach(p => { const c = p.category || 'other'; if (!grouped[c]) grouped[c] = []; grouped[c].push(p); });
      Object.keys(grouped).forEach(c => {
        grouped[c].sort((a,b) => {
          const daysA = getProductPrediction(a).daysUntilStockout;
          const daysB = getProductPrediction(b).daysUntilStockout;
          return daysA - daysB;
        });
      });

      const order = ['beverages','noodles','snacks','canned','coffee','dairy','condiments','personal','firstaid','household','candy','cigarettes','other'];
      let html = '';
      order.forEach(category => {
        if (grouped[category] && grouped[category].length > 0) {
          const icon = getCategoryIcon(category);
          const name = category.charAt(0).toUpperCase() + category.slice(1);
          const isCollapsed = inventoryCategoryState[category] === true;
          html += `
            <div class="inventory-category" data-category="${category}">
              <div class="inventory-category-header" onclick="toggleInventoryCategory('${category}')">
                <div class="inventory-category-left">${icon} ${name}</div>
                <div class="inventory-category-right">
                  <span class="category-count">${grouped[category].length} items</span>
                  <i id="inventoryCategoryChevron-${category}" class="ti ti-chevron-down inventory-category-chevron ${isCollapsed ? 'collapsed' : ''}"></i>
                </div>
              </div>
              <div id="inventoryCategory-${category}" class="inventory-category-items ${isCollapsed ? 'collapsed' : ''}">
          `;
          grouped[category].forEach(product => {
            const marginPct = product.costPrice > 0 ? ((product.sellingPrice - product.costPrice) / product.costPrice * 100) : 0;
            const profitMargin = marginPct.toFixed(1);
            let profitClass = 'profit-high';
            if (marginPct < 20) profitClass = 'profit-low';
            else if (marginPct < 40) profitClass = 'profit-medium';
            
            const prediction = getProductPrediction(product);
            const stockWarningIcon = product.stock <= prediction.reorderPoint && prediction.dailyRate > 0 ? '<i class="ti ti-alert-triangle" style="color: #718096;"></i>' : '';
            const daysLeft = isFinite(prediction.daysUntilStockout) ? `Stock lasts ~${prediction.daysUntilStockout} day${prediction.daysUntilStockout === 1 ? '' : 's'}` : 'Not enough sales data yet';
            const trendArrow = getTrendArrow(product);
            const predictionText = (prediction.dailyRate > 0.01) ? `Estimated sold: ${prediction.dailyRate.toFixed(1)}/day • ${daysLeft} ${trendArrow}` : 'Not enough sales data yet';
            
            // Priority badge (ABC Classification)
            const priorityBadge = getPriorityBadge(prediction.priorityScore);
            
            // Expiry badge for product list
            const expiryDaysLeft = product.expiryDate ? getDaysUntilExpiry(product.expiryDate) : Infinity;
            const expiryBadgeHtml = product.expiryDate ? getExpiryBadge(expiryDaysLeft) : '';
            
            // Urgency color coding for days until stockout
            const urgencyColor = prediction.daysUntilStockout <= 3 ? '#4A5568' : (prediction.daysUntilStockout <= 7 ? '#718096' : '#A0AEC0');
            
            let actionButton;
            if (manageModeActive) {
                actionButton = `<button class="btn-action btn-edit" onclick="openEditModal(${product.id})" aria-label="Edit ${product.name}">
                    <i class="ti ti-pencil"></i> EDIT
                </button>`;
            } else {
                const actionLabel = isTransactionActive() ? 'ADD' : 'SELL';
                actionButton = `<button class="btn-action btn-sell" onclick="onProductAction(${product.id})" aria-label="${actionLabel} ${product.name}">
                    <i class="ti ti-shopping-cart-plus"></i> ${actionLabel}
                </button>`;
            }

            const thumbSrc = getProductThumbSrc(product);
            html += `
              <div class="product-item" style="border-left: 3px solid var(--chip-border);">
                <div class="product-info">
                  <div style="display:flex; gap:12px; align-items:flex-start;">
                    <img class="item-thumb" src="${thumbSrc}" alt="${product.name}">
                    <div style="flex:1; min-width:0;">
                      <div class="product-name">
                        ${stockWarningIcon} ${product.name} ${priorityBadge}
                        ${expiryBadgeHtml}
                      </div>
                      <div class="product-details">
                        Buy: ${formatPHP.format(product.costPrice)} | Sell: ${formatPHP.format(product.sellingPrice)} | Sold: ${product.totalSold}
                      </div>
                      ${predictionText ? `<div class="product-prediction">${predictionText}</div>` : ''}
                    </div>
                  </div>
                </div>
                <div class="product-actions">
                  <span class="stock-count" title="On hand">${product.stock}</span>
                  ${actionButton}
                </div>
              </div>
            `;
          });
          html += `
              </div>
            </div>
          `;
        }
      });
      productList.innerHTML = html;

      // Bind tap feedback to newly inserted buttons
      enableTapFeedback('.btn-action');
    }

    // Product Actions (Sell, Edit, etc)
    function onProductAction(productId) {
      if (manageModeActive) {
        openEditModal(productId);
      } else if (isTransactionActive()) {
        addToCart(productId);
      } else {
        sellProduct(productId);
      }
    }
    function sellProduct(productId) {
      const product = inventory.find(p => p.id === productId);
      if (product && product.stock > 0) {
        product.stock--; product.totalSold++; product.lastSold = new Date().toISOString();
        const sale = {
          productId, productName: product.name,
          sellingPrice: product.sellingPrice, costPrice: product.costPrice,
          profit: product.sellingPrice - product.costPrice,
          timestamp: new Date().toISOString()
        };
        salesHistory.push(sale);
        logActivity('sale', `Sold 1 ${product.name} for ${formatPHP.format(product.sellingPrice)}.`, { name: product.name, amount: product.sellingPrice });
        saveData();
        loadInventory();
        updateStats();
        generateIntelligentAlerts();
        showFeedback(`Sold 1 ${product.name} for ${formatPHP.format(product.sellingPrice)}`);
      } else {
        showFeedback(`No stock for ${product ? product.name : 'item'}`);
      }
    }
    
    // Manage Inventory Mode
    function toggleManageMode() {
        manageModeActive = !manageModeActive;
        const manageBtn = document.getElementById('manageInventoryBtn');
        const saleBtn = document.getElementById('startSaleBtn');
        
        if (manageModeActive) {
            manageBtn.innerHTML = '<i class="ti ti-check"></i> Done';
            manageBtn.classList.add('btn-primary');
            manageBtn.classList.remove('btn-secondary');
            saleBtn.style.display = 'none';
        } else {
            manageBtn.innerHTML = '<i class="ti ti-edit"></i> Manage';
            manageBtn.classList.remove('btn-primary');
            manageBtn.classList.add('btn-secondary');
            saleBtn.style.display = 'inline-flex';
        }
        loadInventory(); // Redraw the product list with the correct buttons
    }

    // Edit Product Modal
    function openEditModal(productId) {
        const product = inventory.find(p => p.id === productId);
        if (!product) return;
        document.getElementById('editProductId').value = product.id;
        document.getElementById('editProductName').value = product.name;
        document.getElementById('editCostPrice').value = product.costPrice;
        document.getElementById('editSellingPrice').value = product.sellingPrice;
        document.getElementById('editStock').value = product.stock;
        document.getElementById('editMaxStock').value = product.maxStock || '';
        document.getElementById('editExpiryDate').value = product.expiryDate || '';
        document.getElementById('editIsEssential').checked = product.isEssential || false;
        document.getElementById('editProductModal').classList.add('show');
    }

    function closeEditModal() {
        document.getElementById('editProductModal').classList.remove('show');
    }

    function saveProductChanges() {
        const id = parseInt(document.getElementById('editProductId').value);
        const product = inventory.find(p => p.id === id);
        if (!product) return;

        const oldStock = product.stock;
        const newStock = parseInt(document.getElementById('editStock').value);

        product.name = document.getElementById('editProductName').value.trim();
        product.costPrice = parseFloat(document.getElementById('editCostPrice').value);
        product.sellingPrice = parseFloat(document.getElementById('editSellingPrice').value);
        product.stock = newStock;
        const maxStock = parseInt(document.getElementById('editMaxStock').value);
        product.maxStock = isNaN(maxStock) || maxStock <= 0 ? null : maxStock;
        const expiryDate = document.getElementById('editExpiryDate').value;
        product.expiryDate = expiryDate || null;
        product.isEssential = document.getElementById('editIsEssential').checked;

        if (!product.name || isNaN(product.costPrice) || isNaN(product.sellingPrice) || isNaN(product.stock)) {
            alert('Please fill all fields with valid values.');
            return;
        }

        if (oldStock !== newStock) {
            logActivity('update', `Updated stock for '${product.name}' from ${oldStock} to ${newStock}.`, { name: product.name, oldStock, newStock });
        }

        saveData();
        loadInventory();
        updateStats();
        generateExpiryAlerts();
        updateMarkdownAnalyzer();
        closeEditModal();
        showFeedback(`${product.name} updated.`);
    }

    function deleteProduct() {
        const id = parseInt(document.getElementById('editProductId').value);
        const product = inventory.find(p => p.id === id);
        if (!product) return;

        if (confirm(`Are you sure you want to delete ${product.name}? This action cannot be undone.`)) {
            inventory = inventory.filter(p => p.id !== id);
            logActivity('delete', `Deleted product '${product.name}'.`);
            saveData();
            loadInventory();
            updateStats();
            closeEditModal();
            showFeedback(`${product.name} deleted.`);
        }
    }

    // POS state and functions
    function isTransactionActive() { return currentTransaction !== null; }

    // POS: Start/Cancel/Cart UI
    function startTransaction() {
      if (currentTransaction || manageModeActive) return;
      currentTransaction = { id: Date.now(), createdAt: new Date().toISOString(), items: [] };
      document.getElementById('cartBar').classList.remove('cart-hidden');
      document.body.classList.add('cart-active');
      document.getElementById('startSaleBtn').style.display = 'none';
      document.getElementById('manageInventoryBtn').style.display = 'none';
      document.getElementById('cancelSaleBtn').style.display = 'inline-flex';
      cartExpanded = true;
      renderCart();
      loadInventory();
      showFeedback('New sale started. Tap items to add.');
    }
    function cancelTransaction() {
      if (!currentTransaction) return;
      if (currentTransaction.items.length > 0 && !confirm('Cancel current sale?')) return;
      
      currentTransaction = null;
      document.getElementById('cartBar').classList.add('cart-hidden');
      document.body.classList.remove('cart-active');
      document.getElementById('startSaleBtn').style.display = 'inline-flex';
      document.getElementById('manageInventoryBtn').style.display = 'inline-flex';
      document.getElementById('cancelSaleBtn').style.display = 'none';
      loadInventory();
    }
    function toggleCartExpand() {
      cartExpanded = !cartExpanded;
      document.getElementById('cartItemsList').classList.toggle('show', cartExpanded);
    }

    function getCartLine(productId) { if (!currentTransaction) return null; return currentTransaction.items.find(l => l.productId === productId) || null; }
    function addToCart(productId) {
      const product = inventory.find(p => p.id === productId);
      if (!product) return;
      if (!currentTransaction) startTransaction();
      const line = getCartLine(productId);
      const inCartQty = line ? line.qty : 0;
      if (product.stock <= inCartQty) { showFeedback(`Not enough stock for ${product.name}`); return; }
      if (line) line.qty += 1;
      else currentTransaction.items.push({ productId: product.id, name: product.name, price: product.sellingPrice, costPrice: product.costPrice, qty: 1 });
      renderCart();
    }
    function changeCartQty(productId, delta) {
      if (!currentTransaction) return;
      const product = inventory.find(p => p.id === productId);
      const line = getCartLine(productId);
      if (!line || !product) return;
      if (delta > 0) {
        if (line.qty + delta > product.stock) { showFeedback(`Max stock reached for ${product.name}`); return; }
        line.qty += delta;
      } else {
        line.qty += delta;
        if (line.qty <= 0) currentTransaction.items = currentTransaction.items.filter(l => l.productId !== productId);
      }
      renderCart();
    }
    function renderCart() {
      const list = document.getElementById('cartItemsList');
      const countEl = document.getElementById('cartItemsCount');
      const totalEl = document.getElementById('cartTotal');

      if (!currentTransaction || currentTransaction.items.length === 0) {
        list.innerHTML = `<div class="cart-line"><div class="cart-name">No items yet. Tap products to add.</div></div>`;
        countEl.textContent = '0';
        totalEl.textContent = formatPHP.format(0);
        if (cartExpanded) document.getElementById('cartItemsList').classList.add('show');
        return;
      }

      list.innerHTML = currentTransaction.items.map(l => {
        const lineTotal = l.qty * l.price;
        return `
          <div class="cart-line">
            <div>
              <div class="cart-name">${l.name}</div>
              <div class="cart-meta">${formatPHP.format(l.price)} •
                <span class="qty-controls">
                  <button class="qty-btn" onclick="changeCartQty(${l.productId}, -1)" aria-label="Decrease ${l.name}">−</button>
                  <span class="qty">${l.qty}</span>
                  <button class="qty-btn" onclick="changeCartQty(${l.productId}, 1)" aria-label="Increase ${l.name}">+</button>
                </span>
              </div>
            </div>
            <div class="line-total">${formatPHP.format(lineTotal)}</div>
          </div>
        `;
      }).join('');

      const totalItems = currentTransaction.items.reduce((s,l) => s + l.qty, 0);
      const totalAmount = currentTransaction.items.reduce((s,l) => s + l.qty * l.price, 0);
      countEl.textContent = String(totalItems);
      totalEl.textContent = formatPHP.format(totalAmount);
    }
    function finalizeTransaction(isCredit = false) {
      if (!currentTransaction || currentTransaction.items.length === 0) { alert('No items in sale.'); return; }
      
      let customerName = null;
      if (isCredit) {
          customerName = prompt("Enter customer's name for this credit transaction:");
          if (!customerName || customerName.trim() === '') {
              alert("Customer name is required for a credit transaction.");
              return;
          }
          customerName = customerName.trim();
      }

      for (const l of currentTransaction.items) {
        const p = inventory.find(x => x.id === l.productId);
        if (!p || p.stock < l.qty) { alert(`Insufficient stock for ${l.name}.`); return; }
      }
      const nowIso = new Date().toISOString();
      const totalAmount = currentTransaction.items.reduce((s,l) => s + l.qty * l.price, 0);
      const totalCost = currentTransaction.items.reduce((s,l) => s + l.qty * l.costPrice, 0);
      const totalProfit = totalAmount - totalCost;
      const totalItems = currentTransaction.items.reduce((s,l) => s + l.qty, 0);

      // Deduct stock for all transaction types
      for (const l of currentTransaction.items) {
        const p = inventory.find(x => x.id === l.productId);
        p.stock -= l.qty; p.totalSold += l.qty; p.lastSold = nowIso;
      }

      if (isCredit) {
        creditAccounts.push({
            id: currentTransaction.id,
            customerName: customerName,
            items: currentTransaction.items,
            totalAmount,
            totalProfit,
            timestamp: nowIso,
            status: 'unpaid'
        });
        logActivity('credit_add', `Created credit for '${customerName}' worth ${formatPHP.format(totalAmount)}.`, { customerName, totalAmount });
        showFeedback(`Credit for ${customerName} recorded: ${formatPHP.format(totalAmount)}`);
      } else {
        // Record paid transaction
        transactions.push({
            id: currentTransaction.id, timestamp: nowIso,
            items: currentTransaction.items.map(l => ({ productId: l.productId, name: l.name, qty: l.qty, price: l.price })),
            totalRevenue: totalAmount, totalProfit
        });
        // Record individual sales for analytics
        for (const l of currentTransaction.items) {
            for (let i = 0; i < l.qty; i++) {
                salesHistory.push({
                    transactionId: currentTransaction.id, productId: l.productId, productName: l.name,
                    sellingPrice: l.price, costPrice: l.costPrice, profit: l.price - l.costPrice,
                    timestamp: nowIso
                });
            }
        }
        logActivity('sale', `Completed cash sale of ${totalItems} items for ${formatPHP.format(totalAmount)}.`, { totalItems, totalAmount });
        showFeedback(`Sale completed: ${formatPHP.format(totalAmount)}`);
      }

      saveData();
      
      currentTransaction = null;
      document.getElementById('cartBar').classList.add('cart-hidden');
      document.body.classList.remove('cart-active');
      document.getElementById('startSaleBtn').style.display = 'inline-flex';
      document.getElementById('manageInventoryBtn').style.display = 'inline-flex';
      document.getElementById('cancelSaleBtn').style.display = 'none';

      loadInventory(); updateStats(); generateIntelligentAlerts(); generateInsights(); drawSalesChart(); loadCreditTab();
    }
    
    // Credit Tab functions
    function loadCreditTab() {
        const creditListContainer = document.getElementById('creditList');
        let unpaidAccounts = creditAccounts.filter(acc => acc.status === 'unpaid');
        
        // Update total outstanding display
        const totalOutstanding = unpaidAccounts.reduce((sum, acc) => sum + acc.totalAmount, 0);
        const totalEl = document.getElementById('totalCreditOutstanding');
        if (totalEl) totalEl.textContent = totalOutstanding.toFixed(2);
        
        // Update account count
        const countEl = document.getElementById('creditAccountCount');
        if (countEl) countEl.textContent = unpaidAccounts.length;

        // Sort based on current mode
        if (creditSortMode === 'amount') {
            unpaidAccounts.sort((a, b) => b.totalAmount - a.totalAmount);
        } else if (creditSortMode === 'age') {
            unpaidAccounts.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // Oldest first
        } else {
            unpaidAccounts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Newest first
        }

        if (unpaidAccounts.length === 0) {
            creditListContainer.innerHTML = `<div class="empty-state">
                <div class="empty-state-icon"><i class="ti ti-notebook"></i></div>
                <p>No outstanding credit accounts. Great!</p>
            </div>`;
            return;
        }

        creditListContainer.innerHTML = unpaidAccounts.map(acc => {
            const date = new Date(acc.timestamp);
            const agingClass = getCreditAgingClass(acc.timestamp);
            const ageBadge = getCreditAgeBadge(acc.timestamp);
            // Compact items: join with comma, max 3 shown
            const itemsPreview = acc.items.slice(0, 3).map(item => `<span>${item.qty}x</span> ${item.name}`).join(', ');
            const moreItems = acc.items.length > 3 ? ` +${acc.items.length - 3} more` : '';
            return `
            <div class="credit-card ${agingClass}">
                <div class="credit-header">
                    <div class="credit-name">${acc.customerName} ${ageBadge}</div>
                    <div class="credit-total">${formatPHP.format(acc.totalAmount)}</div>
                </div>
                <div class="credit-date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                <div class="credit-items-list">${itemsPreview}${moreItems}</div>
                <div class="credit-actions">
                    <button class="btn-primary" onclick="markCreditAsPaid(${acc.id})">Mark Paid</button>
                </div>
            </div>
            `;
        }).join('');
        enableTapFeedback('.btn-primary');
    }

    function markCreditAsPaid(accountId) {
        const account = creditAccounts.find(acc => acc.id === accountId);
        if (!account) return;

        if (confirm(`Mark ${account.customerName}'s debt of ${formatPHP.format(account.totalAmount)} as paid?`)) {
            account.status = 'paid';
            account.paidTimestamp = new Date().toISOString();

            // REALIZED REVENUE: Now add to transactions and sales history
            transactions.push({
                id: account.id, timestamp: account.paidTimestamp,
                items: account.items.map(l => ({ productId: l.productId, name: l.name, qty: l.qty, price: l.price })),
                totalRevenue: account.totalAmount, totalProfit: account.totalProfit,
                notes: `Paid off credit from ${new Date(account.timestamp).toLocaleDateString()}`
            });
            for (const l of account.items) {
                for (let i = 0; i < l.qty; i++) {
                    salesHistory.push({
                        transactionId: account.id, productId: l.productId, productName: l.name,
                        sellingPrice: l.price, costPrice: l.costPrice, profit: l.price - l.costPrice,
                        timestamp: account.paidTimestamp
                    });
                }
            }
            logActivity('credit_paid', `Marked credit for '${account.customerName}' as paid (${formatPHP.format(account.totalAmount)}).`, { customerName: account.customerName, totalAmount: account.totalAmount });
            saveData();
            loadCreditTab();
            updateStats();
            showFeedback('Credit marked as paid.');
        }
    }

    // Credit Sorting
    function sortCreditBy(mode) {
        creditSortMode = mode;
        loadCreditTab();
    }

    function getCreditAgingClass(timestamp) {
        const now = new Date();
        const created = new Date(timestamp);
        const daysDiff = Math.floor((now - created) / (1000 * 60 * 60 * 24));
        
        if (daysDiff > 30) return 'credit-overdue';
        if (daysDiff > 7) return 'credit-aging';
        return 'credit-recent';
    }

    function getCreditAgeBadge(timestamp) {
        const now = new Date();
        const created = new Date(timestamp);
        const daysDiff = Math.floor((now - created) / (1000 * 60 * 60 * 24));
        
        if (daysDiff > 30) return `<span class="credit-age-badge credit-age-overdue">${daysDiff} days</span>`;
        if (daysDiff > 7) return `<span class="credit-age-badge credit-age-aging">${daysDiff} days</span>`;
        return `<span class="credit-age-badge credit-age-recent">${daysDiff} days</span>`;
    }

    // --- PERSONAL WITHDRAWAL FUNCTIONS ---
    function openWithdrawalModal() {
        const select = document.getElementById('withdrawalProduct');
        select.innerHTML = '<option value="">-- Select Product --</option>' + 
            inventory.filter(p => p.stock > 0).map(p => 
                `<option value="${p.id}" data-cost="${p.costPrice}">${p.name} (Stock: ${p.stock})</option>`
            ).join('');
        document.getElementById('withdrawalModal').classList.add('active');
    }

    function closeWithdrawalModal(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('withdrawalModal').classList.remove('active');
        }
    }

    function saveWithdrawal() {
        const productId = parseInt(document.getElementById('withdrawalProduct').value);
        const qty = parseInt(document.getElementById('withdrawalQty').value) || 1;
        const purpose = document.getElementById('withdrawalPurpose').value;
        const notes = document.getElementById('withdrawalNotes').value.trim();

        if (!productId) {
            alert('Please select a product.');
            return;
        }

        const product = inventory.find(p => p.id === productId);
        if (!product) return;

        if (qty > product.stock) {
            alert(`Only ${product.stock} units available.`);
            return;
        }

        // Reduce stock
        product.stock -= qty;
        const costValue = qty * product.costPrice;

        // Record withdrawal
        personalWithdrawals.push({
            id: Date.now(),
            timestamp: new Date().toISOString(),
            productId: product.id,
            productName: product.name,
            quantity: qty,
            costPrice: product.costPrice,
            totalCost: costValue,
            purpose: purpose,
            notes: notes
        });

        logActivity('withdrawal', `Withdrew ${qty}x ${product.name} for ${purpose} (₱${costValue.toFixed(2)})`, { productName: product.name, qty, purpose });
        saveData();
        loadInventory();
        updateDashboard();
        closeWithdrawalModal();
        showFeedback(`Withdrawal recorded: ${qty}x ${product.name}`);
    }

    function updateWithdrawalsDisplay() {
        const now = new Date();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        
        const monthlyWithdrawals = personalWithdrawals.filter(w => new Date(w.timestamp) >= monthStart);
        const totalValue = monthlyWithdrawals.reduce((sum, w) => sum + w.totalCost, 0);
        
        const valueEl = document.getElementById('totalWithdrawalValue');
        if (valueEl) valueEl.textContent = totalValue.toFixed(2);
        
        const listEl = document.getElementById('withdrawalsList');
        if (listEl) {
            if (monthlyWithdrawals.length === 0) {
                listEl.innerHTML = '<div style="font-size: 0.7em; color: var(--muted); text-align: center; padding: 8px;">No withdrawals this month</div>';
            } else {
                // Group by purpose
                const grouped = {};
                monthlyWithdrawals.forEach(w => {
                    if (!grouped[w.purpose]) {
                        grouped[w.purpose] = { value: 0, count: 0 };
                    }
                    grouped[w.purpose].value += w.totalCost;
                    grouped[w.purpose].count += w.quantity;
                });
                
                // Purpose icons
                const purposeIcons = {
                    'personal': 'ti-user',
                    'household': 'ti-home',
                    'gift': 'ti-gift',
                    'family': 'ti-users',
                    'other': 'ti-dots'
                };
                
                listEl.innerHTML = Object.entries(grouped).map(([purpose, data]) => {
                    const icon = purposeIcons[purpose] || 'ti-package';
                    const label = purpose.charAt(0).toUpperCase() + purpose.slice(1);
                    return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: var(--bg); border-radius: 4px; margin-top: 4px;">
                        <span style="font-size: 0.72em; color: var(--text-secondary); display: flex; align-items: center; gap: 5px;">
                            <i class="ti ${icon}" style="font-size: 1.1em;"></i> ${label}
                            <span style="color: var(--muted);">(${data.count})</span>
                        </span>
                        <span style="font-size: 0.75em; font-weight: 600; color: var(--text);">₱${data.value.toFixed(0)}</span>
                    </div>`;
                }).join('');
            }
        }
    }

    // --- OPPORTUNITY LOSS FUNCTIONS ---
    function openLostSaleModal() {
        const datalist = document.getElementById('productSuggestions');
        datalist.innerHTML = inventory.map(p => `<option value="${p.name}">`).join('');
        document.getElementById('lostSaleModal').classList.add('active');
    }

    function closeLostSaleModal(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('lostSaleModal').classList.remove('active');
            document.getElementById('lostSaleProduct').value = '';
            document.getElementById('lostSaleQty').value = '1';
            document.getElementById('lostSalePrice').value = '';
        }
    }

    function saveLostSale() {
        const productName = document.getElementById('lostSaleProduct').value.trim();
        const qty = parseInt(document.getElementById('lostSaleQty').value) || 1;
        const price = parseFloat(document.getElementById('lostSalePrice').value);

        if (!productName) {
            alert('Please enter a product name.');
            return;
        }
        if (isNaN(price) || price <= 0) {
            alert('Please enter a valid selling price.');
            return;
        }

        const lostRevenue = qty * price;

        opportunityLosses.push({
            id: Date.now(),
            timestamp: new Date().toISOString(),
            productName: productName,
            quantity: qty,
            sellingPrice: price,
            lostRevenue: lostRevenue
        });

        logActivity('lost_sale', `Lost sale: ${qty}x ${productName} (₱${lostRevenue.toFixed(2)} lost)`, { productName, qty, lostRevenue });
        saveData();
        updateOpportunityLossDisplay();
        closeLostSaleModal();
        showFeedback(`Lost sale recorded: ₱${lostRevenue.toFixed(2)}`);
    }

    function updateOpportunityLossDisplay() {
        const now = new Date();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        
        const monthlyLosses = opportunityLosses.filter(l => new Date(l.timestamp) >= monthStart);
        const totalLoss = monthlyLosses.reduce((sum, l) => sum + l.lostRevenue, 0);
        
        const totalEl = document.getElementById('totalOpportunityLoss');
        if (totalEl) totalEl.textContent = totalLoss.toFixed(2);
        
        // Group by product and create bar chart
        const byProduct = {};
        monthlyLosses.forEach(l => {
            if (!byProduct[l.productName]) byProduct[l.productName] = 0;
            byProduct[l.productName] += l.lostRevenue;
        });
        
        const sorted = Object.entries(byProduct).sort((a, b) => b[1] - a[1]).slice(0, 5);
        const maxLoss = sorted.length > 0 ? sorted[0][1] : 1;
        
        const chartEl = document.getElementById('opportunityLossChart');
        if (chartEl) {
            if (sorted.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; color: var(--muted); font-size: 0.68em; padding: 6px;">No lost sales recorded</div>';
            } else {
                chartEl.innerHTML = sorted.map(([name, loss]) => {
                    const width = (loss / maxLoss) * 100;
                    return `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                        <span style="font-size: 0.68em; color: var(--text-secondary); min-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${name}">${name}</span>
                        <div style="flex: 1; height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${width}%; background: var(--primary); border-radius: 3px;"></div>
                        </div>
                        <span style="font-size: 0.65em; color: var(--muted); min-width: 45px; text-align: right;">₱${loss.toFixed(0)}</span>
                    </div>`;
                }).join('');
            }
        }
    }

    // --- ACTIVITY LOG ---
    function logActivity(type, message, details = {}) {
        activityLog.unshift({
            timestamp: new Date().toISOString(),
            type, // 'sale', 'add', 'update', 'credit_add', 'credit_paid', 'delete', 'withdrawal', 'lost_sale'
            message,
            details
        });
        if (activityLog.length > 200) { // Keep log from getting too big
            activityLog.pop();
        }
    }

    function loadHistoryTab() {
        const container = document.getElementById('activityLogList');
        if (activityLog.length === 0) {
            container.innerHTML = `<div class="empty-state">
                <div class="empty-state-icon"><i class="ti ti-history"></i></div>
                <p>No activity recorded yet. Start selling or adding products!</p>
            </div>`;
            return;
        }

        container.innerHTML = activityLog.map(log => {
            const icons = {
                sale: 'ti-cash',
                add: 'ti-package',
                update: 'ti-edit',
                credit_add: 'ti-notebook',
                credit_paid: 'ti-receipt-2',
                delete: 'ti-trash'
            };
            const icon = icons[log.type] || 'ti-file-info';
            const iconClass = `log-icon-${log.type}`;

            return `
            <div class="log-item">
                <div class="log-icon ${iconClass}">
                    <i class="ti ${icon}"></i>
                </div>
                <div>
                    <div class="log-message">${log.message}</div>
                    <div class="log-timestamp">${formatRelativeTime(log.timestamp)}</div>
                </div>
            </div>
            `;
        }).join('');
    }

    function formatRelativeTime(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diff = now - date;
        const diffSeconds = Math.floor(diff / 1000);
        const diffMinutes = Math.floor(diffSeconds / 60);
        const diffHours = Math.floor(diffMinutes / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffSeconds < 60) return 'Just now';
        if (diffMinutes < 60) return `${diffMinutes}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString(navigator.language || 'en-US');
    }

    // Stats and Insights
    function updateStats() {
      // =====================================================================
      // HEADER KPIs — Aligned with Operational Challenges
      // =====================================================================
      // 1. Low Stock Count - Items below reorder point (#4: Stockout timing)
      // 2. Konsumo - Personal withdrawals this month (#3: Business/personal separation)
      // 3. Today's Profit - Daily profit tracking (#1: Capital, #3: Separation)
      // 4. Restock Budget - Capital needed for restocking (#1: Capital shortage)
      // =====================================================================
      
      // --- KPI 1: Low Stock Count ---
      // Count items that need restocking (stock ≤ reorder point)
      let lowStockCount = 0;
      for (let i = 0; i < inventory.length; i++) {
        const product = inventory[i];
        const prediction = getProductPrediction(product);
        if (prediction.dailyRate > 0 && product.stock <= prediction.reorderPoint) {
          lowStockCount = lowStockCount + 1;
        }
      }
      const lowStockEl = document.getElementById('lowStockCount');
      if (lowStockEl) lowStockEl.textContent = lowStockCount;
      
      // Update card styling based on urgency
      const lowStockCard = document.getElementById('lowStockCard');
      if (lowStockCard) {
        lowStockCard.className = 'stat-card ' + (lowStockCount > 5 ? 'alert' : lowStockCount > 0 ? 'warning' : 'success');
      }
      
      // --- KPI 2: Personal Consumption (Personal Withdrawals This Month) ---
      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      let konsumoTotal = 0;
      for (let i = 0; i < personalWithdrawals.length; i++) {
        const w = personalWithdrawals[i];
        if (new Date(w.timestamp) >= monthStart) {
          konsumoTotal = konsumoTotal + w.totalCost;
        }
      }
      const konsumoEl = document.getElementById('konsumoValue');
      if (konsumoEl) konsumoEl.textContent = konsumoTotal.toFixed(0);
      
      // --- KPI 3: Today's Profit ---
      const today = new Date().toDateString();
      let todayProfit = 0;
      for (let i = 0; i < salesHistory.length; i++) {
        const sale = salesHistory[i];
        if (new Date(sale.timestamp).toDateString() === today) {
          todayProfit = todayProfit + sale.profit;
        }
      }
      const profitEl = document.getElementById('todayProfit');
      if (profitEl) profitEl.textContent = todayProfit.toFixed(0);
      
      // --- KPI 4: Restock Need (Budgeted Plan) ---
      // This should reflect the budget-constrained shopping plan, not the full "ideal" restock.
      // If budget is ₱3000, this KPI will show ≤ ₱3000 (unless budget is 0).
      const plan = generateShoppingList({ render: false });
      const restockPlanCost = plan && typeof plan.totalCost === 'number' ? plan.totalCost : 0;
      const restockEl = document.getElementById('restockBudget');
      if (restockEl) restockEl.textContent = restockPlanCost.toFixed(0);
      
      // --- Legacy stats (for other parts of the app) ---
      const totalProductsEl = document.getElementById('totalProducts');
      if (totalProductsEl) totalProductsEl.textContent = inventory.length;
      
      const settingsTotalEl = document.getElementById('settingsTotalProducts');
      if (settingsTotalEl) settingsTotalEl.textContent = inventory.length;
      
      // Today's sales (still used elsewhere)
      let todaySalesTotal = 0;
      for (let i = 0; i < salesHistory.length; i++) {
        const sale = salesHistory[i];
        if (new Date(sale.timestamp).toDateString() === today) {
          todaySalesTotal = todaySalesTotal + sale.sellingPrice;
        }
      }
      const salesEl = document.getElementById('todaySales');
      if (salesEl) salesEl.textContent = todaySalesTotal.toFixed(2);
      
      // Update credit stats
      let totalCredit = 0;
      let unpaidCount = 0;
      for (let i = 0; i < creditAccounts.length; i++) {
        const acc = creditAccounts[i];
        if (acc.status === 'unpaid') {
          totalCredit = totalCredit + acc.totalAmount;
          unpaidCount = unpaidCount + 1;
        }
      }
      const creditEl = document.getElementById('outstandingCredit');
      if (creditEl) creditEl.textContent = totalCredit.toFixed(2);
      const creditCountEl = document.getElementById('outstandingCreditCount');
      if (creditCountEl) creditCountEl.textContent = unpaidCount;
    }

    function updateDashboard() {
      const inventoryValue = inventory.reduce((sum, p) => sum + (p.stock * p.costPrice), 0);
      document.getElementById('inventoryValue').textContent = inventoryValue.toFixed(2);

      // Cash Available KPI (Workflow Image 2: Cash-on-Hand Report)
      // Shows the user's entered cash on hand, or inventory value as estimate
      const userCashOnHand = Number(settings.cashOnHand) || 0;
      const estimatedCash = inventoryValue; // Fallback if no cash entered
      const cashAvailable = userCashOnHand > 0 ? userCashOnHand : estimatedCash;
      
      const cashEl = document.getElementById('cashAvailable');
      if (cashEl) {
        cashEl.textContent = cashAvailable.toFixed(0);
        // Show indicator if using estimated vs actual cash
        if (userCashOnHand <= 0) {
          cashEl.title = 'Estimated from inventory value. Update Cash on Hand in Settings for accurate tracking.';
          cashEl.style.opacity = '0.7';
        } else {
          cashEl.title = 'Based on your Cash on Hand entry';
          cashEl.style.opacity = '1';
        }
      }

      // 7-Day metrics for internal calculations
      const now = new Date();
      const sevenDaysAgo = new Date(now.getTime() - 7*24*60*60*1000);
      const recentSales = salesHistory.filter(s => new Date(s.timestamp) >= sevenDaysAgo);

      const profitByProduct = {};
      inventory.forEach(p => {
        const productSales = salesHistory.filter(s => s.productId === p.id);
        const totalProfit = productSales.reduce((sum, s) => sum + s.profit, 0);
        if (totalProfit > 0) profitByProduct[p.name] = totalProfit;
      });
      const sortedByProfit = Object.entries(profitByProduct).sort((a,b) => b[1] - a[1]);
      if (sortedByProfit.length > 0) {
        const [name, profit] = sortedByProfit[0];
        document.getElementById('mostProfitable').textContent = name;
        document.getElementById('profitableAmount').textContent = `${formatPHP.format(profit)} profit`;
      } else {
        document.getElementById('mostProfitable').textContent = '--';
        document.getElementById('profitableAmount').textContent = 'No sales yet';
      }

      // Busiest Day calculation (reuses now and sevenDaysAgo from above)
      const salesByDay = {};
      const formatter = new Intl.DateTimeFormat(navigator.language || 'en', { weekday: 'long' });
      salesHistory.forEach(s => {
        const d = new Date(s.timestamp);
        if (d >= sevenDaysAgo) {
          const dayName = formatter.format(d);
          salesByDay[dayName] = (salesByDay[dayName] || 0) + 1;
        }
      });
      const sortedDays = Object.entries(salesByDay).sort((a,b) => b[1]-a[1]);
      if (sortedDays.length > 0) {
        const [busiestDay, count] = sortedDays[0];
        document.getElementById('busiestDay').textContent = busiestDay;
        document.getElementById('busiestSales').textContent = `${count} sales`;
      } else {
        document.getElementById('busiestDay').textContent = '--';
        document.getElementById('busiestSales').textContent = 'No sales this week';
      }

      // Update Action Items section
      updateLowStockAlerts();
      updateCreditCollections();
      updateWithdrawalsDisplay();
      updateOpportunityLossDisplay();
    }

    // Low Stock Alerts for Action Items section
    function updateLowStockAlerts() {
      const lowStockItems = inventory.filter(p => {
        const pred = getProductPrediction(p);
        return pred.dailyRate > 0 && p.stock <= pred.reorderPoint;
      }).sort((a, b) => {
        const daysA = getProductPrediction(a).daysUntilStockout;
        const daysB = getProductPrediction(b).daysUntilStockout;
        return daysA - daysB;
      }).slice(0, 5);

      const container = document.getElementById('lowStockAlertsList');
      if (!container) return;

      if (lowStockItems.length === 0) {
        container.innerHTML = '<span style="color: #4A5568;"><i class="ti ti-check"></i> All items are sufficiently stocked.</span>';
      } else {
        container.innerHTML = lowStockItems.map(p => {
          const pred = getProductPrediction(p);
          const urgencyColor = pred.daysUntilStockout <= 3 ? '#4A5568' : '#718096';
          const daysText = pred.daysUntilStockout <= 1 ? 'Critical - restock now' : `~${pred.daysUntilStockout} days left`;
          const badge = getPriorityBadge(pred.priorityScore);
          const dailyRate = pred.dailyRate.toFixed(1);
          const forecastBasis = pred.dailyRate > 0 ? `Based on ${dailyRate}/day avg sales` : 'Based on low stock';
          return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f1f5f9;">
            <div>
              <strong>${p.name}</strong> ${badge}<br>
              <small style="color: ${urgencyColor};">Stock: ${p.stock} • ${daysText}</small><br>
              <small style="color: #A0AEC0; font-size: 0.85em;">${forecastBasis}</small>
            </div>
            <span style="font-weight: 600; color: ${urgencyColor};">${pred.daysUntilStockout}d</span>
          </div>`;
        }).join('');
      }
    }

    // Credit Collections for Action Items section  
    function updateCreditCollections() {
      const overdueCredits = creditAccounts.filter(acc => {
        if (acc.status !== 'unpaid') return false;
        const daysDiff = Math.floor((new Date() - new Date(acc.timestamp)) / (1000 * 60 * 60 * 24));
        return daysDiff > 7; // Show credits older than 1 week
      }).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)).slice(0, 3);

      const container = document.getElementById('creditCollectionsList');
      if (!container) return;

      if (overdueCredits.length === 0) {
        container.innerHTML = '<span style="color: var(--muted); font-size: 0.75em;"><i class="ti ti-check"></i> No overdue accounts</span>';
      } else {
        container.innerHTML = overdueCredits.map(acc => {
          const daysDiff = Math.floor((new Date() - new Date(acc.timestamp)) / (1000 * 60 * 60 * 24));
          return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #E4E8ED; font-size: 0.75em;">
            <div>
              <span style="font-weight: 600; color: var(--text);">${acc.customerName}</span><br>
              <span style="color: var(--muted); font-size: 0.9em;">${daysDiff} days</span>
            </div>
            <span style="font-weight: 600; color: var(--text-secondary);">${formatPHP.format(acc.totalAmount)}</span>
          </div>`;
        }).join('');
      }
    }

    function drawSalesChart() {
      const chartContainer = document.getElementById('salesChart');
      const now = new Date(); const dailyData = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date(now.getTime() - i*24*60*60*1000);
        const dayStart = new Date(date.setHours(0,0,0,0));
        const dayEnd = new Date(date.setHours(23,59,59,999));
        const daySales = salesHistory.filter(s => {
          const d = new Date(s.timestamp);
          return d >= dayStart && d <= dayEnd;
        });
        const revenue = daySales.reduce((sum, s) => sum + s.sellingPrice, 0);
        const profit = daySales.reduce((sum, s) => sum + s.profit, 0);
        dailyData.push({ day: dayStart.toLocaleDateString(navigator.language || 'en', { weekday: 'short' }), revenue, profit });
      }
      const maxValue = Math.max(...dailyData.map(d => Math.max(d.revenue, d.profit)), 1);
      chartContainer.innerHTML = dailyData.map(data => `
        <div class="bar-group">
          <div style="display: flex; gap: 2px; align-items: flex-end; height: 80px;">
            <div class="bar" style="height: ${(data.revenue / maxValue * 70)}px; background: var(--primary); width: 12px;">
              ${data.revenue > 0 ? `<div class="bar-value">${formatPHP.format(data.revenue)}</div>` : ''}
            </div>
            <div class="bar" style="height: ${(data.profit / maxValue * 70)}px; background: #A0AEC0; width: 12px;"></div>
          </div>
          <div class="bar-label">${data.day}</div>
        </div>
      `).join('');
    }

    // =====================================================================
    // HELPER: Calculate Recent Withdrawals for Budget Deduction
    // =====================================================================
    // Returns total value of withdrawals in the current review period
    // This implements: Effective Budget = Cash - Planned Withdrawals (Workflow Image 2)
    // =====================================================================
    function getRecentWithdrawalsTotal() {
      const reviewDays = Math.max(1, Number(settings.reviewPeriodDays) || 7);
      const now = new Date();
      const cutoffDate = new Date(now.getTime() - (reviewDays * 24 * 60 * 60 * 1000));
      
      let total = 0;
      for (let i = 0; i < personalWithdrawals.length; i++) {
        const w = personalWithdrawals[i];
        if (new Date(w.timestamp) >= cutoffDate) {
          total += w.totalCost;
        }
      }
      return total;
    }

    // =====================================================================
    // HELPER: Check if product is marked as Essential
    // =====================================================================
    // Essential items are prioritized in budget allocation (Workflow Image 1)
    // Essential = items marked by user OR Class A items with high demand
    // =====================================================================
    function isEssentialProduct(product) {
      // User-marked essential
      if (product.isEssential === true) return true;
      
      // Auto-detect essential: high-velocity staples in key categories
      const essentialCategories = ['dairy', 'noodles', 'canned', 'condiments'];
      const category = (product.category || '').toLowerCase();
      const dailyRate = calculateDailyDemandRate(product);
      
      // High-velocity items (>2 units/day) in essential categories are auto-essential
      if (essentialCategories.includes(category) && dailyRate >= 2) {
        return true;
      }
      
      return false;
    }

    // =====================================================================
    // BUDGET-CONSTRAINED CAPITAL ALLOCATION (Bounded Knapsack Problem)
    // =====================================================================
    // This function solves a multi-constraint optimization problem:
    //
    // OBJECTIVE (Maximize):
    //   Total value of restocked items, where value = f(urgency, profit contribution)
    //
    // CONSTRAINTS:
    //   1. Budget constraint:  Σ (q_i × c_i) ≤ B   (total spend ≤ budget)
    //   2. Space constraint:   Σ (q_i × s_i) ≤ S   (total space ≤ storage capacity)
    //   3. Demand constraint:  q_i ≤ Q_i          (don't overbuy beyond recommended qty)
    //   4. Diversification:    spend_i ≤ 0.5 × B  (no single SKU dominates budget)
    //
    // where:
    //   q_i = quantity to purchase for item i
    //   c_i = unit cost of item i
    //   s_i = storage space per unit of item i
    //   Q_i = recommended order quantity from periodic review model
    //   B   = total available budget
    //   S   = total storage capacity
    //
    // SOLUTION METHOD: Greedy heuristic with multi-pass diversification
    //   Pass 1: Buy 1 unit of each high-urgency item (diversify)
    //   Pass 2: Top-up remaining quantities respecting per-item spend cap
    //   Pass 3: Fallback allocation if budget remains unused
    //
    // This is a practical approximation to the NP-hard Bounded Knapsack Problem.
    // Reference: Kellerer, H., Pferschy, U., Pisinger, D. (2004). Knapsack Problems.
    // Reference: Dantzig, G.B. (1957). Discrete-Variable Extremum Problems.
    // =====================================================================
    function generateShoppingList(options = {}) {
      const render = !(options && options.render === false);
        // Step 1: Identify candidate items that need restocking (Q_i > 0)
        const candidates = inventory
          .map(p => ({ product: p, prediction: getProductPrediction(p) }))
          .filter(item => item.prediction.recommendedOrderQty > 0)
          .filter(item => !recentlyRestockedIds.has(item.product.id))
            // Sort by urgency (days until stockout), then by value score
            .sort((a, b) => {
              const daysA = isFinite(a.prediction.daysUntilStockout) ? a.prediction.daysUntilStockout : Number.POSITIVE_INFINITY;
              const daysB = isFinite(b.prediction.daysUntilStockout) ? b.prediction.daysUntilStockout : Number.POSITIVE_INFINITY;
              if (daysA !== daysB) return daysA - daysB;  // Urgency first
              return b.prediction.priorityScore - a.prediction.priorityScore;  // Then value
            });

        // Step 2: Initialize constraints
        const shoppingList = [];
        
        // =====================================================================
        // BUDGET SOURCE (Workflow Image 2: Cash-on-Hand Report)
        // Priority: 1) Cash on Hand (if entered), 2) Max Shopping Budget setting
        // The effective budget = min(cash available, max budget cap)
        // =====================================================================
        const cashOnHand = Number(settings.cashOnHand) || 0;
        const maxBudgetCap = Number(settings.shoppingBudget) || 5000;
        
        // Use cash on hand if available, otherwise fall back to max budget
        const rawBudget = cashOnHand > 0 ? Math.min(cashOnHand, maxBudgetCap) : maxBudgetCap;
        
        // =====================================================================
        // EFFECTIVE BUDGET CALCULATION (Workflow Image 2)
        // Effective Purchasing Budget = Cash - Planned Withdrawals
        // This ensures household/personal consumption doesn't eat into restock capital
        // =====================================================================
        const plannedWithdrawal = Number(settings.plannedWithdrawal) || 0;
        const recentWithdrawals = settings.deductWithdrawalsFromBudget ? getRecentWithdrawalsTotal() : 0;
        const totalDeductions = Math.max(plannedWithdrawal, recentWithdrawals); // Use higher of planned or actual
        const effectiveBudget = Math.max(0, rawBudget - totalDeductions);
        const totalBudget = effectiveBudget;  // B = effective budget constraint
        let remainingBudget = totalBudget;
        
        // Track budget breakdown for display
        const budgetBreakdown = {
          cashOnHand: cashOnHand,
          maxBudgetCap: maxBudgetCap,
          rawBudget: rawBudget,
          plannedWithdrawal: plannedWithdrawal,
          recentWithdrawals: recentWithdrawals,
          totalDeductions: totalDeductions,
          effectiveBudget: effectiveBudget,
          usingActualCash: cashOnHand > 0
        };
        let remainingSpace = settings.storageCapacity || Infinity;  // S = space constraint
        let needCount = candidates.length;
        const qtyByProductId = new Map();    // Track q_i for each item
        const spendByProductId = new Map();  // Track spend_i for diversification constraint
        const wantedQtyByProductId = new Map();  // Track requested qty for underfunded detection
        const underfundedItems = [];  // Items that couldn't get minimum quantity
        const essentialItems = [];    // Essential/Class-A items for priority allocation
        const maxSpendSharePerItem = 0.20;    // Diversification: max 20% of budget per SKU
        const maxSpendPerItem = totalBudget * maxSpendSharePerItem; // Always enforce, never Infinity
        
        // PRACTICAL CAP: Max units per item (prevents absurd quantities)
        const maxUnitsPerItem = 12; // No single item should exceed 12 units per restock

        function addPurchase(candidate, qty) {
          const { product, prediction } = candidate;
          const unitCost = product.costPrice;
          const unitSpace = (CATEGORY_SIZES[product.category] || 3);
          
          // Apply practical max units cap
          const existingQty = qtyByProductId.get(product.id) || 0;
          const remainingAllowed = maxUnitsPerItem - existingQty;
          const safeQty = Math.max(0, Math.min(Math.floor(qty), remainingAllowed));
          if (safeQty <= 0) return;

          qtyByProductId.set(product.id, existingQty + safeQty);

          const existingSpend = spendByProductId.get(product.id) || 0;
          spendByProductId.set(product.id, existingSpend + (safeQty * unitCost));

          const existingItem = shoppingList.find(i => i.product.id === product.id);
          if (existingItem) {
            existingItem.finalOrderQty += safeQty;
          } else {
            const reason = getPurchaseReason(product);
            const priorityScore = prediction.priorityScore;
            shoppingList.push({
              product,
              finalOrderQty: safeQty,
              unitCost,
              unitSpace,
              prediction,
              reason,
              priorityScore
            });
          }

          remainingBudget -= safeQty * unitCost;
          remainingSpace -= safeQty * unitSpace;
        }

        function getMaxBuyableQty(candidate, wantRemaining, spendCapRemaining) {
          const { product } = candidate;
          const unitCost = product.costPrice;
          const unitSpace = (CATEGORY_SIZES[product.category] || 3);
          if (wantRemaining <= 0) return 0;
          if (unitCost <= 0) return 0;
          if (remainingBudget <= 0) return 0;
          if (remainingSpace <= 0) return 0;

          // Check max units cap
          const existingQty = qtyByProductId.get(product.id) || 0;
          const unitsRemaining = maxUnitsPerItem - existingQty;
          if (unitsRemaining <= 0) return 0;

          const budgetCap = Math.min(remainingBudget, spendCapRemaining);
          const maxByBudget = Math.floor(budgetCap / unitCost);
          const maxBySpace = unitSpace > 0 ? Math.floor(remainingSpace / unitSpace) : wantRemaining;
          return Math.max(0, Math.min(wantRemaining, maxByBudget, maxBySpace, unitsRemaining));
        }

        // =====================================================================
        // Pass 0: ESSENTIAL ITEMS — Service Safety Allocation (Workflow Image 1)
        // Fund Essential/A-items to minimum level FIRST before other allocation
        // =====================================================================
        const essentialCandidates = candidates.filter(c => isEssentialProduct(c.product));
        const nonEssentialCandidates = candidates.filter(c => !isEssentialProduct(c.product));
        
        // Track wanted quantities for underfunded detection
        for (const candidate of candidates) {
          wantedQtyByProductId.set(candidate.product.id, candidate.prediction.recommendedOrderQty);
        }
        
        // Allocate to essential items first (at least 1 unit each)
        for (const candidate of essentialCandidates) {
          if (remainingBudget < 1) break;
          const want = candidate.prediction.recommendedOrderQty;
          const already = qtyByProductId.get(candidate.product.id) || 0;
          const wantRemaining = want - already;
          const spent = spendByProductId.get(candidate.product.id) || 0;
          const capRemaining = Math.max(0, maxSpendPerItem - spent);
          
          // Try to allocate minimum quantity (at least 1, ideally 2 for essential)
          const minEssentialQty = Math.min(2, wantRemaining);
          const canBuy = getMaxBuyableQty(candidate, minEssentialQty, capRemaining);
          if (canBuy > 0) {
            addPurchase(candidate, canBuy);
            essentialItems.push({ product: candidate.product, funded: canBuy, wanted: want });
          }
        }
        
        // Pass 1: diversify — try to buy 1 unit of as many high-urgency items as possible
        for (const candidate of candidates) {
          if (remainingBudget < 1) break;
          const want = candidate.prediction.recommendedOrderQty;
          const already = qtyByProductId.get(candidate.product.id) || 0;
          const wantRemaining = want - already;
          const spent = spendByProductId.get(candidate.product.id) || 0;
          const capRemaining = Math.max(0, maxSpendPerItem - spent);

          const canBuy = getMaxBuyableQty(candidate, Math.min(1, wantRemaining), capRemaining);
          if (canBuy > 0) addPurchase(candidate, canBuy);
        }

        // Pass 2: top-up — fill remaining recommended quantities, still respecting per-item spend cap
        for (const candidate of candidates) {
          if (remainingBudget < 1) break;
          const want = candidate.prediction.recommendedOrderQty;
          const already = qtyByProductId.get(candidate.product.id) || 0;
          const wantRemaining = want - already;
          const spent = spendByProductId.get(candidate.product.id) || 0;
          const capRemaining = Math.max(0, maxSpendPerItem - spent);

          const canBuy = getMaxBuyableQty(candidate, wantRemaining, capRemaining);
          if (canBuy > 0) addPurchase(candidate, canBuy);
        }

        // Pass 2 done - shoppingList now has balanced recommendations
        // (Removed Pass 3 fallback that could bypass caps and cause absurd quantities)
        
        // =====================================================================
        // CRITICALLY UNDERFUNDED DETECTION (Workflow Image 2)
        // Identify items that couldn't get their minimum required quantity
        // These items should be flagged for owner attention
        // =====================================================================
        for (const candidate of candidates) {
          const wanted = wantedQtyByProductId.get(candidate.product.id) || 0;
          const allocated = qtyByProductId.get(candidate.product.id) || 0;
          const isEssential = isEssentialProduct(candidate.product);
          
          // Minimum acceptable = at least 50% of wanted, or 1 unit for essential items
          const minAcceptable = isEssential ? Math.max(1, Math.ceil(wanted * 0.5)) : Math.ceil(wanted * 0.3);
          
          if (wanted > 0 && allocated < minAcceptable) {
            underfundedItems.push({
              product: candidate.product,
              wanted: wanted,
              allocated: allocated,
              shortfall: wanted - allocated,
              isEssential: isEssential,
              costToFund: (wanted - allocated) * candidate.product.costPrice
            });
          }
        }

        // Keep display order meaningful: urgency then score
        shoppingList.sort((a, b) => {
          const daysA = isFinite(a.prediction.daysUntilStockout) ? a.prediction.daysUntilStockout : Number.POSITIVE_INFINITY;
          const daysB = isFinite(b.prediction.daysUntilStockout) ? b.prediction.daysUntilStockout : Number.POSITIVE_INFINITY;
          if (daysA !== daysB) return daysA - daysB;
          return b.priorityScore - a.priorityScore;
        });

        const itemsSkipped = candidates.filter(c => (qtyByProductId.get(c.product.id) || 0) === 0).length;

        const totalCost = effectiveBudget - remainingBudget;
        const result = {
          totalCost,
          totalBudget: effectiveBudget,
          rawBudget: rawBudget,
          budgetBreakdown: budgetBreakdown,
          itemsSkipped,
          needCount,
          plannedItems: shoppingList.length,
          underfundedItems: underfundedItems,
          essentialItems: essentialItems,
          underfundedCount: underfundedItems.length,
          criticallyUnderfunded: underfundedItems.filter(u => u.isEssential).length
        };

        if (!render) return result;

        const listEl = document.getElementById('shoppingList');
        const summaryEl = document.getElementById('shoppingListSummary');

        if (shoppingList.length > 0) {
            // =====================================================================
            // ABC CLASSIFICATION (Pareto Analysis) — Demand/Stockout Opportunity
            // =====================================================================
            // ABC Analysis is an inventory categorization technique based on the
            // Pareto principle (80/20 rule). Items are ranked by their contribution
            // to total value, then classified into three categories.
            //
            // ADAPTATION FOR SARI-SARI STORE CONTEXT:
            // For store owners, the biggest opportunity cost is NOT always "highest margin".
            // It's often "what will run out and cause lost sales" (high demand, low stock).
            //
            // We therefore rank items by expected lost sales units over the protection period.
            //
            // FORMULA (Lost Sales Units over Protection Period):
            //   ProtectionDays = R + L
            //   LostUnits_i = max(0, d_i × (R + L) − stock_i)
            //   where:
            //     d_i      = daily demand rate for item i (units/day)
            //     R        = review period (days) — how often the store restocks
            //     L        = lead time (days) — delivery delay (often 0)
            //     stock_i  = current on-hand stock
            //
            // Interpretation: "How many units we might NOT be able to sell before next restock arrives."
            //
            // CLASSIFICATION RULE (cumulative contribution):
            //   A items: contribute to top ~70% of total LostUnits (restock first)
            //   B items: contribute to next ~20% of total LostUnits
            //   C items: contribute to last ~10% of total LostUnits
            //
            // Reference: Wild, T. (2017). Best Practice in Inventory Management (3rd ed.)
            // Reference: Vollmann, T.E. et al. (2005). Manufacturing Planning and Control
            // =====================================================================
            const reviewPeriod = Math.max(1, Number(settings.reviewPeriodDays) || 7);  // R = review period
            const leadDays = Math.max(0, Number(settings.leadTimeDays) || 0);          // L = lead time
            const protectionDays = reviewPeriod + leadDays;                             // R + L
            const impactByProductId = new Map();
            const impactValueByProductId = new Map();

            // Step 1: Calculate Lost Sales Units for each item
            // LostUnits_i = max(0, d_i × (R + L) − stock_i)
            const impactRows = shoppingList.map(item => {
              const dailyDemand = Math.max(0, Number(item?.prediction?.dailyRate) || 0);  // d_i
              const currentStock = Math.max(0, Number(item?.product?.stock) || 0);        // stock_i
              const expectedDemand = dailyDemand * protectionDays;                         // d_i × (R + L)
              const lostUnits = Math.max(0, expectedDemand - currentStock);
              return { item, lostUnits };
            });

            // Step 2: Calculate total LostUnits across all items
            const totalLostUnits = impactRows.reduce((sum, r) => sum + r.lostUnits, 0);

            // Step 3: Sort by LostUnits descending, compute cumulative %, assign A/B/C
            if (totalLostUnits > 0) {
              impactRows
                .sort((a, b) => b.lostUnits - a.lostUnits)  // Rank by LostUnits (highest first)
                .reduce((cumulativeLostUnits, row) => {
                  const nextCumulative = cumulativeLostUnits + row.lostUnits;
                  const cumulativePercent = nextCumulative / totalLostUnits;  // Cumulative % of total lost units

                  // Classification thresholds (standard Pareto cutoffs)
                  let category = 'C';  // Default: low-value items
                  if (cumulativePercent <= 0.70) category = 'A';       // Top 70% of value → A
                  else if (cumulativePercent <= 0.90) category = 'B';  // Next 20% of value → B
                  // Remaining 10% of value → C

                  impactByProductId.set(row.item.product.id, category);
                  impactValueByProductId.set(row.item.product.id, row.lostUnits);
                  return nextCumulative;
                }, 0);
            } else {
              // Fallback: if profit data is missing/zero, classify by rank within the current list.
              const rankedByImpact = [...shoppingList].sort((a, b) => b.priorityScore - a.priorityScore);
              const nImpact = rankedByImpact.length;
              const countA = Math.min(nImpact, Math.max(1, Math.ceil(nImpact * 0.2))); // Top 20%
              const countB = Math.min(nImpact - countA, Math.max(0, Math.ceil(nImpact * 0.3))); // Next 30%
              rankedByImpact.forEach((item, idx) => {
                let cat = 'C';
                if (idx < countA) cat = 'A';
                else if (idx < (countA + countB)) cat = 'B';
                impactByProductId.set(item.product.id, cat);
              });
            }

            function renderImpactBadge(cat) {
              if (cat === 'A') return '<span class="impact-badge impact-high">High impact (A)</span>';
              if (cat === 'B') return '<span class="impact-badge impact-med">Medium impact (B)</span>';
              return '<span class="impact-badge impact-low">Low impact (C)</span>';
            }

            // Calculate impact allocation
            const allocA = shoppingList.filter(i => impactByProductId.get(i.product.id) === 'A').reduce((sum, i) => sum + (i.finalOrderQty * i.unitCost), 0);
            const allocB = shoppingList.filter(i => impactByProductId.get(i.product.id) === 'B').reduce((sum, i) => sum + (i.finalOrderQty * i.unitCost), 0);
            const allocC = shoppingList.filter(i => impactByProductId.get(i.product.id) === 'C').reduce((sum, i) => sum + (i.finalOrderQty * i.unitCost), 0);
            const totalAlloc = allocA + allocB + allocC;
            const pctA = totalAlloc > 0 ? (allocA / totalAlloc * 100) : 0;
            const pctB = totalAlloc > 0 ? (allocB / totalAlloc * 100) : 0;
            const pctC = totalAlloc > 0 ? (allocC / totalAlloc * 100) : 0;

            const legendHTML = `
              <div class="shopping-legend">
                Sorted by priority: 🔴 High priority first, 🟡 Medium, 🟢 Low
              </div>
            `;

            // Clear, store-owner-friendly display
            listEl.innerHTML = legendHTML + shoppingList.map(item => {
              const impactBadge = renderImpactBadge(impactByProductId.get(item.product.id));
                const essentialBadge = isEssentialProduct(item.product) ? '<span class="impact-badge" style="background: #E6FFFA; color: #234E52; border-color: #81E6D9;">⭐ Essential</span>' : '';
                const demandBadge = getTrendArrow(item.product);
                const expiryBadge = item.product.expiryDate ? getExpiryBadge(getDaysUntilExpiry(item.product.expiryDate)) : '';
                const daysLeft = item.prediction.daysUntilStockout;

                const reviewDays = Math.max(1, Number(settings.reviewPeriodDays) || 7);
                const leadDays = Math.max(0, Number(settings.leadTimeDays) || 0);

                let urgencyClass = 'urgency-low';
                if (isFinite(daysLeft) && daysLeft <= 3) urgencyClass = 'urgency-high';
                else if (isFinite(daysLeft) && daysLeft <= 7) urgencyClass = 'urgency-med';

                let restockLabel = 'Check stock';
                let restockDetail = `Stock: ${item.product.stock}`;
                if (isFinite(daysLeft)) {
                  if (item.product.stock === 0) {
                    restockLabel = 'Out of stock';
                    restockDetail = 'Restock immediately';
                  } else if (daysLeft <= 1) {
                    restockLabel = 'Urgent';
                    restockDetail = `${item.product.stock} pcs left`;
                  } else if (daysLeft <= 3) {
                    restockLabel = 'Restock soon';
                    restockDetail = `~${daysLeft} days left`;
                  } else if (daysLeft <= reviewDays) {
                    restockLabel = 'Add to list';
                    restockDetail = `~${daysLeft} days left`;
                  } else {
                    restockLabel = 'Monitor';
                    restockDetail = `~${daysLeft} days left`;
                  }
                }

                const thumbSrc = getProductThumbSrc(item.product);

                return `
                  <div class="shopping-list-item ${urgencyClass}" data-product-id="${item.product.id}">
                    <div class="shopping-item-top">
                      <div class="shopping-item-left">
                        <img class="item-thumb" src="${thumbSrc}" alt="${item.product.name}">
                        <div style="min-width:0;">
                          <div class="shopping-item-title">${item.product.name}</div>
                          <div class="shopping-item-sub">${restockDetail}</div>
                        </div>
                      </div>
                      <div class="shopping-item-tags">${essentialBadge}${impactBadge}${demandBadge}</div>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                      <div class="restock-pill"><i class="ti ti-shopping-cart"></i> ${restockLabel}</div>
                      <div class="shopping-qtybox" style="display: flex; align-items: center; gap: 4px;">
                        <button type="button" onclick="adjustShoppingQty(${item.product.id}, -1)" style="width: 24px; height: 24px; border: none; background: var(--bg); border-radius: 4px; cursor: pointer; font-weight: bold; color: var(--text-secondary);">−</button>
                        <input type="number" id="shopQty-${item.product.id}" value="${item.finalOrderQty}" min="0" max="999" 
                          style="width: 45px; text-align: center; border: 1px solid var(--chip-border); border-radius: 4px; padding: 4px; font-weight: 600; font-size: 0.85em;"
                          onchange="updateShoppingItemTotal(${item.product.id}, ${item.unitCost})">
                        <button type="button" onclick="adjustShoppingQty(${item.product.id}, 1)" style="width: 24px; height: 24px; border: none; background: var(--bg); border-radius: 4px; cursor: pointer; font-weight: bold; color: var(--text-secondary);">+</button>
                        <span class="label" style="margin-left: 2px;">pcs</span>
                      </div>
                      <div class="shopping-price">
                        <div class="total" id="shopTotal-${item.product.id}">${formatPHP.format(item.finalOrderQty * item.unitCost)}</div>
                      </div>
                      <button class="btn-secondary" onclick="addShoppingItemToInventory(${item.product.id})" style="padding: 6px 10px; font-size: 0.7em; white-space: nowrap;">
                        <i class="ti ti-plus"></i> Add
                      </button>
                    </div>
                  </div>
                `;
            }).join('');

            // Show the add to inventory button
            document.getElementById('shoppingListActions').style.display = 'block';

            const budgetUtil = effectiveBudget > 0 ? ((totalCost / effectiveBudget) * 100).toFixed(1) : 0;
            
            // Budget Breakdown Display (showing cash source and withdrawal deductions)
            let budgetSourceHTML = '';
            if (budgetBreakdown.usingActualCash) {
              budgetSourceHTML = `
                <div class="budget-source-notice" style="background: #E6F4EA; border-left: 3px solid #28a745; padding: 8px 10px; margin-bottom: 10px; border-radius: 4px; font-size: 0.75em;">
                  <div style="font-weight: 600; color: #155724; margin-bottom: 2px;"><i class="ti ti-wallet"></i> Using actual Cash on Hand</div>
                  <div style="color: #1e7e34;">Cash: ₱${budgetBreakdown.cashOnHand.toFixed(0)} (capped at ₱${budgetBreakdown.maxBudgetCap.toFixed(0)})</div>
                </div>
              `;
            } else {
              budgetSourceHTML = `
                <div class="budget-source-notice" style="background: #FFF3CD; border-left: 3px solid #ffc107; padding: 8px 10px; margin-bottom: 10px; border-radius: 4px; font-size: 0.75em;">
                  <div style="font-weight: 600; color: #856404;"><i class="ti ti-info-circle"></i> Using max budget (no cash entered)</div>
                  <div style="color: #856404; font-size: 0.9em;">Enter your Cash on Hand in Settings for accurate budget.</div>
                </div>
              `;
            }
            
            const budgetDeductionHTML = budgetBreakdown.totalDeductions > 0 ? `
              <div class="budget-deduction-notice" style="background: rgba(255,255,255,0.9); border-left: 3px solid #718096; padding: 8px 10px; margin-bottom: 10px; border-radius: 4px; font-size: 0.75em; box-shadow: 2px 2px 4px rgba(174,174,192,0.2), -2px -2px 4px rgba(255,255,255,0.8);">
                <div style="font-weight: 600; color: #4A5568; margin-bottom: 4px;"><i class="ti ti-home-dollar"></i> Budget adjusted for withdrawals</div>
                <div style="color: #718096;">Base: ₱${budgetBreakdown.rawBudget.toFixed(0)} − Withdrawals: ₱${budgetBreakdown.totalDeductions.toFixed(0)} = <strong>Effective: ₱${budgetBreakdown.effectiveBudget.toFixed(0)}</strong></div>
              </div>
            ` : '';
            
            // Critically Underfunded Warning (Workflow Image 2)
            const underfundedWarningHTML = underfundedItems.length > 0 ? `
              <div class="underfunded-warning" style="background: rgba(255,255,255,0.85); border-left: 3px solid #4A5568; padding: 8px 10px; margin-bottom: 10px; border-radius: 4px; font-size: 0.75em; box-shadow: 2px 2px 4px rgba(174,174,192,0.2), -2px -2px 4px rgba(255,255,255,0.8);">
                <div style="font-weight: 600; color: #4A5568; margin-bottom: 4px;"><i class="ti ti-alert-triangle"></i> ${underfundedItems.length} item${underfundedItems.length > 1 ? 's' : ''} critically underfunded</div>
                <div style="color: #718096;">
                  ${underfundedItems.slice(0, 3).map(u => `${u.product.name}: got ${u.allocated}/${u.wanted} pcs${u.isEssential ? ' ⭐' : ''}`).join('<br>')}
                  ${underfundedItems.length > 3 ? `<br><span style="color: #4A5568;">+${underfundedItems.length - 3} more...</span>` : ''}
                </div>
                <div style="margin-top: 6px; color: #4A5568;"><strong>Tip:</strong> Increase budget by ₱${underfundedItems.reduce((s, u) => s + u.costToFund, 0).toFixed(0)} to fully fund these items.</div>
              </div>
            ` : '';
            
            // Capital Allocation (plain-language DSS)
            const capitalAllocationHTML = `
              <div class="capital-allocation">
                <div class="capital-allocation-title">Budget allocation by priority</div>
                <div class="capital-allocation-bar" aria-label="Budget distribution">
                  <div class="capital-bar-a" style="width: ${pctA}%;" title="High: ${formatPHP.format(allocA)}"></div>
                  <div class="capital-bar-b" style="width: ${pctB}%;" title="Medium: ${formatPHP.format(allocB)}"></div>
                  <div class="capital-bar-c" style="width: ${pctC}%;" title="Low: ${formatPHP.format(allocC)}"></div>
                </div>
                <div class="capital-allocation-legend">
                  <div class="capital-legend-item">
                    <div class="capital-legend-dot" style="background: #4A5568;"></div>
                    <span>High: ₱${allocA.toFixed(0)}</span>
                  </div>
                  <div class="capital-legend-item">
                    <div class="capital-legend-dot" style="background: #718096;"></div>
                    <span>Med: ₱${allocB.toFixed(0)}</span>
                  </div>
                  <div class="capital-legend-item">
                    <div class="capital-legend-dot" style="background: #A0AEC0;"></div>
                    <span>Low: ₱${allocC.toFixed(0)}</span>
                  </div>
                </div>
              </div>
            `;

            summaryEl.innerHTML =
            budgetSourceHTML +
            budgetDeductionHTML +
            underfundedWarningHTML +
            `<strong>Total:</strong> ${formatPHP.format(totalCost)} / ${formatPHP.format(effectiveBudget)} (${budgetUtil}%)` +
            (itemsSkipped > 0 ? `<br><span style="color: var(--muted);">${itemsSkipped} items skipped (budget)</span>` : '') +
            capitalAllocationHTML;
        } else {
          // Hide add to inventory button when no items
          const actionsEl = document.getElementById('shoppingListActions');
          if (actionsEl) actionsEl.style.display = 'none';
          // If nothing is recommended, clear session suppression
          if (recentlyRestockedIds.size > 0) recentlyRestockedIds.clear();
            
          if (needCount > 0) {
                listEl.innerHTML = `There are restock needs, but your budget prevented adding any items.`;
                summaryEl.innerHTML =
                    `<strong>Budget:</strong> ${formatPHP.format(settings.shoppingBudget || 0)}<br>` +
                    `<strong>Tip:</strong> Increase budget in settings.`;
            } else {
                listEl.textContent = 'Stock levels are optimal. Nothing to buy yet!';
                summaryEl.innerHTML = '';
            }
        }

            return result;
    }


    function generateInsights() {
      generateShoppingList();
      const topSelling = [...inventory].filter(p => p.totalSold > 0).sort((a,b) => b.totalSold - a.totalSold).slice(0,3);
      if (topSelling.length > 0) {
        document.getElementById('topSelling').innerHTML = topSelling.map((p,i) => {
          const avgDaily = getProductPrediction(p).dailyRate;
          const totalProfit = p.totalSold * (p.sellingPrice - p.costPrice);
          return `${i+1}. ${p.name} - ${p.totalSold} sold (${formatPHP.format(totalProfit)} profit, ~${avgDaily.toFixed(1)}/day)`;
        }).join('<br>');
      } else {
        document.getElementById('topSelling').textContent = 'No sales data yet. Start selling to see insights!';
      }

      const profitable = [...inventory]
        .filter(p => p.totalSold > 0)
        .map(p => ({ name: p.name, profitMargin: (p.costPrice > 0) ? ((p.sellingPrice - p.costPrice)/p.costPrice*100) : 0, totalProfit: p.totalSold * (p.sellingPrice - p.costPrice) }))
        .sort((a,b) => b.totalProfit - a.totalProfit)
        .slice(0,3);
      if (profitable.length > 0) {
        document.getElementById('profitAnalysis').innerHTML = profitable.map(p => `${p.name}: ${p.profitMargin.toFixed(1)}% margin, ${formatPHP.format(p.totalProfit)} total profit`).join('<br>');
      } else {
        document.getElementById('profitAnalysis').textContent = 'Track your sales to see profit margins.';
      }

      const slow = inventory.filter(p => {
        if (!p.lastSold && p.dateAdded) return Math.floor((new Date() - new Date(p.dateAdded))/(1000*60*60*24)) > 7;
        if (p.lastSold) return Math.floor((new Date() - new Date(p.lastSold))/(1000*60*60*24)) > 7;
        return false;
      });
      if (slow.length > 0) {
        document.getElementById('slowMoving').innerHTML = slow.map(p => `${p.name} - ${p.stock} in stock (Consider promotions or discontinuing)`).join('<br>');
      } else {
        document.getElementById('slowMoving').textContent = 'All items are moving well!';
      }

      generateAIRecommendations();
    }

    function generateAIRecommendations() {
      const recs = [];
      const now = new Date(); const day = now.getDay(); const hour = now.getHours();
      if (day === 5 || day === 6) recs.push('Weekend: Stock up on snacks and beverages');
      if (day === 1) recs.push('Monday: Coffee and energy drinks sell well');
      if (hour >= 6 && hour < 10) recs.push('Morning: Promote coffee and breakfast items');
      else if (hour >= 15 && hour < 18) recs.push('Afternoon: Cold drinks and snacks peak time');
      inventory.forEach(p => {
        const rate = getProductPrediction(p).dailyRate;
        const margin = (p.costPrice > 0) ? ((p.sellingPrice - p.costPrice)/p.costPrice*100) : 0;
        if (margin > 50 && rate < 2) recs.push(`Promote ${p.name} - high margin but low sales`);
        if (rate > 10) recs.push(`${p.name} is a bestseller - ensure stock!`);
      });
      const date = now.getDate();
      if (date === 14 || date === 29) recs.push('Payday tomorrow! Stock up on premium items');
      document.getElementById('aiRecommendations').innerHTML = recs.length ? recs.slice(0,4).join('<br>') : 'Smart suggestions will appear as you track more sales.';
    }

    // Add product / quick add
    function addProduct() {
      const category = document.getElementById('productCategory').value;
      const name = document.getElementById('productName').value.trim();
      const cost = parseFloat(document.getElementById('costPrice').value);
      const selling = parseFloat(document.getElementById('sellingPrice').value);
      const stock = parseInt(document.getElementById('initialStock').value);
      const expiryDate = document.getElementById('expiryDate').value || null;
      if (!name || isNaN(cost) || isNaN(selling) || isNaN(stock)) { alert('Please fill all fields with valid numbers!'); return; }
      const product = { id: Date.now(), category, name, costPrice: cost, sellingPrice: selling, stock, initialStock: stock, totalSold: 0, lastSold: null, dateAdded: new Date().toISOString(), expiryDate: expiryDate };
      inventory.push(product);
      logActivity('add', `Added '${name}' to inventory with ${stock} stock.`, { name, stock });
      saveData(); loadInventory(); updateStats(); generateIntelligentAlerts(); generateExpiryAlerts(); updateMarkdownAnalyzer();
      document.getElementById('productName').value=''; document.getElementById('costPrice').value=''; document.getElementById('sellingPrice').value=''; document.getElementById('initialStock').value=''; document.getElementById('expiryDate').value='';
      document.querySelector('.tab').click();
    }
    
    // --- REVISED QUICK ADD & CATEGORY TOGGLE ---
    function toggleCategory(categoryName) {
        const itemsDiv = document.getElementById(`cat-${categoryName}`);
        if (itemsDiv) {
            // Using 'grid' as the display value to match its original state
            const isVisible = itemsDiv.style.display === 'grid';
            itemsDiv.style.display = isVisible ? 'none' : 'grid';
        }
    }

    function quickAddCat(name, cost, selling, category) {
        // Pre-fill the main form
        document.getElementById('productCategory').value = category;
        document.getElementById('productName').value = name;
        document.getElementById('costPrice').value = cost;
        document.getElementById('sellingPrice').value = selling;
        
        const stockInput = document.getElementById('initialStock');
        stockInput.value = ''; // Clear the stock
        stockInput.focus(); // Focus for user input
        
        // Scroll to the form for better visibility
        document.querySelector('.add-product-form').scrollIntoView({ behavior: 'smooth' });
        showFeedback(`Pre-filled form for ${name}. Enter stock and add.`);
    }

    // Settings persistence
    function updateSettings() { 
        document.getElementById('settingsTotalProducts').textContent = inventory.length; 
        checkDataStartDate();
        loadPredictionSettings();
    }
    function checkDataStartDate() {
      const firstDate = localStorage.getItem('tindatech_start_date');
      if (!firstDate) localStorage.setItem('tindatech_start_date', new Date().toISOString());
      const startDate = new Date(localStorage.getItem('tindatech_start_date'));
      document.getElementById('dataStartDate').textContent = startDate.toLocaleDateString(navigator.language || 'en-US');
    }
    function loadPredictionSettings() {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
        const setChecked = (id, val) => { const el = document.getElementById(id); if(el) el.checked = val; };
        setVal('reviewPeriodDays', settings.reviewPeriodDays);
        setVal('safetyStockDays', settings.safetyStockDays);
        setVal('leadTimeDays', settings.leadTimeDays);
        setVal('shoppingBudget', settings.shoppingBudget);
        setVal('storageCapacity', settings.storageCapacity);
        setVal('forecastingMethod', settings.forecastingMethod || 'auto');
        setVal('plannedWithdrawal', settings.plannedWithdrawal || 0);
        setVal('cashOnHand', settings.cashOnHand || 0);
        setChecked('deductWithdrawalsFromBudget', settings.deductWithdrawalsFromBudget !== false);
        
        // Show last cash update info
        const infoEl = document.getElementById('cashUpdateInfo');
        if (infoEl && settings.lastCashUpdate) {
          const lastUpdate = new Date(settings.lastCashUpdate);
          const daysSince = Math.floor((new Date() - lastUpdate) / (1000*60*60*24));
          if (daysSince === 0) {
            infoEl.innerHTML = '<i class="ti ti-check"></i> Updated today';
            infoEl.style.color = '#28a745';
          } else if (daysSince <= 7) {
            infoEl.innerHTML = `<i class="ti ti-clock"></i> Updated ${daysSince} day${daysSince > 1 ? 's' : ''} ago`;
            infoEl.style.color = 'var(--muted)';
          } else {
            infoEl.innerHTML = `<i class="ti ti-alert-triangle"></i> Last updated ${daysSince} days ago - please update`;
            infoEl.style.color = '#dc3545';
          }
        } else if (infoEl) {
          infoEl.innerHTML = '<i class="ti ti-info-circle"></i> Enter your current cash to enable accurate budget tracking';
          infoEl.style.color = 'var(--muted)';
        }
    }
    function savePredictionSettings() {
        const review = parseInt(document.getElementById('reviewPeriodDays').value);
        const safety = parseInt(document.getElementById('safetyStockDays').value);
        const lead = parseInt(document.getElementById('leadTimeDays').value);
        const budget = parseFloat(document.getElementById('shoppingBudget').value);
        const capacity = parseInt(document.getElementById('storageCapacity').value) || 500;
        const forecastingMethod = document.getElementById('forecastingMethod').value || 'auto';
        const plannedWithdrawal = parseFloat(document.getElementById('plannedWithdrawal').value) || 0;
        const deductWithdrawalsFromBudget = document.getElementById('deductWithdrawalsFromBudget').checked;
        const cashOnHand = parseFloat(document.getElementById('cashOnHand').value) || 0;

        if (isNaN(review) || isNaN(safety) || isNaN(lead) || isNaN(budget) || review < 1 || safety < 0 || lead < 0 || budget < 0) {
            alert('Please enter valid, positive numbers for all settings.');
            return;
        }
        settings.reviewPeriodDays = review;
        settings.safetyStockDays = safety;
        settings.leadTimeDays = lead;
        settings.shoppingBudget = budget;
        settings.storageCapacity = capacity;
        settings.forecastingMethod = forecastingMethod;
        settings.plannedWithdrawal = plannedWithdrawal;
        settings.deductWithdrawalsFromBudget = deductWithdrawalsFromBudget;
        
        // Track if cash on hand changed
        if (cashOnHand !== settings.cashOnHand) {
          settings.lastCashUpdate = new Date().toISOString();
        }
        settings.cashOnHand = cashOnHand;
        
        saveData();
        showFeedback('Settings saved!');
        // regenerate alerts and insights with new settings
        generateIntelligentAlerts();
        generateExpiryAlerts();
        generateInsights();
        updateMarkdownAnalyzer();
        updateDashboard();
        loadPredictionSettings(); // Refresh cash update info display
    }

    // Persistence
    function saveData() {
      localStorage.setItem('tindatech_inventory', JSON.stringify(inventory));
      localStorage.setItem('tindatech_sales', JSON.stringify(salesHistory));
      localStorage.setItem('tindatech_transactions', JSON.stringify(transactions));
      localStorage.setItem('tindatech_credit', JSON.stringify(creditAccounts));
      localStorage.setItem('tindatech_activityLog', JSON.stringify(activityLog));
      localStorage.setItem('tindatech_settings', JSON.stringify(settings));
      localStorage.setItem('tindatech_withdrawals', JSON.stringify(personalWithdrawals));
      localStorage.setItem('tindatech_opportunity_losses', JSON.stringify(opportunityLosses));
    }

    // Export / Clear
    function exportData() {
      const data = { inventory, salesHistory, transactions, creditAccounts, activityLog, settings, personalWithdrawals, opportunityLosses, exportDate: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `tindatech_backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
    }
    function clearAllData() {
      if (confirm('Are you sure? This will delete all your data!')) {
        if (confirm('This action cannot be undone. Continue?')) {
          localStorage.clear(); // Clears everything for this domain
          inventory = []; salesHistory = []; transactions = []; creditAccounts = []; activityLog = []; personalWithdrawals = []; opportunityLosses = [];
          settings = { 
              reviewPeriodDays: 7, safetyStockDays: 3, leadTimeDays: 1, 
              shoppingBudget: 5000, storageCapacity: 500, forecastingMethod: 'exponential'
          };
          location.reload();
        }
      }
    }
    
    // Alias for settings button
    function confirmClearData() {
        clearAllData();
    }

    // =====================================================================
    // SHOPPING LIST - Editable Quantities & Add to Inventory
    // =====================================================================
    
    // Adjust shopping list quantity with +/- buttons
    function adjustShoppingQty(productId, delta) {
      const input = document.getElementById(`shopQty-${productId}`);
      if (!input) return;
      const currentVal = parseInt(input.value) || 0;
      const newVal = Math.max(0, Math.min(999, currentVal + delta));
      input.value = newVal;
      
      // Find the unit cost from the product
      const product = inventory.find(p => p.id === productId);
      if (product) {
        updateShoppingItemTotal(productId, product.costPrice);
      }
    }
    
    // Update the total price display when quantity changes
    function updateShoppingItemTotal(productId, unitCost) {
      const input = document.getElementById(`shopQty-${productId}`);
      const totalEl = document.getElementById(`shopTotal-${productId}`);
      if (!input || !totalEl) return;
      
      const qty = parseInt(input.value) || 0;
      totalEl.textContent = formatPHP.format(qty * unitCost);
    }
    
    // Add one item from shopping list to inventory
    function addShoppingItemToInventory(productId) {
      const qtyInput = document.getElementById(`shopQty-${productId}`);
      if (!qtyInput) return;
      const qtyToAdd = parseInt(qtyInput.value) || 0;
      if (qtyToAdd <= 0) {
        showFeedback('Quantity is zero. Adjust quantity first.');
        return;
      }

      const product = inventory.find(p => p.id === productId);
      if (!product) return;

      product.stock += qtyToAdd;
      recentlyRestockedIds.add(productId);
      saveData();
      showFeedback(`Added ${qtyToAdd} pcs to ${product.name}`);

      // Refresh UI and recommendations immediately
      loadInventory();
      updateDashboard();
      generateShoppingList();
      updateLowStockAlerts();
    }

    // Add all items from shopping list to inventory
    function addShoppingListToInventory() {
      const shoppingItems = document.querySelectorAll('.shopping-list-item[data-product-id]');
      if (shoppingItems.length === 0) {
        showFeedback('No items in shopping list');
        return;
      }
      
      let addedCount = 0;
      let totalAdded = 0;
      
      shoppingItems.forEach(item => {
        const productId = parseInt(item.dataset.productId);
        const qtyInput = document.getElementById(`shopQty-${productId}`);
        if (!qtyInput) return;
        
        const qtyToAdd = parseInt(qtyInput.value) || 0;
        if (qtyToAdd <= 0) return;
        
        const product = inventory.find(p => p.id === productId);
        if (product) {
          product.stock += qtyToAdd;
          recentlyRestockedIds.add(productId);
          addedCount++;
          totalAdded += qtyToAdd;
        }
      });
      
      if (addedCount > 0) {
        saveData();
        showFeedback(`Added ${totalAdded} pcs to ${addedCount} item${addedCount > 1 ? 's' : ''}`);

        // Refresh all UI components immediately so recommendations update
        loadInventory();
        updateDashboard();
        generateShoppingList();
        updateLowStockAlerts();
      } else {
        showFeedback('No quantities to add. Adjust quantities first.');
      }
    }

    // Feedback toast
    function showFeedback(message) {
      const feedback = document.createElement('div');
      feedback.style.cssText = `
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(255,255,255,0.95); color: #4A5568; padding: 15px 20px; border-radius: 10px;
        box-shadow: 4px 4px 8px rgba(174,174,192,0.4), -4px -4px 8px rgba(255,255,255,0.9); z-index: 1200; animation: slideUp 0.3s ease, fadeOut 0.3s ease 2s;
        border: 1px solid rgba(209,217,230,0.5);
      `;
      feedback.textContent = message;
      document.body.appendChild(feedback);
      setTimeout(() => feedback.remove(), 2300);
    }

    // Shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.key === '/' && document.activeElement.tagName !== 'INPUT') { e.preventDefault(); document.getElementById('productSearch').focus(); }
      if (e.key === 'Escape') {
        if (manageModeActive) toggleManageMode();
        if(document.getElementById('editProductModal').classList.contains('show')) closeEditModal();
        if(isTransactionActive()) cancelTransaction();
        
        document.getElementById('productSearch').value = '';
        currentSearchTerm = ''; currentCategoryFilter = 'all';
        document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
        document.querySelector('.filter-chip').classList.add('active');
        loadInventory();
      }
    });

    // PWA install
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); deferredPrompt = e;
      setTimeout(() => { document.getElementById('installPrompt').classList.add('show'); }, 30000);
    });
    function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
          deferredPrompt = null; document.getElementById('installPrompt').classList.remove('show');
        });
      }
    }

    // Service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
          .then(() => console.log('ServiceWorker registration successful'))
          .catch(err => console.log('ServiceWorker registration failed: ', err));
      });
    }
  </script>

  <!-- Personal Withdrawal Modal -->
  <div id="withdrawalModal" class="modal-overlay" onclick="closeWithdrawalModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-title"><i class="ti ti-home"></i> Log Personal Withdrawal</div>
      <div class="form-group">
        <label class="form-label">Select Product</label>
        <select id="withdrawalProduct" class="form-input">
          <option value="">-- Select Product --</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Quantity</label>
        <input type="number" id="withdrawalQty" class="form-input" placeholder="1" min="1" value="1">
      </div>
      <div class="form-group">
        <label class="form-label">Purpose</label>
        <select id="withdrawalPurpose" class="form-input">
          <option value="personal">Personal Use</option>
          <option value="damaged">Damaged</option>
          <option value="expired">Expired</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Notes (Optional)</label>
        <input type="text" id="withdrawalNotes" class="form-input" placeholder="e.g., For family dinner">
      </div>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn-secondary" onclick="closeWithdrawalModal()" style="flex: 1;">Cancel</button>
        <button class="btn-primary" onclick="saveWithdrawal()" style="flex: 1;"><i class="ti ti-check"></i> Save</button>
      </div>
    </div>
  </div>

  <!-- Lost Sale (Opportunity Loss) Modal -->
  <div id="lostSaleModal" class="modal-overlay" onclick="closeLostSaleModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-title"><i class="ti ti-mood-sad"></i> Log Lost Sale (Stockout)</div>
      <p style="font-size: 0.85em; color: #6b7280; margin-bottom: 15px;">Record when a customer wanted a product that was out of stock.</p>
      <div class="form-group">
        <label class="form-label">Product Name</label>
        <input type="text" id="lostSaleProduct" class="form-input" placeholder="e.g., Coke 1.5L" list="productSuggestions">
        <datalist id="productSuggestions"></datalist>
      </div>
      <div class="form-group">
        <label class="form-label">Quantity Requested</label>
        <input type="number" id="lostSaleQty" class="form-input" placeholder="1" min="1" value="1">
      </div>
      <div class="form-group">
        <label class="form-label">Estimated Selling Price (₱)</label>
        <input type="number" id="lostSalePrice" class="form-input" placeholder="20" step="0.50">
      </div>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn-secondary" onclick="closeLostSaleModal()" style="flex: 1;">Cancel</button>
        <button class="btn-warning" onclick="saveLostSale()" style="flex: 1;"><i class="ti ti-check"></i> Log Lost Sale</button>
      </div>
    </div>
  </div>

  <!-- Floating Action Button (FAB) - 2015 Material Design Hallmark -->
  <!-- Fitts's Law: Large target in thumb-accessible zone for primary action -->
  <button class="fab" id="fabButton" data-tooltip="New Sale" onclick="handleFabClick()" aria-label="Start new sale">
    <i class="ti ti-plus"></i>
  </button>

  <script src="tindatech_phase1_complete.js"></script>
  
  <script>
    // FAB (Floating Action Button) behavior
    function handleFabClick() {
      const activeTab = document.querySelector('.tab-content.active');
      const activeTabId = activeTab ? activeTab.id : 'inventory';
      
      switch(activeTabId) {
        case 'inventory':
          // Start a new sale transaction
          if (typeof startTransaction === 'function') {
            startTransaction();
          }
          break;
        case 'add':
          // Focus on product name input
          const productNameInput = document.getElementById('productName');
          if (productNameInput) {
            productNameInput.focus();
          }
          break;
        case 'credit':
          // Open add credit modal if exists
          if (typeof openAddCreditModal === 'function') {
            openAddCreditModal();
          }
          break;
        default:
          // Default: go to add tab
          const addTab = document.querySelector('.tab[onclick*="add"]');
          if (addTab) {
            addTab.click();
          }
      }
    }
    
    // Update FAB icon based on active tab
    function updateFabForTab(tabId) {
      const fab = document.getElementById('fabButton');
      if (!fab) return;
      
      const iconEl = fab.querySelector('i');
      switch(tabId) {
        case 'inventory':
          iconEl.className = 'ti ti-shopping-cart';
          fab.setAttribute('data-tooltip', 'New Sale');
          fab.classList.remove('hidden');
          break;
        case 'add':
          iconEl.className = 'ti ti-plus';
          fab.setAttribute('data-tooltip', 'Add Product');
          fab.classList.remove('hidden');
          break;
        case 'credit':
          iconEl.className = 'ti ti-notebook';
          fab.setAttribute('data-tooltip', 'Add Credit');
          fab.classList.remove('hidden');
          break;
        case 'insights':
        case 'history':
        case 'settings':
        case 'tools':
          fab.classList.add('hidden');
          break;
        default:
          iconEl.className = 'ti ti-plus';
          fab.setAttribute('data-tooltip', 'Quick Action');
          fab.classList.remove('hidden');
      }
    }
    
    // Hook into tab switching
    const originalSwitchTab = window.switchTab;
    if (typeof originalSwitchTab === 'function') {
      window.switchTab = function(event, tabId) {
        originalSwitchTab(event, tabId);
        updateFabForTab(tabId);
      };
    }
    
    // Initialize FAB state
    document.addEventListener('DOMContentLoaded', function() {
      updateFabForTab('inventory');
    });
  </script>
</body>

</html>